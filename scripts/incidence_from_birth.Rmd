---
title: "incidence_from_birth"
author: "Bagi Laura"
date: "2024-01-19"
output: html_document
---

#Libraries
```{r}
library(ggpubr)
library(fastmatch)
library(readxl)
library(forcats)
library(survival)
library(survminer)
library(grid)
library(gridExtra)
library(data.table)
library(caret)
library(tidyverse)
library(future.apply)
library(magrittr)
library(gridExtra)
o√≠ptions(dplyr.summarise.inform = F)
```

#Files
```{r}
load("C:/Users/bagil/Desktop/MyGit/ukb_tumor/objects/ukb_data_cancer_final")
load("C:/Users/bagil/Desktop/MyGit/ukb_tumor/objects/icd_mapping")

```

#Kaplen-Mayer
```{r}
plotlist_2 = lapply(X = unique(icd_mapping$cancer_type), FUN = function(x){
  tempdf_x = subset(ukb_data_cancer, cancer_type == x)
  tempdf_x = dplyr::arrange(tempdf_x, diag_date)
  tempdf_no_x = subset(ukb_data_cancer, !(eid %in% tempdf_x$eid))
  tempdf_no_x = tempdf_no_x[!duplicated(tempdf_no_x$eid), ]
  tempdf_x = tempdf_x[!duplicated(tempdf_x$eid), ]
  unique_tempdf = rbind(tempdf_x, tempdf_no_x)
  unique_tempdf$time_in_days = as.numeric(ifelse(!is.na(unique_tempdf$diag_date), unique_tempdf$diag_date - unique_tempdf$birthdate, max(unique_tempdf$date_of_death, na.rm = T) - unique_tempdf$birthdate))
  unique_tempdf$cancer_type[is.na(unique_tempdf$cancer_type)] = "No cancer"
  unique_tempdf$event_indicator = ifelse(unique_tempdf$cancer_type == x, 1, 0)
  surv_obj = with(unique_tempdf, Surv(time_in_days, event = event_indicator))
  surv_model = survfit(surv_obj ~ 1, data = unique_tempdf)
  figure = ggsurvplot(surv_model, data = unique_tempdf, title = paste0("Incidence Analysis for ", x, "\n(N=", nrow(tempdf_x), ")"))$plot
  figure = figure + ylim(1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05, 1)
  figure
  })
ggarrange(plotlist =  plotlist_2, ncol = 5, nrow = 5, common.legend = T)
ggsave(filename = "C:/Users/bagil/Desktop/ukb/plots/Survival/cancersurvival_issue_2.jpg", width = 80, height = 40, units = "cm", dpi = 300)

#With table

c_list = lapply(X = unique(icd_mapping$cancer_type), FUN = function(x){
  tempdf_x = subset(ukb_data_cancer, cancer_type == x)
  tempdf_x = arrange(tempdf_x, diag_date)
  tempdf_no_x = subset(ukb_data_cancer, !(eid %in% tempdf_x$eid))
  tempdf_no_x = tempdf_no_x[!duplicated(tempdf_no_x$eid), ]
  tempdf_x = tempdf_x[!duplicated(tempdf_x$eid), ]
  unique_tempdf = rbind(tempdf_x, tempdf_no_x)
  unique_tempdf$time_in_days = as.numeric(ifelse(!is.na(unique_tempdf$diag_date), unique_tempdf$diag_date - unique_tempdf$birthdate, max(unique_tempdf$date_of_death, na.rm = T) - unique_tempdf$birthdate))
  #unique_tempdf$cause_of_death_clean = substr(unique_tempdf$cause_of_death, 1, 3)
  #unique_tempdf$p_cause_of_death = icd_mapping$cancer_type[match(unique_tempdf$cause_of_death_clean, icd_mapping$ICD10)]
  #unique_tempdf$p_cause_of_death[is.na(unique_tempdf$p_cause_of_death)]="Not cancer"
  unique_tempdf$cancer_type[is.na(unique_tempdf$cancer_type)] = "No cancer"
  unique_tempdf$event_indicator = ifelse(unique_tempdf$cancer_type == x, 1, 0)
  surv_obj = with(unique_tempdf, Surv(time_in_days, event = event_indicator))
  surv_model = survfit(surv_obj ~ 1)
  figure=ggsurvplot(surv_model, data = unique_tempdf, title = paste0("Incidence Analysis for ", x, "\n(N=", nrow(tempdf_x), ")"), risk.table = T)
  figure$plot + ylim(1-(nrow(tempdf_x)/nrow(unique_tempdf))- (nrow(tempdf_x)/nrow(unique_tempdf))*0.05, 1)
  figure
  })
ggarrange(plotlist = c_list, ncol = 5, nrow = 5)
ggsave(filename = "C:/Users/bagil/Desktop/ukb/plots/Survival/cancer_issue2_table.jpg", width = 60, height = 30, units = "cm", dpi = 300)


```

#PTV burden group 5%
```{r}

#Surv plot
plotlist_PTV1 = lapply(X = unique(icd_mapping$cancer_type), FUN = function(x){
  tempdf_x = subset(ukb_data_cancer, cancer_type == x)
  tempdf_x = dplyr::arrange(tempdf_x, diag_date)
  tempdf_no_x = subset(ukb_data_cancer, cancer_type == "No_cancer")
  tempdf_no_x = tempdf_no_x[!duplicated(tempdf_no_x$eid), ]
  tempdf_x = tempdf_x[!duplicated(tempdf_x$eid), ]
  unique_tempdf = rbind(tempdf_x, tempdf_no_x)
  unique_tempdf %<>% 
    mutate(time_in_days = case_when(
      cancer_type == x ~ diag_date - birthdate,
      death == T & is.na(diag_date) ~ date_of_death - birthdate,
      death == F & is.na(diag_date) ~ max(date_of_death, na.rm = T) - birthdate,
    ))
  unique_tempdf$event_indicator = ifelse(unique_tempdf$cancer_type == x, 1, 0)
  unique_tempdf$PTV_burden_group_5per = factor(unique_tempdf$PTV_burden_group_5per, ordered = T)
  fit = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_burden_group_5per, data = unique_tempdf))
  args = list(fit = fit, title = paste0("Incidence Analysis for ", x, "\n(N=", nrow(tempdf_x), ")"), ylim = c(1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05, 1), pval = T, pval.coord = c(1, 1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05),legend = "none")
  pfit = do.call(ggsurvplot, args)
  tblA = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_burden_group_5per, data = unique_tempdf), risk.table = T, tables.theme = clean_theme())$table
  grid.arrange(pfit$plot, tblA, layout_matrix = rbind(c(1, 1), c(1,1), c(2, 2)))
})

ggarrange(plotlist =  plotlist_PTV1, ncol = 5, nrow = 5)

ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Incidence/Incidence_from_birth/new_PTV_burden_5per_surv.png", width = 100, height = 50, units = "cm", dpi = 300)


#+ annotate(geom = "text", x = 1000, y = 1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05 , color = "black", label = pvalueA, size = 5)

#if(surv_pvalue(fit = survfit(Surv(time_in_days, event = event_indicator) ~ PTV_burden_group_3, data = unique_tempdf))$pval > 0.001){
    #plotA = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_burden_group_3, data = unique_tempdf), title = paste0("Incidence Analysis for ", x, "\n(N=", nrow(tempdf_x), ")"), ylim = c(1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05, 1),  pval = T, pval.coord =c(1, 1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05),legend = "none")$plot
  #} #else{
    #plotA = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_burden_group_3, data = unique_tempdf), title = paste0("Incidence Analysis for ", x, "\n(N=", nrow(tempdf_x), ")"), ylim = c(1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05, 1),  pval = T, pval.coord =c(1, 1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05),legend = "none")$plot
  #}

```

#PTV burden group 10%
```{r}

plotlist_PTV2 = lapply(X = unique(icd_mapping$cancer_type), FUN = function(x){
  tempdf_x = subset(ukb_data_cancer, cancer_type == x)
  tempdf_x = dplyr::arrange(tempdf_x, diag_date)
  tempdf_no_x = subset(ukb_data_cancer, cancer_type == "No_cancer")
  tempdf_no_x = tempdf_no_x[!duplicated(tempdf_no_x$eid), ]
  tempdf_x = tempdf_x[!duplicated(tempdf_x$eid), ]
  unique_tempdf = rbind(tempdf_x, tempdf_no_x)
  unique_tempdf %<>% 
    mutate(time_in_days = case_when(
      cancer_type == x ~ diag_date - birthdate,
      death == T & is.na(diag_date) ~ date_of_death - birthdate,
      death == F & is.na(diag_date) ~ max(date_of_death, na.rm = T) - birthdate,
    ))
  unique_tempdf$event_indicator = ifelse(unique_tempdf$cancer_type == x, 1, 0)
  unique_tempdf$PTV_burden_group_10per = factor(unique_tempdf$PTV_burden_group_10per, ordered = T)
  fit = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_burden_group_10per, data = unique_tempdf))
  args = list(fit = fit, title = paste0("Incidence Analysis for ", x, "\n(N=", nrow(tempdf_x), ")"), ylim = c(1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05, 1), pval = T, pval.coord = c(1, 1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05),legend = "none")
  pfit = do.call(ggsurvplot, args)
  tblA = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_burden_group_10per, data = unique_tempdf), risk.table = T, tables.theme = clean_theme())$table
  grid.arrange(pfit$plot, tblA, layout_matrix = rbind(c(1, 1), c(1,1), c(2, 2)))
})

ggarrange(plotlist =  plotlist_PTV2, ncol = 5, nrow = 5)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Incidence/Incidence_from_birth/new_PTV_burden_10per_surv.png", width = 100, height = 50, units = "cm", dpi = 300)


```

#PTV burden group 15%
```{r}
plotlist_PTV3 = lapply(X = unique(icd_mapping$cancer_type), FUN = function(x){
  tempdf_x = subset(ukb_data_cancer, cancer_type == x)
  tempdf_x = dplyr::arrange(tempdf_x, diag_date)
  tempdf_no_x = subset(ukb_data_cancer, cancer_type == "No_cancer")
  tempdf_no_x = tempdf_no_x[!duplicated(tempdf_no_x$eid), ]
  tempdf_x = tempdf_x[!duplicated(tempdf_x$eid), ]
  unique_tempdf = rbind(tempdf_x, tempdf_no_x)
  unique_tempdf %<>% 
    mutate(time_in_days = case_when(
      cancer_type == x ~ diag_date - birthdate,
      death == T & is.na(diag_date) ~ date_of_death - birthdate,
      death == F & is.na(diag_date) ~ max(date_of_death, na.rm = T) - birthdate,
    ))
  unique_tempdf$event_indicator = ifelse(unique_tempdf$cancer_type == x, 1, 0)
  unique_tempdf$PTV_burden_group_15per = factor(unique_tempdf$PTV_burden_group_15per, ordered = T)
  fit = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_burden_group_15per, data = unique_tempdf))
  args = list(fit = fit, title = paste0("Incidence Analysis for ", x, "\n(N=", nrow(tempdf_x), ")"), ylim = c(1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05, 1), pval = T, pval.coord = c(1, 1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05),legend = "none")
  pfit = do.call(ggsurvplot, args)
  tblA = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_burden_group_15per, data = unique_tempdf), risk.table = T, tables.theme = clean_theme())$table
  grid.arrange(pfit$plot, tblA, layout_matrix = rbind(c(1, 1), c(1,1), c(2, 2)))
})

ggarrange(plotlist =  plotlist_PTV3, ncol = 5, nrow = 5)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Incidence/Incidence_from_birth/new_PTV_burden_15per_surv.png", width = 100, height = 50, units = "cm", dpi = 300)


```

#PTV burden group 20%
```{r}
plotlist_PTV4 = lapply(X = unique(icd_mapping$cancer_type), FUN = function(x){
  tempdf_x = subset(ukb_data_cancer, cancer_type == x)
  tempdf_x = dplyr::arrange(tempdf_x, diag_date)
  tempdf_no_x = subset(ukb_data_cancer, cancer_type == "No_cancer")
  tempdf_no_x = tempdf_no_x[!duplicated(tempdf_no_x$eid), ]
  tempdf_x = tempdf_x[!duplicated(tempdf_x$eid), ]
  unique_tempdf = rbind(tempdf_x, tempdf_no_x)
  unique_tempdf %<>% 
    mutate(time_in_days = case_when(
      cancer_type == x ~ diag_date - birthdate,
      death == T & is.na(diag_date) ~ date_of_death - birthdate,
      death == F & is.na(diag_date) ~ max(date_of_death, na.rm = T) - birthdate,
    ))
  unique_tempdf$event_indicator = ifelse(unique_tempdf$cancer_type == x, 1, 0)
  unique_tempdf$PTV_burden_group_20per = factor(unique_tempdf$PTV_burden_group_20per, ordered = T)
  fit = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_burden_group_20per, data = unique_tempdf))
  args = list(fit = fit, title = paste0("Incidence Analysis for ", x, "\n(N=", nrow(tempdf_x), ")"), ylim = c(1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05, 1), pval = T, pval.coord = c(1, 1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05),legend = "none")
  pfit = do.call(ggsurvplot, args)
  tblA = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_burden_group_20per, data = unique_tempdf), risk.table = T, tables.theme = clean_theme())$table
  grid.arrange(pfit$plot, tblA, layout_matrix = rbind(c(1, 1), c(1,1), c(2, 2)))
})

ggarrange(plotlist =  plotlist_PTV4, ncol = 5, nrow = 5)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Incidence/Incidence_from_birth/new_PTV_burden_20per_surv.png", width = 100, height = 50, units = "cm", dpi = 300)


```



#Cancer incidence
```{r}
temp_df_2 = data.frame(eid = ukb_data_cancer$eid,
                       birthdate = ukb_data_cancer$birthdate,
                       date_of_death = ukb_data_cancer$date_of_death,
                       diag_date = ukb_data_cancer$diag_date,
                       death = ukb_data_cancer$death,
                       cancer_type = ukb_data_cancer$cancer_type,
                       PTV_burden_group = ukb_data_cancer$PTV_burden_group,
                       PTV_burden_group_2 = ukb_data_cancer$PTV_burden_group_2,
                       PTV_burden_group_3 = ukb_data_cancer$PTV_burden_group_3)

temp_df_2$cancer_type[is.na(temp_df_2$cancer_type)] = "No_cancer"

temp_df_2 <- temp_df_2 %>%
  mutate(has_cancer = if_else(cancer_type != "No_cancer", TRUE, FALSE))

temp_df_2 %<>%
  group_by(eid) %>%
  summarize(
    birthdate = first(birthdate),
    date_of_death = first(date_of_death),
    diag_date = first(diag_date),
    death = first(death),
    has_cancer = first(has_cancer),
    PTV_burden_group = first(PTV_burden_group),
    PTV_burden_group_2 = first(PTV_burden_group_2),
    PTV_burden_group_3 = first(PTV_burden_group_3))

temp_df_2 %<>% 
  mutate(time_in_days = case_when(
      has_cancer == T & death == F ~ diag_date - birthdate,
      has_cancer == T & death == T ~ date_of_death - birthdate,
      death == T & has_cancer == F ~ date_of_death - birthdate,
      death == F & has_cancer == F ~ max(date_of_death, na.rm = T) - birthdate
    ))

fit_1 = survfit(Surv(time_in_days, event = has_cancer) ~ PTV_burden_group, data = temp_df_2)
PTV_g1_cancer_surv = ggsurvplot(fit_1, risk.table = T, pval = T, tables.theme = clean_theme(), title = paste0("Incidence Analysis for Tumors (PTV burden group 1)"))
PTV_g1_cancer_surv$plot
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Incidence/PTV_g1_tumor_incidence.png", plot = PTV_g1_cancer_surv$plot, width = 60, height = 30, units = "cm", dpi = 300)

fit_2 = survfit(Surv(time_in_days, event = has_cancer) ~ PTV_burden_group_2, data = temp_df_2)
PTV_g2_cancer_surv = ggsurvplot(fit_2, risk.table = T, pval = T, tables.theme = clean_theme(), title = paste0("Incidence Analysis for Tumors (PTV burden group 2)"))
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Incidence/PTV_g2_tumor_incidence.png", plot = PTV_g2_cancer_surv$plot, width = 60, height = 30, units = "cm", dpi = 300)

fit_3 = survfit(Surv(time_in_days, event = has_cancer) ~ PTV_burden_group_3, data = temp_df_2)
PTV_g3_cancer_surv = ggsurvplot(fit_3, risk.table = T, pval = T, tables.theme = clean_theme(), title = paste0("Incidence Analysis for Tumors (PTV burden group 3)"))
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Incidence/PTV_g3_tumor_incidence.png", plot = PTV_g3_cancer_surv$plot, width = 60, height = 30, units = "cm", dpi = 300)

PTV_plot_list_inc = list(PTV_g1_cancer_surv$plot, PTV_g2_cancer_surv$plot, PTV_g3_cancer_surv$plot)
PTV_risk_list_inc = list(PTV_g1_cancer_surv$table, PTV_g2_cancer_surv$table, PTV_g3_cancer_surv$table)
PTV_plot_list_combined_inc = c(PTV_plot_list_inc, PTV_risk_list_inc)

grid.arrange(grobs = PTV_plot_list_combined_inc, ncol = 3)
plot_grid(plotlist = PTV_plot_list_combined_inc, ncol = 3)


ggsave(filename ="C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Incidence/PTV_cancer_incidence.png", width = 100, height = 50, units = "cm", dpi = 300 )


```


#Cox Model - sex
```{r}
cox_model_issue2_sex = sapply(X = unique(icd_mapping$cancer_type), FUN = function(x){
  tempdf_x = subset(ukb_data_cancer, cancer_type == x)
  tempdf_x = dplyr::arrange(tempdf_x, diag_date)
  tempdf_no_x = subset(ukb_data_cancer, cancer_type == "No_cancer")
  tempdf_no_x = tempdf_no_x[!duplicated(tempdf_no_x$eid), ]
  tempdf_x = tempdf_x[!duplicated(tempdf_x$eid), ]
  unique_tempdf = rbind(tempdf_x, tempdf_no_x)
  unique_tempdf %<>% 
    mutate(time_in_days = case_when(
      cancer_type == x ~ diag_date - birthdate,
      death == T & is.na(diag_date) ~ date_of_death - birthdate,
      death == F & is.na(diag_date) ~ max(date_of_death, na.rm = T) - birthdate,
    ))
  unique_tempdf$event_indicator = ifelse(unique_tempdf$cancer_type == x, 1, 0)
  ggsurvplot(survfit(Surv(time_in_days, event_indicator) ~ sex, data = unique_tempdf), pval = T)
  res.cox = coxph(Surv(time_in_days, event_indicator) ~ sex, data = unique_tempdf)
  c(exp(res.cox$coefficients), summary(res.cox)$coefficients[5])
})
save(file = "C:/Users/bagil/Desktop/ukb/objects/coxmodel_issue2_sex", cox_model_issue2_sex)

```

#Cox Model - age
```{r}
cox_model_issue2_age = sapply(X = unique(icd_mapping$cancer_type), FUN = function(x){
  tempdf_x = subset(ukb_data_cancer, cancer_type == x)
  tempdf_x = dplyr::arrange(tempdf_x, diag_date)
  tempdf_no_x = subset(ukb_data_cancer, cancer_type == "No_cancer")
  tempdf_no_x = tempdf_no_x[!duplicated(tempdf_no_x$eid), ]
  tempdf_x = tempdf_x[!duplicated(tempdf_x$eid), ]
  unique_tempdf = rbind(tempdf_x, tempdf_no_x)
  unique_tempdf %<>% 
    mutate(time_in_days = case_when(
      cancer_type == x ~ diag_date - birthdate,
      death == T & is.na(diag_date) ~ date_of_death - birthdate,
      death == F & is.na(diag_date) ~ max(date_of_death, na.rm = T) - birthdate,
    ))
  unique_tempdf$event_indicator = ifelse(unique_tempdf$cancer_type == x, 1, 0)
  res.cox = coxph(Surv(age, event_indicator) ~ 1, data = unique_tempdf)
  figure = ggsurvplot(survfit(res.cox), data = unique_tempdf)
  figure$plot + ylim(1-(nrow(tempdf_x)/nrow(unique_tempdf)) - (nrow(tempdf_x)/nrow(unique_tempdf))*0.05, 1)
  c(exp(res.cox$coefficients), summary(res.cox)$coefficients[5])
})
save(file = "C:/Users/bagil/Desktop/ukb/objects/coxmodel_issue2_age", cox_model_issue2_age)


```

#Cox Model - ethnic
```{r}

cox_model_issue2_ethnic = sapply(X = unique(icd_mapping$cancer_type), FUN = function(x){
  tempdf_x = subset(ukb_data_cancer, cancer_type == x)
  tempdf_x = dplyr::arrange(tempdf_x, diag_date)
  tempdf_no_x = subset(ukb_data_cancer, cancer_type == "No_cancer")
  tempdf_no_x = tempdf_no_x[!duplicated(tempdf_no_x$eid), ]
  tempdf_x = tempdf_x[!duplicated(tempdf_x$eid), ]
  unique_tempdf = rbind(tempdf_x, tempdf_no_x)
  unique_tempdf %<>% 
    mutate(time_in_days = case_when(
      cancer_type == x ~ diag_date - birthdate,
      death == T & is.na(diag_date) ~ date_of_death - birthdate,
      death == F & is.na(diag_date) ~ max(date_of_death, na.rm = T) - birthdate,
    ))
  unique_tempdf$event_indicator = ifelse(unique_tempdf$cancer_type == x, 1, 0)
  res.cox = coxph(Surv(time_in_days, event_indicator) ~ ethnic_group, data = unique_tempdf)
  c(exp(res.cox$coefficients), summary(res.cox)$coefficients[5])
})

save(file = "C:/Users/bagil/Desktop/ukb/objects/coxmodel_issue2_ethnic", cox_model_issue2_ethnic)

```

#Cox Model - skin color
```{r}
cox_model_issue2_skin = sapply(X = unique(icd_mapping$cancer_type), FUN = function(x){
  tempdf_x = subset(ukb_data_cancer, cancer_type == x)
  tempdf_x = dplyr::arrange(tempdf_x, diag_date)
  tempdf_no_x = subset(ukb_data_cancer, cancer_type == "No_cancer")
  tempdf_no_x = tempdf_no_x[!duplicated(tempdf_no_x$eid), ]
  tempdf_x = tempdf_x[!duplicated(tempdf_x$eid), ]
  unique_tempdf = rbind(tempdf_x, tempdf_no_x)
  unique_tempdf %<>% 
    mutate(time_in_days = case_when(
      cancer_type == x ~ diag_date - birthdate,
      death == T & is.na(diag_date) ~ date_of_death - birthdate,
      death == F & is.na(diag_date) ~ max(date_of_death, na.rm = T) - birthdate,
    ))
  unique_tempdf$event_indicator = ifelse(unique_tempdf$cancer_type == x, 1, 0)
  res.cox = coxph(Surv(time_in_days, event_indicator) ~ s.color, data = unique_tempdf)
  figure = ggsurvplot(survfit(res.cox), data = unique_tempdf)
  figure$plot + ylim(1-(nrow(tempdf_x)/nrow(unique_tempdf)) - (nrow(tempdf_x)/nrow(unique_tempdf))*0.05, 1)
  c(exp(res.cox$coefficients), summary(res.cox)$coefficients[5])
})

save(file ="C:/Users/bagil/Desktop/ukb/objects/coxmodel_issue2_skin", cox_model_issue2_skin)

```

#PTV coef and p value
```{r}


coxregfun = function(x) {
  tempdf_x = subset(ukb_data_cancer, cancer_type == x)
  tempdf_x = dplyr::arrange(tempdf_x, diag_date)
  tempdf_no_x = subset(ukb_data_cancer, cancer_type == "No_cancer")
  tempdf_no_x = tempdf_no_x[!duplicated(tempdf_no_x$eid), ]
  tempdf_x = tempdf_x[!duplicated(tempdf_x$eid), ]
  unique_tempdf = rbind(tempdf_x, tempdf_no_x)
  unique_tempdf %<>% 
    mutate(time_in_days = case_when(
      cancer_type == x ~ diag_date - birthdate,
      death == T & is.na(diag_date) ~ date_of_death - birthdate,
      death == F & is.na(diag_date) ~ max(date_of_death, na.rm = T) - birthdate,
    ))
  unique_tempdf$event_indicator = ifelse(unique_tempdf$cancer_type == x, 1, 0)
  res.cox = coxph(Surv(time_in_days, event_indicator) ~ PTV_burden_group, data = unique_tempdf)
  c(exp(res.cox$coefficients), summary(res.cox)$coefficients[5])
  p_value = summary(res.cox)$coefficients[5]
  coef_value = summary(res.cox)$coefficients[1]
  data.frame(
    cancer_type = x,
    p_value = p_value,
    coef_value = coef_value,
    group = c("group1")
  )
}

result_list = lapply(unique(icd_mapping$cancer_type), coxregfun)


cancer_new_PTV_g1_df = do.call(rbind, result_list)
save(cancer_new_PTV_g1_df, file = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/objects/cancer_new_PTV_coef_g1")


```

#PTV2 coef and p value
```{r}

coxregfun2 = function(x) {
  tempdf_x = subset(ukb_data_cancer, cancer_type == x)
  tempdf_x = dplyr::arrange(tempdf_x, diag_date)
  tempdf_no_x = subset(ukb_data_cancer, cancer_type == "No_cancer")
  tempdf_no_x = tempdf_no_x[!duplicated(tempdf_no_x$eid), ]
  tempdf_x = tempdf_x[!duplicated(tempdf_x$eid), ]
  unique_tempdf = rbind(tempdf_x, tempdf_no_x)
  unique_tempdf %<>% 
    mutate(time_in_days = case_when(
      cancer_type == x ~ diag_date - birthdate,
      death == T & is.na(diag_date) ~ date_of_death - birthdate,
      death == F & is.na(diag_date) ~ max(date_of_death, na.rm = T) - birthdate,
    ))
  unique_tempdf$event_indicator = ifelse(unique_tempdf$cancer_type == x, 1, 0)
  res.cox = coxph(Surv(time_in_days, event_indicator) ~ PTV_burden_group_2, data = unique_tempdf)
  c(exp(res.cox$coefficients), summary(res.cox)$coefficients[5])
  p_value = summary(res.cox)$coefficients[5]
  coef_value = summary(res.cox)$coefficients[1]
  data.frame(
    cancer_type = x,
    p_value = p_value,
    coef_value = coef_value,
    group = c("group2")
  )
}

result_list_2 = lapply(unique(icd_mapping$cancer_type), coxregfun2)


cancer_new_PTV_g2_df = do.call(rbind, result_list_2)
save(cancer_new_PTV_g2_df, file = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/objects/cancer_new_PTV_coef_g2")

```

#PTV3 coef and p value
```{r}

coxregfun3 = function(x) {
  tempdf_x = subset(ukb_data_cancer, cancer_type == x)
  tempdf_x = dplyr::arrange(tempdf_x, diag_date)
  tempdf_no_x = subset(ukb_data_cancer, cancer_type == "No_cancer")
  tempdf_no_x = tempdf_no_x[!duplicated(tempdf_no_x$eid), ]
  tempdf_x = tempdf_x[!duplicated(tempdf_x$eid), ]
  unique_tempdf = rbind(tempdf_x, tempdf_no_x)
  unique_tempdf %<>% 
    mutate(time_in_days = case_when(
      cancer_type == x ~ diag_date - birthdate,
      death == T & is.na(diag_date) ~ date_of_death - birthdate,
      death == F & is.na(diag_date) ~ max(date_of_death, na.rm = T) - birthdate,
    ))
  unique_tempdf$event_indicator = ifelse(unique_tempdf$cancer_type == x, 1, 0)
  res.cox = coxph(Surv(time_in_days, event_indicator) ~ PTV_burden_group_3, data = unique_tempdf)
  c(exp(res.cox$coefficients), summary(res.cox)$coefficients[5])
  p_value = summary(res.cox)$coefficients[5]
  coef_value = summary(res.cox)$coefficients[1]
  data.frame(
    cancer_type = x,
    p_value = p_value,
    coef_value = coef_value,
    group = c("group3")
  )
}

result_list_3 = lapply(unique(icd_mapping$cancer_type), coxregfun3)


cancer_new_PTV_g3_df = do.call(rbind, result_list_3)
save(cancer_new_PTV_g3_df, file = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/objects/cancer_new_PTV_coef_g3")

```

#PTV burden and sex
```{r}

coxregfun = function(x) {
  tempdf_x = subset(ukb_data_cancer, cancer_type == x)
  tempdf_x = dplyr::arrange(tempdf_x, diag_date)
  tempdf_no_x = subset(ukb_data_cancer, cancer_type == "No_cancer")
  tempdf_no_x = tempdf_no_x[!duplicated(tempdf_no_x$eid), ]
  tempdf_x = tempdf_x[!duplicated(tempdf_x$eid), ]
  unique_tempdf = rbind(tempdf_x, tempdf_no_x)
  unique_tempdf %<>% 
    mutate(time_in_days = case_when(
      cancer_type == x ~ diag_date - birthdate,
      death == T & is.na(diag_date) ~ date_of_death - birthdate,
      death == F & is.na(diag_date) ~ max(date_of_death, na.rm = T) - birthdate,
    ))
  unique_tempdf$event_indicator = ifelse(unique_tempdf$cancer_type == x, 1, 0)
  res.cox = coxph(Surv(time_in_days, event_indicator) ~ PTV_burden + sex, data = unique_tempdf)
  c(exp(res.cox$coefficients), summary(res.cox)$coefficients[5])
  p_value = summary(res.cox)$coefficients[5]
  coef_value = summary(res.cox)$coefficients[1]
  data.frame(
    cancer_type = x,
    p_value = p_value,
    coef_value = coef_value)
}

result_list = lapply(unique(icd_mapping$cancer_type), coxregfun)


cancer_new_PTV_cox = do.call(rbind, result_list)
save(cancer_new_PTV_cox,file = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/objects/cancer_new_PTV_cox")
rm(result_list, coxregfun, tempdf_no_x, tempdf_x, unique_tempdf, res.cox, cancer_PTV_cox, coef_value, p_value)




```

#PTV burden + sex + ethnic
```{r}

coxregfun = function(x) {
  tempdf_x = subset(ukb_data_cancer, cancer_type == x)
  tempdf_x = dplyr::arrange(tempdf_x, diag_date)
  tempdf_no_x = subset(ukb_data_cancer, cancer_type == "No_cancer")
  tempdf_no_x = tempdf_no_x[!duplicated(tempdf_no_x$eid), ]
  tempdf_x = tempdf_x[!duplicated(tempdf_x$eid), ]
  unique_tempdf = rbind(tempdf_x, tempdf_no_x)
  unique_tempdf %<>% 
    mutate(time_in_days = case_when(
      cancer_type == x ~ diag_date - birthdate,
      death == T & is.na(diag_date) ~ date_of_death - birthdate,
      death == F & is.na(diag_date) ~ max(date_of_death, na.rm = T) - birthdate,
    ))
  unique_tempdf$event_indicator = ifelse(unique_tempdf$cancer_type == x, 1, 0)
  res.cox = coxph(Surv(time_in_days, event_indicator) ~ PTV_burden + sex + ethnic_group, data = unique_tempdf)
  cox_summary = summary(res.cox)
  coef_value = cox_summary$coefficients[1]
  p_value = cox_summary$coefficients[5]
  hr = exp(cox_summary$coefficients[1])
  hr_confint = exp(confint(res.cox))
  data.frame(
    cancer_type = x,
    coef_value = coef_value,
    hr = hr,
    hr_lower_ci = hr_confint[1, 1],
    hr_upper_ci = hr_confint[1, 2],
    p_value = p_value)
}

result_list = lapply(unique(icd_mapping$cancer_type), coxregfun)
cancer_types <- unique(icd_mapping$cancer_type)
names(result_list) <- cancer_types

cancer_new_PTV_cox = do.call(rbind, result_list)
save(cancer_new_PTV_cox,file = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/objects/cancer_new_PTV_cox_sex_ethnic")


```

#Forest plot
```{r}

tumors = unique(ukb_data_cancer$cancer_type)
tumors = tumors[tumors != "No_cancer"]
tumors = tumors[tumors != "Hydatidiform_mole"]
i = 0
PTV_tumor_forest_plot = lapply(X = tumors, FUN = function(x){
  i = i + 1
  .GlobalEnv$i = i
  tempdf_x = subset(ukb_data_cancer, cancer_type == x)
  tempdf_x = dplyr::arrange(tempdf_x, diag_date)
  #icd_code = icd_mapping$ICD10[icd_mapping$cancer_type == x]
  #tempdf_x_dead = tempdf_x %>% filter(death == T, cause_of_death == icd_code)
  #tempdf_x_alive = tempdf_x %>% filter(death == F)
  #tempdf_x = rbind(tempdf_x_alive, tempdf_x_dead)
  tempdf_no_x = subset(ukb_data_cancer, cancer_type == "No_cancer")
  tempdf_no_x = tempdf_no_x[!duplicated(tempdf_no_x$eid), ]
  tempdf_x = tempdf_x[!duplicated(tempdf_x$eid), ]
  unique_tempdf = rbind(tempdf_x, tempdf_no_x)
  unique_tempdf %<>% 
    mutate(time_in_days = case_when(
      cancer_type == x ~ diag_date - birthdate,
      death == T & is.na(diag_date) ~ date_of_death - birthdate,
      death == F & is.na(diag_date) ~ max(date_of_death, na.rm = T) - birthdate,
    ))
  unique_tempdf$event_indicator = ifelse(unique_tempdf$cancer_type == x, 1, 0)
  unique_tempdf$sex = factor(unique_tempdf$sex)
  l = tempdf_x %>% 
    add_count(ethnic_group, name = "freq") %>% 
    filter(freq > nrow(tempdf_x)/50) %>% 
    arrange(desc(freq)) %>% 
    pull(ethnic_group) %>% 
    unique()
  if (length(l) == 1 & length(unique(tempdf_x$sex)) == 1){
    hr_model = coxph(Surv(time_in_days, event_indicator) ~ PTV_burden + gpca1 + gpca2 + gpca3 + gpca4 + gpca5 + gpca6 + gpca7 + gpca8 + gpca9 + gpca10, data = unique_tempdf)
  } else if(length(l) == 1 & length(unique(tempdf_x$sex)) == 2){
    hr_model = coxph(Surv(time_in_days, event_indicator) ~ PTV_burden + sex + gpca1 + gpca2 + gpca3 + gpca4 + gpca5 + gpca6 + gpca7 + gpca8 + gpca9 + gpca10, data = unique_tempdf)
  } else if(length(l) > 1 & length(unique(tempdf_x$sex)) == 1){
    unique_tempdf$ethnic_group = factor(unique_tempdf$ethnic_group, levels = c("British", sort(setdiff(l, "British"))))
    hr_model = coxph(Surv(time_in_days, event_indicator) ~ PTV_burden + ethnic_group + gpca1 + gpca2 + gpca3 + gpca4 + gpca5 + gpca6 + gpca7 + gpca8 + gpca9 + gpca10, data = unique_tempdf)
  } else {
    unique_tempdf$ethnic_group = factor(unique_tempdf$ethnic_group, levels = c("British", sort(setdiff(l, "British"))))
    hr_model = coxph(Surv(time_in_days, event_indicator) ~ PTV_burden + sex + ethnic_group + gpca1 + gpca2 + gpca3 + gpca4 + gpca5 + gpca6 + gpca7 + gpca8 + gpca9 + gpca10, data = unique_tempdf)
  }
  ggforest(hr_model, data = unique_tempdf, main = paste0("Hazard ratio of ", x))
})

PTV_cox_forest = ggarrange(plotlist = PTV_tumor_forest_plot, ncol = 7, nrow = 4)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Incidence/Incidence_from_birth/cancer_type_ptv_forest.png", plot = PTV_cox_forest, width = 140, height = 80, units = "cm", limitsize = F, dpi = 300)


```


```{r}

ukb_data_cancer$has_tumor = T
ukb_data_cancer$has_tumor[ukb_data_cancer$cancer_type == "No_cancer"] = F

tempdf_x = subset(ukb_data_cancer, cancer_type != "No_cancer")
tempdf_x = dplyr::arrange(tempdf_x, diag_date)
tempdf_x = tempdf_x[!duplicated(tempdf_x$eid), ]
tempdf_x$has_tumor = T
tempdf_no_x = subset(ukb_data_cancer, cancer_type == "No_cancer")
tempdf_no_x = tempdf_no_x[!duplicated(tempdf_no_x$eid), ]
tempdf_no_x$has_tumor = F
unique_tempdf = rbind(tempdf_x, tempdf_no_x)
unique_tempdf %<>% 
  mutate(time_in_days = case_when(
    has_tumor == T ~ diag_date - birthdate,
    death == T & is.na(diag_date) ~ date_of_death - birthdate,
    death == F & is.na(diag_date) ~ max(date_of_death, na.rm = T) - birthdate,
  ))
unique_tempdf$event_indicator = ifelse(unique_tempdf$has_tumor == T, 1, 0)
unique_tempdf$sex = factor(unique_tempdf$sex)
l = tempdf_x %>% 
  add_count(ethnic_group, name = "freq") %>% 
  filter(freq > nrow(tempdf_x)/50) %>% 
  arrange(desc(freq)) %>% 
  pull(ethnic_group) %>% 
  unique()

unique_tempdf$ethnic_group = factor(unique_tempdf$ethnic_group, levels = c("British", sort(setdiff(l, "British"))))
hr_model = coxph(Surv(time_in_days, event_indicator) ~ PTV_burden + sex + ethnic_group + gpca_1 + gpca_2 + gpca_3 + gpca_4 + gpca_5 + gpca_6 + gpca_7 + gpca_8 + gpca_9 + gpca_10, data = unique_tempdf)
ggforest(hr_model, data = unique_tempdf, main = "Hazard ratio of cancer")
hr_model



```


#Forest plot for tumor categories
```{r}

#load("C:/Users/bagil/Desktop/MyGit/ukb_tumor/objects/ukb_data_cancer_final")
ukb_data_cancer$hist_tumor_cat[is.na(ukb_data_cancer$hist_tumor_cat)] = "No_cancer"
hist_cat = unique(ukb_data_cancer$hist_tumor_cat)
hist_cat = hist_cat[hist_cat != "No_cancer"]
i = 0
PTV_tumor_hist_forest_plot = lapply(X = hist_cat, FUN = function(x){
  i = i + 1
  .GlobalEnv$i = i
  tempdf_x = subset(ukb_data_cancer, hist_tumor_cat == x)
  tempdf_x = dplyr::arrange(tempdf_x, diag_date)
  #icd_code = icd_mapping$ICD10[icd_mapping$hist_tumor_cat == x]
  #tempdf_x_dead = tempdf_x %>% filter(death == T, cause_of_death == icd_code)
  #tempdf_x_alive = tempdf_x %>% filter(death == F)
  #tempdf_x = rbind(tempdf_x_alive, tempdf_x_dead)
  tempdf_no_x = subset(ukb_data_cancer, hist_tumor_cat == "No_cancer")
  tempdf_no_x = tempdf_no_x[!duplicated(tempdf_no_x$eid), ]
  tempdf_x = tempdf_x[!duplicated(tempdf_x$eid), ]
  unique_tempdf = rbind(tempdf_x, tempdf_no_x)
  unique_tempdf %<>% 
    mutate(time_in_days = case_when(
      hist_tumor_cat == x ~ diag_date - birthdate,
      death == T & is.na(diag_date) ~ date_of_death - birthdate,
      death == F & is.na(diag_date) ~ max(date_of_death, na.rm = T) - birthdate,
    ))
  unique_tempdf$event_indicator = ifelse(unique_tempdf$hist_tumor_cat == x, 1, 0)
  unique_tempdf$sex = factor(unique_tempdf$sex)
  l = tempdf_x %>% 
    add_count(ethnic_group, name = "freq") %>% 
    filter(freq > nrow(tempdf_x)/50) %>% 
    arrange(desc(freq)) %>% 
    pull(ethnic_group) %>% 
    unique()
  if (length(l) == 1 & length(unique(tempdf_x$sex)) == 1){
    hr_model = coxph(Surv(time_in_days, event_indicator) ~ PTV_burden + gpca1 + gpca2 + gpca3 + gpca4 + gpca5 + gpca6 + gpca7 + gpca8 + gpca9 + gpca10, data = unique_tempdf)
  } else if(length(l) == 1 & length(unique(tempdf_x$sex)) == 2){
    hr_model = coxph(Surv(time_in_days, event_indicator) ~ PTV_burden + sex + gpca1 + gpca2 + gpca3 + gpca4 + gpca5 + gpca6 + gpca7 + gpca8 + gpca9 + gpca10, data = unique_tempdf)
  } else if(length(l) > 1 & length(unique(tempdf_x$sex)) == 1){
    unique_tempdf$ethnic_group = factor(unique_tempdf$ethnic_group, levels = c("British", sort(setdiff(l, "British"))))
    hr_model = coxph(Surv(time_in_days, event_indicator) ~ PTV_burden + ethnic_group + gpca1 + gpca2 + gpca3 + gpca4 + gpca5 + gpca6 + gpca7 + gpca8 + gpca9 + gpca10, data = unique_tempdf)
  } else {
    unique_tempdf$ethnic_group = factor(unique_tempdf$ethnic_group, levels = c("British", sort(setdiff(l, "British"))))
    hr_model = coxph(Surv(time_in_days, event_indicator) ~ PTV_burden + sex + ethnic_group + gpca1 + gpca2 + gpca3 + gpca4 + gpca5 + gpca6 + gpca7 + gpca8 + gpca9 + gpca10, data = unique_tempdf)
  }
  ggforest(hr_model, data = as.data.frame(unique_tempdf), main = paste0("Hazard ratio of ", x))
})

PTV_hist_cox_forest = ggarrange(plotlist = PTV_tumor_hist_forest_plot, ncol = 3, nrow = 2)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Incidence/Incidence_from_birth/hist_tumor_cat_forest.png", plot = PTV_hist_cox_forest, width = 80, height = 70, units = "cm", limitsize = F, dpi = 300)




```

#Surv analysis 
##Tumor cat by hist universal 1 female
```{r}

ukb_data_cancer$hist_tumor_cat[is.na(ukb_data_cancer$hist_tumor_cat)] = "No_cancer"
ukb_data_cancer$gender = ifelse(ukb_data_cancer$sex == 0, "female", "male")
hist_cat = unique(ukb_data_cancer$hist_tumor_cat)
hist_cat = hist_cat[hist_cat != "No_cancer"]

uni_plot_list_1_f = lapply(X = hist_cat, FUN = function(x){
  tempdf_x = subset(ukb_data_cancer, hist_tumor_cat == x)
  tempdf_x = dplyr::arrange(tempdf_x, diag_date)
  tempdf_no_x = subset(ukb_data_cancer, hist_tumor_cat == "No_cancer")
  tempdf_no_x = tempdf_no_x[!duplicated(tempdf_no_x$eid), ]
  tempdf_x = tempdf_x[!duplicated(tempdf_x$eid), ]
  unique_tempdf = rbind(tempdf_x, tempdf_no_x)
  unique_tempdf = subset(ukb_data_cancer, gender == "female")
  unique_tempdf %<>% 
    mutate(time_in_days = case_when(
      hist_tumor_cat == x ~ diag_date - birthdate,
      death == T & is.na(diag_date) ~ date_of_death - birthdate,
      death == F & is.na(diag_date) ~ max(date_of_death, na.rm = T) - birthdate,
    ))
  unique_tempdf$event_indicator = ifelse(unique_tempdf$hist_tumor_cat == x, 1, 0)
  #unique_tempdf$PTV_universal_1 = factor(unique_tempdf$PTV_universal_1, ordered = T)
  fit = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_universal_1, data = unique_tempdf))
  args = list(fit = fit, title = paste0("Incidence Analysis for ", x, "\n(N=", nrow(tempdf_x), ")"), ylim = c(1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05, 1), pval = T, pval.coord = c(1, 1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05),legend = "none")
  pfit = do.call(ggsurvplot, args)
  #curv_facet = pfit$plot + facet_grid(rows = "gender")
  #curv_facet
  tblA = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_universal_1, data = unique_tempdf), risk.table = T)$table
  grid.arrange(pfit$plot, tblA, layout_matrix = rbind(c(1, 1), c(1,1), c(2, 2)))
})

ggarrange(plotlist =  uni_plot_list_1_f, ncol = 3, nrow = 2)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Incidence/Incidence_from_birth/tumor_cat_PTV_universal_1_female.png", width = 170, height = 70, units = "cm", dpi = 300, limitsize = F)

```


```{r}

ukb_data_cancer$hist_tumor_cat[is.na(ukb_data_cancer$hist_tumor_cat)] = "No_cancer"
ukb_data_cancer$gender = ifelse(ukb_data_cancer$sex == 0, "female", "male")
hist_cat = unique(ukb_data_cancer$hist_tumor_cat)
hist_cat = hist_cat[hist_cat != "No_cancer"]

uni_plot_list_1_f = lapply(X = hist_cat, FUN = function(x){
  tempdf_x = subset(ukb_data_cancer, hist_tumor_cat == x)
  tempdf_x = dplyr::arrange(tempdf_x, diag_date)
  tempdf_no_x = subset(ukb_data_cancer, hist_tumor_cat == "No_cancer")
  tempdf_no_x = tempdf_no_x[!duplicated(tempdf_no_x$eid), ]
  tempdf_x = tempdf_x[!duplicated(tempdf_x$eid), ]
  unique_tempdf = rbind(tempdf_x, tempdf_no_x)
  #unique_tempdf = subset(ukb_data_cancer, gender == "female")
  unique_tempdf %<>% 
    mutate(time_in_days = case_when(
      hist_tumor_cat == x ~ diag_date - birthdate,
      death == T & is.na(diag_date) ~ date_of_death - birthdate,
      death == F & is.na(diag_date) ~ max(date_of_death, na.rm = T) - birthdate,
    ))
  unique_tempdf$event_indicator = ifelse(unique_tempdf$hist_tumor_cat == x, 1, 0)
  unique_tempdf$PTV_burden_group = cut(unique_tempdf$PTV_burden, breaks = c(0, 10, 20, 50), include.lowest = T)
  #unique_tempdf$PTV_universal_1 = factor(unique_tempdf$PTV_universal_1, ordered = T)
  fit_f = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_burden_group + gender, data = subset(unique_tempdf, gender == "female")))
  args_f = list(fit = fit_f, title = paste0("Incidence Analysis for ", x, "(Female)\n(N=", nrow(tempdf_x[tempdf_x$gender == "female",]), ")"), ylim = c(1 - (nrow(tempdf_x[tempdf_x$gender == "female",]) / nrow(unique_tempdf[unique_tempdf$gender == "female",])) - (nrow(tempdf_x[tempdf_x$gender == "female",]) / nrow(unique_tempdf[unique_tempdf$gender == "female",])) * 0.05, 1), pval = T, pval.coord = c(1, 1 - (nrow(tempdf_x[tempdf_x$gender == "female",]) / nrow(unique_tempdf[unique_tempdf$gender == "female",])) - (nrow(tempdf_x[tempdf_x$gender == "female",]) / nrow(unique_tempdf[unique_tempdf$gender == "female",])) * 0.05), legend = "none")
  pfit_f = do.call(ggsurvplot, args_f)
  tbl_f = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_burden_group + gender, data =  subset(unique_tempdf, gender == "female")), risk.table = T)$table
  fit_m = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_burden_group + gender, data = subset(unique_tempdf, gender == "male")))
  args_m = list(fit = fit_m, title = paste0("Incidence Analysis for ", x, "(Male)\n(N=", nrow(tempdf_x[tempdf_x$gender == "male",]), ")"), ylim = c(1 - (nrow(tempdf_x[tempdf_x$gender == "male",]) / nrow(unique_tempdf[unique_tempdf$gender == "male",])) - (nrow(tempdf_x[tempdf_x$gender == "male",]) / nrow(unique_tempdf[unique_tempdf$gender == "male",])) * 0.05, 1), pval = T, pval.coord = c(1, 1 - (nrow(tempdf_x[tempdf_x$gender == "male",]) / nrow(unique_tempdf[unique_tempdf$gender == "male",])) - (nrow(tempdf_x[tempdf_x$gender == "male",]) / nrow(unique_tempdf[unique_tempdf$gender == "male",])) * 0.05), legend = "none")
  pfit_m = do.call(ggsurvplot, args_m)
  tbl_m = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_burden_group + gender, data =  subset(unique_tempdf, gender == "male")), risk.table = T)$table
  grid.arrange(pfit_f$plot, pfit_m$plot, tbl_f, tbl_m, layout_matrix = rbind(c(1, 1, 2, 2), c(1,1, 2, 2), c(3, 3, 4, 4)))
})

ggarrange(plotlist =  uni_plot_list_1_f, ncol = 3, nrow = 2)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Incidence/Incidence_from_birth/tumor_cat_PTV_universal_1_female.png", width = 170, height = 70, units = "cm", dpi = 300, limitsize = F)

#curv_facet = list(ggsurvplot_facet(fit = fit, data = unique_tempdf, facet.by = "gender"))
  #curv_facet


```


##Tumor cat by hist universal 1 male
```{r}

ukb_data_cancer$hist_tumor_cat[is.na(ukb_data_cancer$hist_tumor_cat)] = "No_cancer"
ukb_data_cancer$gender = ifelse(ukb_data_cancer$sex == 0, "female", "male")
hist_cat = unique(ukb_data_cancer$hist_tumor_cat)
hist_cat = hist_cat[hist_cat != "No_cancer"]

uni_plot_list_1_m = lapply(X = hist_cat, FUN = function(x){
  tempdf_x = subset(ukb_data_cancer, hist_tumor_cat == x)
  tempdf_x = dplyr::arrange(tempdf_x, diag_date)
  tempdf_no_x = subset(ukb_data_cancer, hist_tumor_cat == "No_cancer")
  tempdf_no_x = tempdf_no_x[!duplicated(tempdf_no_x$eid), ]
  tempdf_x = tempdf_x[!duplicated(tempdf_x$eid), ]
  unique_tempdf = rbind(tempdf_x, tempdf_no_x)
  unique_tempdf = subset(ukb_data_cancer, gender == "male")
  unique_tempdf %<>% 
    mutate(time_in_days = case_when(
      hist_tumor_cat == x ~ diag_date - birthdate,
      death == T & is.na(diag_date) ~ date_of_death - birthdate,
      death == F & is.na(diag_date) ~ max(date_of_death, na.rm = T) - birthdate,
    ))
  unique_tempdf$event_indicator = ifelse(unique_tempdf$hist_tumor_cat == x, 1, 0)
  #unique_tempdf$PTV_universal_1 = factor(unique_tempdf$PTV_universal_1, ordered = T)
  fit = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_universal_1, data = unique_tempdf))
  args = list(fit = fit, title = paste0("Incidence Analysis for ", x, "\n(N=", nrow(tempdf_x), ")"), ylim = c(1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05, 1), pval = T, pval.coord = c(1, 1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05),legend = "none")
  pfit = do.call(ggsurvplot, args)
  #curv_facet = pfit$plot + facet_grid(rows = "gender")
  #curv_facet
  tblA = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_universal_1, data = unique_tempdf), risk.table = T, tables.theme = clean_theme())$table
  grid.arrange(pfit$plot, tblA, layout_matrix = rbind(c(1, 1), c(1,1), c(2, 2)))
})

ggarrange(plotlist =  uni_plot_list_1_m, ncol = 3, nrow = 2)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Incidence/Incidence_from_birth/tumor_cat_PTV_universal_1_male.png", width = 170, height = 70, units = "cm", dpi = 300, limitsize = F)

```


##Tumor cat by hist universal 2
```{r}
ukb_data_cancer$hist_tumor_cat[is.na(ukb_data_cancer$hist_tumor_cat)] = "No_cancer"
hist_cat = unique(ukb_data_cancer$hist_tumor_cat)
hist_cat = hist_cat[hist_cat != "No_cancer"]

uni_plot_list_2_m = lapply(X = hist_cat, FUN = function(x){
  tempdf_x = subset(ukb_data_cancer, hist_tumor_cat == x)
  tempdf_x = dplyr::arrange(tempdf_x, diag_date)
  tempdf_no_x = subset(ukb_data_cancer, hist_tumor_cat == "No_cancer")
  tempdf_no_x = tempdf_no_x[!duplicated(tempdf_no_x$eid), ]
  tempdf_x = tempdf_x[!duplicated(tempdf_x$eid), ]
  unique_tempdf = rbind(tempdf_x, tempdf_no_x)
  unique_tempdf = subset(unique_tempdf, gender == "male")
  unique_tempdf %<>% 
    mutate(time_in_days = case_when(
      hist_tumor_cat == x ~ diag_date - birthdate,
      death == T & is.na(diag_date) ~ date_of_death - birthdate,
      death == F & is.na(diag_date) ~ max(date_of_death, na.rm = T) - birthdate,
    ))
  unique_tempdf$event_indicator = ifelse(unique_tempdf$hist_tumor_cat == x, 1, 0)
  #unique_tempdf$PTV_universal_2 = factor(unique_tempdf$PTV_universal_2, ordered = T)
  fit = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_universal_2, data = unique_tempdf))
  args = list(fit = fit, title = paste0("Incidence Analysis for ", x, "\n(N=", nrow(tempdf_x), ")"), ylim = c(1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05, 1), pval = T, pval.coord = c(1, 1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05),legend = "none")
  pfit = do.call(ggsurvplot, args)
  tblA = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_universal_2, data = unique_tempdf), risk.table = T, tables.theme = clean_theme())$table
  grid.arrange(pfit$plot, tblA, layout_matrix = rbind(c(1, 1), c(1,1), c(2, 2)))
})

ggarrange(plotlist =  uni_plot_list_2_m, ncol = 3, nrow = 2)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Incidence/Incidence_from_birth/tumor_cat_PTV_universal_2_male.png", width = 170, height = 70, units = "cm", dpi = 300, limitsize = F)


```

##
```{r}

ukb_data_cancer$hist_tumor_cat[is.na(ukb_data_cancer$hist_tumor_cat)] = "No_cancer"
hist_cat = unique(ukb_data_cancer$hist_tumor_cat)
hist_cat = hist_cat[hist_cat != "No_cancer"]

uni_plot_list_2_f = lapply(X = hist_cat, FUN = function(x){
  tempdf_x = subset(ukb_data_cancer, hist_tumor_cat == x)
  tempdf_x = dplyr::arrange(tempdf_x, diag_date)
  tempdf_no_x = subset(ukb_data_cancer, hist_tumor_cat == "No_cancer")
  tempdf_no_x = tempdf_no_x[!duplicated(tempdf_no_x$eid), ]
  tempdf_x = tempdf_x[!duplicated(tempdf_x$eid), ]
  unique_tempdf = rbind(tempdf_x, tempdf_no_x)
  unique_tempdf = subset(unique_tempdf, gender == "female")
  unique_tempdf %<>% 
    mutate(time_in_days = case_when(
      hist_tumor_cat == x ~ diag_date - birthdate,
      death == T & is.na(diag_date) ~ date_of_death - birthdate,
      death == F & is.na(diag_date) ~ max(date_of_death, na.rm = T) - birthdate,
    ))
  unique_tempdf$event_indicator = ifelse(unique_tempdf$hist_tumor_cat == x, 1, 0)
  #unique_tempdf$PTV_universal_2 = factor(unique_tempdf$PTV_universal_2, ordered = T)
  fit = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_universal_2, data = unique_tempdf))
  args = list(fit = fit, title = paste0("Incidence Analysis for ", x, "\n(N=", nrow(tempdf_x), ")"), ylim = c(1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05, 1), pval = T, pval.coord = c(1, 1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05),legend = "none")
  pfit = do.call(ggsurvplot, args)
  tblA = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_universal_2, data = unique_tempdf), risk.table = T, tables.theme = clean_theme())$table
  grid.arrange(pfit$plot, tblA, layout_matrix = rbind(c(1, 1), c(1,1), c(2, 2)))
})

ggarrange(plotlist =  uni_plot_list_2_f, ncol = 3, nrow = 2)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Incidence/Incidence_from_birth/tumor_cat_PTV_universal_2_female.png", width = 170, height = 70, units = "cm", dpi = 300, limitsize = F)

```


##Universal 3
```{r}

ukb_data_cancer$hist_tumor_cat[is.na(ukb_data_cancer$hist_tumor_cat)] = "No_cancer"
hist_cat = unique(ukb_data_cancer$hist_tumor_cat)
hist_cat = hist_cat[hist_cat != "No_cancer"]

uni_plot_list_3_f = lapply(X = hist_cat, FUN = function(x){
  tempdf_x = subset(ukb_data_cancer, hist_tumor_cat == x)
  tempdf_x = dplyr::arrange(tempdf_x, diag_date)
  tempdf_no_x = subset(ukb_data_cancer, hist_tumor_cat == "No_cancer")
  tempdf_no_x = tempdf_no_x[!duplicated(tempdf_no_x$eid), ]
  tempdf_x = tempdf_x[!duplicated(tempdf_x$eid), ]
  unique_tempdf = rbind(tempdf_x, tempdf_no_x)
  unique_tempdf = subset(unique_tempdf, gender == "female")
  unique_tempdf %<>% 
    mutate(time_in_days = case_when(
      hist_tumor_cat == x ~ diag_date - birthdate,
      death == T & is.na(diag_date) ~ date_of_death - birthdate,
      death == F & is.na(diag_date) ~ max(date_of_death, na.rm = T) - birthdate,
    ))
  unique_tempdf$event_indicator = ifelse(unique_tempdf$hist_tumor_cat == x, 1, 0)
  #unique_tempdf$PTV_universal_2 = factor(unique_tempdf$PTV_universal_2, ordered = T)
  fit = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_universal_2, data = unique_tempdf))
  args = list(fit = fit, title = paste0("Incidence Analysis for ", x, "\n(N=", nrow(tempdf_x), ")"), ylim = c(1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05, 1), pval = T, pval.coord = c(1, 1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05),legend = "none")
  pfit = do.call(ggsurvplot, args)
  tblA = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_universal_2, data = unique_tempdf), risk.table = T, tables.theme = clean_theme())$table
  grid.arrange(pfit$plot, tblA, layout_matrix = rbind(c(1, 1), c(1,1), c(2, 2)))
})

ggarrange(plotlist =  uni_plot_list_3_f, ncol = 3, nrow = 2)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Incidence/Incidence_from_birth/tumor_cat_PTV_universal_2_female.png", width = 170, height = 70, units = "cm", dpi = 300, limitsize = F)

```


```{r}

ukb_data_cancer$hist_tumor_cat[is.na(ukb_data_cancer$hist_tumor_cat)] = "No_cancer"
hist_cat = unique(ukb_data_cancer$hist_tumor_cat)
hist_cat = hist_cat[hist_cat != "No_cancer"]

uni_plot_list_3_m = lapply(X = hist_cat, FUN = function(x){
  tempdf_x = subset(ukb_data_cancer, hist_tumor_cat == x)
  tempdf_x = dplyr::arrange(tempdf_x, diag_date)
  tempdf_no_x = subset(ukb_data_cancer, hist_tumor_cat == "No_cancer")
  tempdf_no_x = tempdf_no_x[!duplicated(tempdf_no_x$eid), ]
  tempdf_x = tempdf_x[!duplicated(tempdf_x$eid), ]
  unique_tempdf = rbind(tempdf_x, tempdf_no_x)
  unique_tempdf = subset(unique_tempdf, gender == "male")
  unique_tempdf %<>% 
    mutate(time_in_days = case_when(
      hist_tumor_cat == x ~ diag_date - birthdate,
      death == T & is.na(diag_date) ~ date_of_death - birthdate,
      death == F & is.na(diag_date) ~ max(date_of_death, na.rm = T) - birthdate,
    ))
  unique_tempdf$event_indicator = ifelse(unique_tempdf$hist_tumor_cat == x, 1, 0)
  #unique_tempdf$PTV_universal_2 = factor(unique_tempdf$PTV_universal_2, ordered = T)
  fit = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_universal_2, data = unique_tempdf))
  args = list(fit = fit, title = paste0("Incidence Analysis for ", x, "\n(N=", nrow(tempdf_x), ")"), ylim = c(1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05, 1), pval = T, pval.coord = c(1, 1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05),legend = "none")
  pfit = do.call(ggsurvplot, args)
  tblA = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_universal_2, data = unique_tempdf), risk.table = T, tables.theme = clean_theme())$table
  grid.arrange(pfit$plot, tblA, layout_matrix = rbind(c(1, 1), c(1,1), c(2, 2)))
})

ggarrange(plotlist =  uni_plot_list_3_m, ncol = 3, nrow = 2)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Incidence/Incidence_from_birth/tumor_cat_PTV_universal_2_male.png", width = 170, height = 70, units = "cm", dpi = 300, limitsize = F)

```


##Tumor cat by hist cancer
```{r}

ukb_data_cancer$hist_tumor_cat[is.na(ukb_data_cancer$hist_tumor_cat)] = "No_cancer"
hist_cat = unique(ukb_data_cancer$hist_tumor_cat)
hist_cat = hist_cat[hist_cat != "No_cancer"]

plotlist_PTV3 = lapply(X = hist_cat, FUN = function(x){
  tempdf_x = subset(ukb_data_cancer, hist_tumor_cat == x)
  tempdf_x = dplyr::arrange(tempdf_x, diag_date)
  tempdf_no_x = subset(ukb_data_cancer, hist_tumor_cat == "No_cancer")
  tempdf_no_x = tempdf_no_x[!duplicated(tempdf_no_x$eid), ]
  tempdf_x = tempdf_x[!duplicated(tempdf_x$eid), ]
  unique_tempdf = rbind(tempdf_x, tempdf_no_x)
  unique_tempdf %<>% 
    mutate(time_in_days = case_when(
      hist_tumor_cat == x ~ diag_date - birthdate,
      death == T & is.na(diag_date) ~ date_of_death - birthdate,
      death == F & is.na(diag_date) ~ max(date_of_death, na.rm = T) - birthdate,
    ))
  unique_tempdf$event_indicator = ifelse(unique_tempdf$hist_tumor_cat == x, 1, 0)
  #unique_tempdf$PTV_cancer = factor(unique_tempdf$PTV_cancer, ordered = T)
  fit = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_cancer, data = unique_tempdf))
  args = list(fit = fit, title = paste0("Incidence Analysis for ", x, "\n(N=", nrow(tempdf_x), ")"), ylim = c(1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05, 1), pval = T, pval.coord = c(1, 1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05),legend = "none")
  pfit = do.call(ggsurvplot, args)
  tblA = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_cancer, data = unique_tempdf), risk.table = T, tables.theme = clean_theme())$table
  grid.arrange(pfit$plot, tblA, layout_matrix = rbind(c(1, 1), c(1,1), c(2, 2)))
})

ggarrange(plotlist =  plotlist_PTV3, ncol = 3, nrow = 2)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Incidence/Incidence_from_birth/tumor_cat_PTV_cancer.png", width = 170, height = 70, units = "cm", dpi = 300, limitsize = F)

```

##Hist cat 1
```{r}

ukb_data_cancer$hist_tumor_cat[is.na(ukb_data_cancer$hist_tumor_cat)] = "No_cancer"
hist_cat = unique(ukb_data_cancer$hist_tumor_cat)
hist_cat = hist_cat[hist_cat != "No_cancer"]

spec_hist_plotlist_1_f = lapply(X = hist_cat, FUN = function(x){
  tempdf_x = subset(ukb_data_cancer, hist_tumor_cat == x)
  tempdf_x$PTV_hist_type_1 = as.character(tempdf_x$PTV_hist_type_1)
  tempdf_x = dplyr::arrange(tempdf_x, diag_date)
  l = sort(unique(tempdf_x$PTV_hist_type_1))
  cp = unique(sort(unlist(sapply(X = l, FUN = function(y)  sapply(X = strsplit(y, ",")[[1]], FUN = function(x) as.numeric(str_extract(x, "\\d+")))))))
  tempdf_no_x = subset(ukb_data_cancer, hist_tumor_cat == "No_cancer")
  tempdf_no_x$PTV_hist_type_1 = as.character(tempdf_no_x$PTV_hist_type_1)
  tempdf_no_x = tempdf_no_x[!duplicated(tempdf_no_x$eid), ]
  tempdf_no_x$PTV_hist_type_1 = cut(tempdf_no_x$PTV_burden, breaks = cp, include.lowest = T, right = T)
  tempdf_x = tempdf_x[!duplicated(tempdf_x$eid), ]
  unique_tempdf = rbind(tempdf_x, tempdf_no_x)
  unique_tempdf$PTV_hist_type_1 = cut(unique_tempdf$PTV_burden, breaks = cp, include.lowest = T, right = T)
  unique_tempdf = subset(unique_tempdf, gender == "female")
  unique_tempdf %<>% 
    mutate(time_in_days = case_when(
      hist_tumor_cat == x ~ diag_date - birthdate,
      death == T & is.na(diag_date) ~ date_of_death - birthdate,
      death == F & is.na(diag_date) ~ max(date_of_death, na.rm = T) - birthdate,
    ))
  unique_tempdf$event_indicator = ifelse(unique_tempdf$hist_tumor_cat == x, 1, 0)
  #unique_tempdf$PTV_hist_type_1 = factor(unique_tempdf$PTV_hist_type_1, ordered = T)
  fit = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_hist_type_1, data = unique_tempdf))
  args = list(fit = fit, title = paste0("Incidence Analysis for ", x, "\n(N=", nrow(tempdf_x), ")"), ylim = c(1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05, 1), pval = T, pval.coord = c(1, 1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05),legend = "none")
  pfit = do.call(ggsurvplot, args)
  tblA = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_hist_type_1, data = unique_tempdf), risk.table = T, tables.theme = clean_theme())$table
  grid.arrange(pfit$plot, tblA, layout_matrix = rbind(c(1, 1), c(1,1), c(2, 2)))
})

ggarrange(plotlist =  spec_hist_plotlist_1_f, ncol = 3, nrow = 2)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Incidence/Incidence_from_birth/tumor_cat_PTV_tumor_cat_1_female.png", width = 170, height = 70, units = "cm", dpi = 300, limitsize = F)

```


```{r}

ukb_data_cancer$hist_tumor_cat[is.na(ukb_data_cancer$hist_tumor_cat)] = "No_cancer"
hist_cat = unique(ukb_data_cancer$hist_tumor_cat)
hist_cat = hist_cat[hist_cat != "No_cancer"]

spec_hist_plotlist_1_m = lapply(X = hist_cat, FUN = function(x){
  tempdf_x = subset(ukb_data_cancer, hist_tumor_cat == x)
  tempdf_x$PTV_hist_type_1 = as.character(tempdf_x$PTV_hist_type_1)
  tempdf_x = dplyr::arrange(tempdf_x, diag_date)
  l = sort(unique(tempdf_x$PTV_hist_type_1))
  cp = unique(sort(unlist(sapply(X = l, FUN = function(y)  sapply(X = strsplit(y, ",")[[1]], FUN = function(x) as.numeric(str_extract(x, "\\d+")))))))
  tempdf_no_x = subset(ukb_data_cancer, hist_tumor_cat == "No_cancer")
  tempdf_no_x$PTV_hist_type_1 = as.character(tempdf_no_x$PTV_hist_type_1)
  tempdf_no_x = tempdf_no_x[!duplicated(tempdf_no_x$eid), ]
  tempdf_no_x$PTV_hist_type_1 = cut(tempdf_no_x$PTV_burden, breaks = cp, include.lowest = T, right = T)
  tempdf_x = tempdf_x[!duplicated(tempdf_x$eid), ]
  unique_tempdf = rbind(tempdf_x, tempdf_no_x)
  unique_tempdf$PTV_hist_type_1 = cut(unique_tempdf$PTV_burden, breaks = cp, include.lowest = T, right = T)
  unique_tempdf = subset(unique_tempdf, gender == "male")
  unique_tempdf %<>% 
    mutate(time_in_days = case_when(
      hist_tumor_cat == x ~ diag_date - birthdate,
      death == T & is.na(diag_date) ~ date_of_death - birthdate,
      death == F & is.na(diag_date) ~ max(date_of_death, na.rm = T) - birthdate,
    ))
  unique_tempdf$event_indicator = ifelse(unique_tempdf$hist_tumor_cat == x, 1, 0)
  #unique_tempdf$PTV_hist_type_1 = factor(unique_tempdf$PTV_hist_type_1, ordered = T)
  fit = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_hist_type_1, data = unique_tempdf))
  args = list(fit = fit, title = paste0("Incidence Analysis for ", x, "\n(N=", nrow(tempdf_x), ")"), ylim = c(1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05, 1), pval = T, pval.coord = c(1, 1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05),legend = "none")
  pfit = do.call(ggsurvplot, args)
  tblA = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_hist_type_1, data = unique_tempdf), risk.table = T, tables.theme = clean_theme())$table
  grid.arrange(pfit$plot, tblA, layout_matrix = rbind(c(1, 1), c(1,1), c(2, 2)))
})

ggarrange(plotlist =  spec_hist_plotlist_1_m, ncol = 3, nrow = 2)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Incidence/Incidence_from_birth/tumor_cat_PTV_tumor_cat_1_male.png", width = 170, height = 70, units = "cm", dpi = 300, limitsize = F)

```


##Hist cat 2
```{r}

ukb_data_cancer$hist_tumor_cat[is.na(ukb_data_cancer$hist_tumor_cat)] = "No_cancer"
hist_cat = unique(ukb_data_cancer$hist_tumor_cat)
hist_cat = hist_cat[hist_cat != "No_cancer"]

spec_hist_plotlist_2_f = lapply(X = hist_cat, FUN = function(x){
  tempdf_x = subset(ukb_data_cancer, hist_tumor_cat == x)
  tempdf_x$PTV_hist_type_2 = as.character(tempdf_x$PTV_hist_type_2)
  tempdf_x = dplyr::arrange(tempdf_x, diag_date)
  l = sort(unique(tempdf_x$PTV_hist_type_2))
  cp = unique(sort(unlist(sapply(X = l, FUN = function(y)  sapply(X = strsplit(y, ",")[[1]], FUN = function(x) as.numeric(str_extract(x, "\\d+")))))))
  tempdf_no_x = subset(ukb_data_cancer, hist_tumor_cat == "No_cancer")
  tempdf_no_x$PTV_hist_type_2 = as.character(tempdf_no_x$PTV_hist_type_2)
  tempdf_no_x = tempdf_no_x[!duplicated(tempdf_no_x$eid), ]
  tempdf_no_x$PTV_hist_type_2 = cut(tempdf_no_x$PTV_burden, breaks = cp, include.lowest = T, right = T)
  tempdf_x = tempdf_x[!duplicated(tempdf_x$eid), ]
  unique_tempdf = rbind(tempdf_x, tempdf_no_x)
  unique_tempdf$PTV_hist_type_2 = cut(unique_tempdf$PTV_burden, breaks = cp, include.lowest = T, right = T)
  unique_tempdf = subset(ukb_data_cancer, gender == "female")
  unique_tempdf %<>% 
    mutate(time_in_days = case_when(
      hist_tumor_cat == x ~ diag_date - birthdate,
      death == T & is.na(diag_date) ~ date_of_death - birthdate,
      death == F & is.na(diag_date) ~ max(date_of_death, na.rm = T) - birthdate,
    ))
  unique_tempdf$event_indicator = ifelse(unique_tempdf$hist_tumor_cat == x, 1, 0)
  #unique_tempdf$PTV_hist_type_2 = factor(unique_tempdf$PTV_hist_type_2, ordered = T)
  fit = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_hist_type_2, data = unique_tempdf))
  args = list(fit = fit, title = paste0("Incidence Analysis for ", x, "\n(N=", nrow(tempdf_x), ")"), ylim = c(1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05, 1), pval = T, pval.coord = c(1, 1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05),legend = "none")
  pfit = do.call(ggsurvplot, args)
  tblA = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_hist_type_2, data = unique_tempdf), risk.table = T, tables.theme = clean_theme())$table
  grid.arrange(pfit$plot, tblA, layout_matrix = rbind(c(1, 1), c(1,1), c(2, 2)))
})

ggarrange(plotlist =  spec_hist_plotlist_2_f, ncol = 3, nrow = 2)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Incidence/Incidence_from_birth/tumor_cat_PTV_tumor_cat_2_female.png", width = 170, height = 70, units = "cm", dpi = 300, limitsize = F)

```


```{r}

ukb_data_cancer$hist_tumor_cat[is.na(ukb_data_cancer$hist_tumor_cat)] = "No_cancer"
hist_cat = unique(ukb_data_cancer$hist_tumor_cat)
hist_cat = hist_cat[hist_cat != "No_cancer"]

spec_hist_plotlist_2_m = lapply(X = hist_cat, FUN = function(x){
  tempdf_x = subset(ukb_data_cancer, hist_tumor_cat == x)
  tempdf_x$PTV_hist_type_2 = as.character(tempdf_x$PTV_hist_type_2)
  tempdf_x = dplyr::arrange(tempdf_x, diag_date)
  l = sort(unique(tempdf_x$PTV_hist_type_2))
  cp = unique(sort(unlist(sapply(X = l, FUN = function(y)  sapply(X = strsplit(y, ",")[[1]], FUN = function(x) as.numeric(str_extract(x, "\\d+")))))))
  tempdf_no_x = subset(ukb_data_cancer, hist_tumor_cat == "No_cancer")
  tempdf_no_x$PTV_hist_type_2 = as.character(tempdf_no_x$PTV_hist_type_2)
  tempdf_no_x = tempdf_no_x[!duplicated(tempdf_no_x$eid), ]
  tempdf_no_x$PTV_hist_type_2 = cut(tempdf_no_x$PTV_burden, breaks = cp, include.lowest = T, right = T)
  tempdf_x = tempdf_x[!duplicated(tempdf_x$eid), ]
  unique_tempdf = rbind(tempdf_x, tempdf_no_x)
  unique_tempdf$PTV_hist_type_2 = cut(unique_tempdf$PTV_burden, breaks = cp, include.lowest = T, right = T)
  unique_tempdf = subset(ukb_data_cancer, gender == "male")
  unique_tempdf %<>% 
    mutate(time_in_days = case_when(
      hist_tumor_cat == x ~ diag_date - birthdate,
      death == T & is.na(diag_date) ~ date_of_death - birthdate,
      death == F & is.na(diag_date) ~ max(date_of_death, na.rm = T) - birthdate,
    ))
  unique_tempdf$event_indicator = ifelse(unique_tempdf$hist_tumor_cat == x, 1, 0)
  #unique_tempdf$PTV_hist_type_2 = factor(unique_tempdf$PTV_hist_type_2, ordered = T)
  fit = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_hist_type_2, data = unique_tempdf))
  args = list(fit = fit, title = paste0("Incidence Analysis for ", x, "\n(N=", nrow(tempdf_x), ")"), ylim = c(1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05, 1), pval = T, pval.coord = c(1, 1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05),legend = "none")
  pfit = do.call(ggsurvplot, args)
  tblA = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_hist_type_2, data = unique_tempdf), risk.table = T, tables.theme = clean_theme())$table
  grid.arrange(pfit$plot, tblA, layout_matrix = rbind(c(1, 1), c(1,1), c(2, 2)))
})

ggarrange(plotlist =  spec_hist_plotlist_2_m, ncol = 3, nrow = 2)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Incidence/Incidence_from_birth/tumor_cat_PTV_tumor_cat_2_male.png", width = 170, height = 70, units = "cm", dpi = 300, limitsize = F)

```


##Hist cat 3
```{r}

ukb_data_cancer$hist_tumor_cat[is.na(ukb_data_cancer$hist_tumor_cat)] = "No_cancer"
hist_cat = unique(ukb_data_cancer$hist_tumor_cat)
hist_cat = hist_cat[hist_cat != "No_cancer"]

spec_hist_plotlist_3_f = lapply(X = hist_cat, FUN = function(x){
  tempdf_x = subset(ukb_data_cancer, hist_tumor_cat == x)
  tempdf_x$PTV_hist_type_3 = as.character(tempdf_x$PTV_hist_type_3)
  tempdf_x = dplyr::arrange(tempdf_x, diag_date)
  l = sort(unique(tempdf_x$PTV_hist_type_3))
  cp = unique(sort(unlist(sapply(X = l, FUN = function(y)  sapply(X = strsplit(y, ",")[[1]], FUN = function(x) as.numeric(str_extract(x, "\\d+")))))))
  tempdf_no_x = subset(ukb_data_cancer, hist_tumor_cat == "No_cancer")
  tempdf_no_x$PTV_hist_type_3 = as.character(tempdf_no_x$PTV_hist_type_3)
  tempdf_no_x = tempdf_no_x[!duplicated(tempdf_no_x$eid), ]
  tempdf_no_x$PTV_hist_type_3 = cut(tempdf_no_x$PTV_burden, breaks = cp, include.lowest = T, right = T)
  tempdf_x = tempdf_x[!duplicated(tempdf_x$eid), ]
  unique_tempdf = rbind(tempdf_x, tempdf_no_x)
  unique_tempdf$PTV_hist_type_3 = cut(unique_tempdf$PTV_burden, breaks = cp, include.lowest = T, right = T)
  unique_tempdf = subset(unique_tempdf, gender == "female")
  unique_tempdf %<>% 
    mutate(time_in_days = case_when(
      hist_tumor_cat == x ~ diag_date - birthdate,
      death == T & is.na(diag_date) ~ date_of_death - birthdate,
      death == F & is.na(diag_date) ~ max(date_of_death, na.rm = T) - birthdate,
    ))
  unique_tempdf$event_indicator = ifelse(unique_tempdf$hist_tumor_cat == x, 1, 0)
  #unique_tempdf$PTV_hist_type_3 = factor(unique_tempdf$PTV_hist_type_3, ordered = T)
  fit = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_hist_type_3, data = unique_tempdf))
  args = list(fit = fit, title = paste0("Incidence Analysis for ", x, "\n(N=", nrow(tempdf_x), ")"), ylim = c(1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05, 1), pval = T, pval.coord = c(1, 1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05),legend = "none")
  pfit = do.call(ggsurvplot, args)
  tblA = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_hist_type_3, data = unique_tempdf), risk.table = T, tables.theme = clean_theme())$table
  grid.arrange(pfit$plot, tblA, layout_matrix = rbind(c(1, 1), c(1,1), c(2, 2)))
})

ggarrange(plotlist =  spec_hist_plotlist_3_f, ncol = 3, nrow = 2)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Incidence/Incidence_from_birth/tumor_cat_PTV_tumor_cat_3_female.png", width = 170, height = 70, units = "cm", dpi = 300, limitsize = F)

```


```{r}

ukb_data_cancer$hist_tumor_cat[is.na(ukb_data_cancer$hist_tumor_cat)] = "No_cancer"
hist_cat = unique(ukb_data_cancer$hist_tumor_cat)
hist_cat = hist_cat[hist_cat != "No_cancer"]

spec_hist_plotlist_3_m = lapply(X = hist_cat, FUN = function(x){
  tempdf_x = subset(ukb_data_cancer, hist_tumor_cat == x)
  tempdf_x$PTV_hist_type_3 = as.character(tempdf_x$PTV_hist_type_3)
  tempdf_x = dplyr::arrange(tempdf_x, diag_date)
  l = sort(unique(tempdf_x$PTV_hist_type_3))
  cp = unique(sort(unlist(sapply(X = l, FUN = function(y)  sapply(X = strsplit(y, ",")[[1]], FUN = function(x) as.numeric(str_extract(x, "\\d+")))))))
  tempdf_no_x = subset(ukb_data_cancer, hist_tumor_cat == "No_cancer")
  tempdf_no_x$PTV_hist_type_3 = as.character(tempdf_no_x$PTV_hist_type_3)
  tempdf_no_x = tempdf_no_x[!duplicated(tempdf_no_x$eid), ]
  tempdf_no_x$PTV_hist_type_3 = cut(tempdf_no_x$PTV_burden, breaks = cp, include.lowest = T, right = T)
  tempdf_x = tempdf_x[!duplicated(tempdf_x$eid), ]
  unique_tempdf = rbind(tempdf_x, tempdf_no_x)
  unique_tempdf$PTV_hist_type_3 = cut(unique_tempdf$PTV_burden, breaks = cp, include.lowest = T, right = T)
  unique_tempdf = subset(unique_tempdf, gender == "male")
  unique_tempdf %<>% 
    mutate(time_in_days = case_when(
      hist_tumor_cat == x ~ diag_date - birthdate,
      death == T & is.na(diag_date) ~ date_of_death - birthdate,
      death == F & is.na(diag_date) ~ max(date_of_death, na.rm = T) - birthdate,
    ))
  unique_tempdf$event_indicator = ifelse(unique_tempdf$hist_tumor_cat == x, 1, 0)
  #unique_tempdf$PTV_hist_type_3 = factor(unique_tempdf$PTV_hist_type_3, ordered = T)
  fit = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_hist_type_3, data = unique_tempdf))
  args = list(fit = fit, title = paste0("Incidence Analysis for ", x, "\n(N=", nrow(tempdf_x), ")"), ylim = c(1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05, 1), pval = T, pval.coord = c(1, 1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05),legend = "none")
  pfit = do.call(ggsurvplot, args)
  tblA = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_hist_type_3, data = unique_tempdf), risk.table = T, tables.theme = clean_theme())$table
  grid.arrange(pfit$plot, tblA, layout_matrix = rbind(c(1, 1), c(1,1), c(2, 2)))
})

ggarrange(plotlist =  spec_hist_plotlist_3_m, ncol = 3, nrow = 2)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Incidence/Incidence_from_birth/tumor_cat_PTV_tumor_cat_3_male.png", width = 170, height = 70, units = "cm", dpi = 300, limitsize = F)

```


##Cancer type universal 1
```{r}

ukb_data_cancer$cancer_type[is.na(ukb_data_cancer$cancer_type)] = "No_cancer"
ukb_data_cancer$gender = ifelse(ukb_data_cancer$sex == 0, "female", "male")
tumors = unique(ukb_data_cancer$cancer_type)
tumors = tumors[tumors != "No_cancer"]
tumors = tumors[tumors != "Hydatidiform_mole"]

uni_can_plotlist_1_f = lapply(X = tumors, FUN = function(x){
  tempdf_x = subset(ukb_data_cancer, cancer_type == x)
  tempdf_x = dplyr::arrange(tempdf_x, diag_date)
  tempdf_no_x = subset(ukb_data_cancer, cancer_type == "No_cancer")
  tempdf_no_x = tempdf_no_x[!duplicated(tempdf_no_x$eid), ]
  tempdf_x = tempdf_x[!duplicated(tempdf_x$eid), ]
  unique_tempdf = rbind(tempdf_x, tempdf_no_x)
  unique_tempdf = subset(unique_tempdf, gender == "female")
  unique_tempdf %<>% 
    mutate(time_in_days = case_when(
      cancer_type == x ~ diag_date - birthdate,
      death == T & is.na(diag_date) ~ date_of_death - birthdate,
      death == F & is.na(diag_date) ~ max(date_of_death, na.rm = T) - birthdate,
    ))
  unique_tempdf$event_indicator = ifelse(unique_tempdf$cancer_type == x, 1, 0)
  #unique_tempdf$PTV_universal_1 = factor(unique_tempdf$PTV_universal_1, ordered = T)
  fit = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_universal_1, data = unique_tempdf))
  args = list(fit = fit, title = paste0("Incidence Analysis for ", x, "\n(N=", nrow(tempdf_x), ")"), ylim = c(1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05, 1), pval = T, pval.coord = c(1, 1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05),legend = "none")
  pfit = do.call(ggsurvplot, args)
  tblA = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_universal_1, data = unique_tempdf), risk.table = T, tables.theme = clean_theme())$table
  grid.arrange(pfit$plot, tblA, layout_matrix = rbind(c(1, 1), c(1,1), c(2, 2)))
})

ggarrange(plotlist =  uni_can_plotlist_1_f, ncol = 6, nrow = 5)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Incidence/Incidence_from_birth/cancer_type_PTV_universal_1_female.png", width = 170, height = 70, units = "cm", dpi = 300, limitsize = F)

```


```{r}

ukb_data_cancer$cancer_type[is.na(ukb_data_cancer$cancer_type)] = "No_cancer"
ukb_data_cancer$gender = ifelse(ukb_data_cancer$sex == 0, "female", "male")
tumors = unique(ukb_data_cancer$cancer_type)
tumors = tumors[tumors != "No_cancer"]
tumors = tumors[tumors != "Hydatidiform_mole"]

uni_can_plotlist_1_m = lapply(X = tumors, FUN = function(x){
  tempdf_x = subset(ukb_data_cancer, cancer_type == x)
  tempdf_x = dplyr::arrange(tempdf_x, diag_date)
  tempdf_no_x = subset(ukb_data_cancer, cancer_type == "No_cancer")
  tempdf_no_x = tempdf_no_x[!duplicated(tempdf_no_x$eid), ]
  tempdf_x = tempdf_x[!duplicated(tempdf_x$eid), ]
  unique_tempdf = rbind(tempdf_x, tempdf_no_x)
  unique_tempdf = subset(unique_tempdf, gender == "male")
  unique_tempdf %<>% 
    mutate(time_in_days = case_when(
      cancer_type == x ~ diag_date - birthdate,
      death == T & is.na(diag_date) ~ date_of_death - birthdate,
      death == F & is.na(diag_date) ~ max(date_of_death, na.rm = T) - birthdate,
    ))
  unique_tempdf$event_indicator = ifelse(unique_tempdf$cancer_type == x, 1, 0)
  #unique_tempdf$PTV_universal_1 = factor(unique_tempdf$PTV_universal_1, ordered = T)
  fit = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_universal_1, data = unique_tempdf))
  args = list(fit = fit, title = paste0("Incidence Analysis for ", x, "\n(N=", nrow(tempdf_x), ")"), ylim = c(1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05, 1), pval = T, pval.coord = c(1, 1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05),legend = "none")
  pfit = do.call(ggsurvplot, args)
  tblA = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_universal_1, data = unique_tempdf), risk.table = T, tables.theme = clean_theme())$table
  grid.arrange(pfit$plot, tblA, layout_matrix = rbind(c(1, 1), c(1,1), c(2, 2)))
})

ggarrange(plotlist =  uni_can_plotlist_1_m, ncol = 6, nrow = 5)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Incidence/Incidence_from_birth/cancer_type_PTV_universal_1_male.png", width = 170, height = 70, units = "cm", dpi = 300, limitsize = F)

```


##Cancer type universal 2
```{r}

ukb_data_cancer$cancer_type[is.na(ukb_data_cancer$cancer_type)] = "No_cancer"
ukb_data_cancer$gender = ifelse(ukb_data_cancer$sex == 0, "female", "male")
tumors = unique(ukb_data_cancer$cancer_type)
tumors = tumors[tumors != "No_cancer"]
tumors = tumors[tumors != "Hydatidiform_mole"]

uni_can_plotlist_2_f = lapply(X = tumors, FUN = function(x){
  tempdf_x = subset(ukb_data_cancer, cancer_type == x)
  tempdf_x = dplyr::arrange(tempdf_x, diag_date)
  tempdf_no_x = subset(ukb_data_cancer, cancer_type == "No_cancer")
  tempdf_no_x = tempdf_no_x[!duplicated(tempdf_no_x$eid), ]
  tempdf_x = tempdf_x[!duplicated(tempdf_x$eid), ]
  unique_tempdf = rbind(tempdf_x, tempdf_no_x)
  unique_tempdf = subset(unique_tempdf, gender == "female")
  unique_tempdf %<>% 
    mutate(time_in_days = case_when(
      cancer_type == x ~ diag_date - birthdate,
      death == T & is.na(diag_date) ~ date_of_death - birthdate,
      death == F & is.na(diag_date) ~ max(date_of_death, na.rm = T) - birthdate,
    ))
  unique_tempdf$event_indicator = ifelse(unique_tempdf$cancer_type == x, 1, 0)
  #unique_tempdf$PTV_universal_2 = factor(unique_tempdf$PTV_universal_2, ordered = T)
  fit = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_universal_2, data = unique_tempdf))
  args = list(fit = fit, title = paste0("Incidence Analysis for ", x, "\n(N=", nrow(tempdf_x), ")"), ylim = c(1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05, 1), pval = T, pval.coord = c(1, 1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05),legend = "none")
  pfit = do.call(ggsurvplot, args)
  tblA = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_universal_2, data = unique_tempdf), risk.table = T, tables.theme = clean_theme())$table
  grid.arrange(pfit$plot, tblA, layout_matrix = rbind(c(1, 1), c(1,1), c(2, 2)))
})

ggarrange(plotlist =  uni_can_plotlist_2_f, ncol = 6, nrow = 5)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Incidence/Incidence_from_birth/cancer_type_PTV_universal_2_female.png", width = 170, height = 70, units = "cm", dpi = 300, limitsize = F)

```


```{r}

ukb_data_cancer$cancer_type[is.na(ukb_data_cancer$cancer_type)] = "No_cancer"
ukb_data_cancer$gender = ifelse(ukb_data_cancer$sex == 0, "female", "male")
tumors = unique(ukb_data_cancer$cancer_type)
tumors = tumors[tumors != "No_cancer"]
tumors = tumors[tumors != "Hydatidiform_mole"]

uni_can_plotlist_2_m = lapply(X = tumors, FUN = function(x){
  tempdf_x = subset(ukb_data_cancer, cancer_type == x)
  tempdf_x = dplyr::arrange(tempdf_x, diag_date)
  tempdf_no_x = subset(ukb_data_cancer, cancer_type == "No_cancer")
  tempdf_no_x = tempdf_no_x[!duplicated(tempdf_no_x$eid), ]
  tempdf_x = tempdf_x[!duplicated(tempdf_x$eid), ]
  unique_tempdf = rbind(tempdf_x, tempdf_no_x)
  unique_tempdf = subset(unique_tempdf, gender == "male")
  unique_tempdf %<>% 
    mutate(time_in_days = case_when(
      cancer_type == x ~ diag_date - birthdate,
      death == T & is.na(diag_date) ~ date_of_death - birthdate,
      death == F & is.na(diag_date) ~ max(date_of_death, na.rm = T) - birthdate,
    ))
  unique_tempdf$event_indicator = ifelse(unique_tempdf$cancer_type == x, 1, 0)
  #unique_tempdf$PTV_universal_2 = factor(unique_tempdf$PTV_universal_2, ordered = T)
  fit = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_universal_2, data = unique_tempdf))
  args = list(fit = fit, title = paste0("Incidence Analysis for ", x, "\n(N=", nrow(tempdf_x), ")"), ylim = c(1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05, 1), pval = T, pval.coord = c(1, 1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05),legend = "none")
  pfit = do.call(ggsurvplot, args)
  tblA = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_universal_2, data = unique_tempdf), risk.table = T, tables.theme = clean_theme())$table
  grid.arrange(pfit$plot, tblA, layout_matrix = rbind(c(1, 1), c(1,1), c(2, 2)))
})

ggarrange(plotlist =  uni_can_plotlist_2_m, ncol = 6, nrow = 5)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Incidence/Incidence_from_birth/cancer_type_PTV_universal_2_male.png", width = 170, height = 70, units = "cm", dpi = 300, limitsize = F)

```

##Universal 3
```{r}

ukb_data_cancer$cancer_type[is.na(ukb_data_cancer$cancer_type)] = "No_cancer"
ukb_data_cancer$gender = ifelse(ukb_data_cancer$sex == 0, "female", "male")
tumors = unique(ukb_data_cancer$cancer_type)
tumors = tumors[tumors != "No_cancer"]
tumors = tumors[tumors != "Hydatidiform_mole"]

uni_can_plotlist_3_f = lapply(X = tumors, FUN = function(x){
  tempdf_x = subset(ukb_data_cancer, cancer_type == x)
  tempdf_x = dplyr::arrange(tempdf_x, diag_date)
  tempdf_no_x = subset(ukb_data_cancer, cancer_type == "No_cancer")
  tempdf_no_x = tempdf_no_x[!duplicated(tempdf_no_x$eid), ]
  tempdf_x = tempdf_x[!duplicated(tempdf_x$eid), ]
  unique_tempdf = rbind(tempdf_x, tempdf_no_x)
  unique_tempdf = subset(unique_tempdf, gender == "female")
  unique_tempdf %<>% 
    mutate(time_in_days = case_when(
      cancer_type == x ~ diag_date - birthdate,
      death == T & is.na(diag_date) ~ date_of_death - birthdate,
      death == F & is.na(diag_date) ~ max(date_of_death, na.rm = T) - birthdate,
    ))
  unique_tempdf$event_indicator = ifelse(unique_tempdf$cancer_type == x, 1, 0)
  #unique_tempdf$PTV_universal_3 = factor(unique_tempdf$PTV_universal_3, ordered = T)
  fit = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_universal_3, data = unique_tempdf))
  args = list(fit = fit, title = paste0("Incidence Analysis for ", x, "\n(N=", nrow(tempdf_x), ")"), ylim = c(1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05, 1), pval = T, pval.coord = c(1, 1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05),legend = "none")
  pfit = do.call(ggsurvplot, args)
  tblA = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_universal_3, data = unique_tempdf), risk.table = T, tables.theme = clean_theme())$table
  grid.arrange(pfit$plot, tblA, layout_matrix = rbind(c(1, 1), c(1,1), c(2, 2)))
})

ggarrange(plotlist =  uni_can_plotlist_3_f, ncol = 6, nrow = 5)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Incidence/Incidence_from_birth/cancer_type_PTV_universal_3_female.png", width = 170, height = 70, units = "cm", dpi = 300, limitsize = F)

```


```{r}

ukb_data_cancer$cancer_type[is.na(ukb_data_cancer$cancer_type)] = "No_cancer"
ukb_data_cancer$gender = ifelse(ukb_data_cancer$sex == 0, "female", "male")
tumors = unique(ukb_data_cancer$cancer_type)
tumors = tumors[tumors != "No_cancer"]
tumors = tumors[tumors != "Hydatidiform_mole"]

uni_can_plotlist_3_m = lapply(X = tumors, FUN = function(x){
  tempdf_x = subset(ukb_data_cancer, cancer_type == x)
  tempdf_x = dplyr::arrange(tempdf_x, diag_date)
  tempdf_no_x = subset(ukb_data_cancer, cancer_type == "No_cancer")
  tempdf_no_x = tempdf_no_x[!duplicated(tempdf_no_x$eid), ]
  tempdf_x = tempdf_x[!duplicated(tempdf_x$eid), ]
  unique_tempdf = rbind(tempdf_x, tempdf_no_x)
  unique_tempdf = subset(unique_tempdf, gender == "male")
  unique_tempdf %<>% 
    mutate(time_in_days = case_when(
      cancer_type == x ~ diag_date - birthdate,
      death == T & is.na(diag_date) ~ date_of_death - birthdate,
      death == F & is.na(diag_date) ~ max(date_of_death, na.rm = T) - birthdate,
    ))
  unique_tempdf$event_indicator = ifelse(unique_tempdf$cancer_type == x, 1, 0)
  #unique_tempdf$PTV_universal_3 = factor(unique_tempdf$PTV_universal_3, ordered = T)
  fit = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_universal_3, data = unique_tempdf))
  args = list(fit = fit, title = paste0("Incidence Analysis for ", x, "\n(N=", nrow(tempdf_x), ")"), ylim = c(1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05, 1), pval = T, pval.coord = c(1, 1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05),legend = "none")
  pfit = do.call(ggsurvplot, args)
  tblA = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_universal_3, data = unique_tempdf), risk.table = T, tables.theme = clean_theme())$table
  grid.arrange(pfit$plot, tblA, layout_matrix = rbind(c(1, 1), c(1,1), c(2, 2)))
})

ggarrange(plotlist =  uni_can_plotlist_3_m, ncol = 6, nrow = 5)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Incidence/Incidence_from_birth/cancer_type_PTV_universal_3_male.png", width = 170, height = 70, units = "cm", dpi = 300, limitsize = F)

```


##Cancer type cancer spec 1
```{r}
ukb_data_cancer$cancer_type[is.na(ukb_data_cancer$cancer_type)] = "No_cancer"
ukb_data_cancer$gender = ifelse(ukb_data_cancer$sex == 0, "female", "male")
tumors = unique(ukb_data_cancer$cancer_type)
tumors = tumors[tumors != "No_cancer"]
tumors = tumors[tumors != "Hydatidiform_mole"]

spec_can_plotlist_1_f = lapply(X = tumors, FUN = function(x){
  tempdf_x = subset(ukb_data_cancer, cancer_type == x)
  tempdf_x$PTV_cancer_type_1 = as.character(tempdf_x$PTV_cancer_type_1)
  tempdf_x = dplyr::arrange(tempdf_x, diag_date)
  l = sort(unique(tempdf_x$PTV_cancer_type_1))
  cp = unique(sort(unlist(sapply(X = l, FUN = function(y)  sapply(X = strsplit(y, ",")[[1]], FUN = function(x) as.numeric(str_extract(x, "\\d+")))))))
  tempdf_no_x = subset(ukb_data_cancer, cancer_type == "No_cancer")
  tempdf_no_x$PTV_cancer_type_1 = as.character(tempdf_no_x$PTV_cancer_type_1)
  tempdf_no_x = tempdf_no_x[!duplicated(tempdf_no_x$eid), ]
  tempdf_no_x$PTV_cancer_type_1 = cut(tempdf_no_x$PTV_burden, breaks = cp, include.lowest = T, right = T)
  tempdf_x = tempdf_x[!duplicated(tempdf_x$eid), ]
  unique_tempdf = rbind(tempdf_x, tempdf_no_x)
  unique_tempdf$PTV_cancer_type_1 = cut(unique_tempdf$PTV_burden, breaks = cp, include.lowest = T, right = T)
  unique_tempdf = subset(unique_tempdf, gender == "female")
  unique_tempdf %<>% 
    mutate(time_in_days = case_when(
      cancer_type == x ~ diag_date - birthdate,
      death == T & is.na(diag_date) ~ date_of_death - birthdate,
      death == F & is.na(diag_date) ~ max(date_of_death, na.rm = T) - birthdate,
    ))
  unique_tempdf$event_indicator = ifelse(unique_tempdf$cancer_type == x, 1, 0)
  #unique_tempdf$PTV_cancer_type_1 = factor(unique_tempdf$PTV_cancer_type_1, ordered = T)
  fit = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_cancer_type_1, data = unique_tempdf))
  args = list(fit = fit, title = paste0("Incidence Analysis for ", x, "\n(N=", nrow(tempdf_x), ")"), ylim = c(1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05, 1), pval = T, pval.coord = c(1, 1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05),legend = "none")
  pfit = do.call(ggsurvplot, args)
  tblA = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_cancer_type_1, data = unique_tempdf), risk.table = T, tables.theme = clean_theme())$table
  grid.arrange(pfit$plot, tblA, layout_matrix = rbind(c(1, 1), c(1,1), c(2, 2)))
})

ggarrange(plotlist =  spec_can_plotlist_1_f, ncol = 6, nrow = 5)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Incidence/Incidence_from_birth/cancer_type_PTV_cancer_type_1_female.png", width = 170, height = 70, units = "cm", dpi = 300, limitsize = F)

```


```{r}

ukb_data_cancer$cancer_type[is.na(ukb_data_cancer$cancer_type)] = "No_cancer"
ukb_data_cancer$gender = ifelse(ukb_data_cancer$sex == 0, "female", "male")
tumors = unique(ukb_data_cancer$cancer_type)
tumors = tumors[tumors != "No_cancer"]
tumors = tumors[tumors != "Hydatidiform_mole"]

spec_can_plotlist_1_m = lapply(X = tumors, FUN = function(x){
  tempdf_x = subset(ukb_data_cancer, cancer_type == x)
  tempdf_x$PTV_cancer_type_1 = as.character(tempdf_x$PTV_cancer_type_1)
  tempdf_x = dplyr::arrange(tempdf_x, diag_date)
  l = sort(unique(tempdf_x$PTV_cancer_type_1))
  cp = unique(sort(unlist(sapply(X = l, FUN = function(y)  sapply(X = strsplit(y, ",")[[1]], FUN = function(x) as.numeric(str_extract(x, "\\d+")))))))
  tempdf_no_x = subset(ukb_data_cancer, cancer_type == "No_cancer")
  tempdf_no_x$PTV_cancer_type_1 = as.character(tempdf_no_x$PTV_cancer_type_1)
  tempdf_no_x = tempdf_no_x[!duplicated(tempdf_no_x$eid), ]
  tempdf_no_x$PTV_cancer_type_1 = cut(tempdf_no_x$PTV_burden, breaks = cp, include.lowest = T, right = T)
  tempdf_x = tempdf_x[!duplicated(tempdf_x$eid), ]
  unique_tempdf = rbind(tempdf_x, tempdf_no_x)
  unique_tempdf$PTV_cancer_type_1 = cut(unique_tempdf$PTV_burden, breaks = cp, include.lowest = T, right = T)
  unique_tempdf = subset(unique_tempdf, gender == "male")
  unique_tempdf %<>% 
    mutate(time_in_days = case_when(
      cancer_type == x ~ diag_date - birthdate,
      death == T & is.na(diag_date) ~ date_of_death - birthdate,
      death == F & is.na(diag_date) ~ max(date_of_death, na.rm = T) - birthdate,
    ))
  unique_tempdf$event_indicator = ifelse(unique_tempdf$cancer_type == x, 1, 0)
  #unique_tempdf$PTV_cancer_type_1 = factor(unique_tempdf$PTV_cancer_type_1, ordered = T)
  fit = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_cancer_type_1, data = unique_tempdf))
  args = list(fit = fit, title = paste0("Incidence Analysis for ", x, "\n(N=", nrow(tempdf_x), ")"), ylim = c(1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05, 1), pval = T, pval.coord = c(1, 1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05),legend = "none")
  pfit = do.call(ggsurvplot, args)
  tblA = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_cancer_type_1, data = unique_tempdf), risk.table = T, tables.theme = clean_theme())$table
  grid.arrange(pfit$plot, tblA, layout_matrix = rbind(c(1, 1), c(1,1), c(2, 2)))
})

ggarrange(plotlist =  spec_can_plotlist_1_m, ncol = 6, nrow = 5)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Incidence/Incidence_from_birth/cancer_type_PTV_cancer_type_1_male.png", width = 170, height = 70, units = "cm", dpi = 300, limitsize = F)

```


##Cancer type cancer spec 2
```{r}
ukb_data_cancer$cancer_type[is.na(ukb_data_cancer$cancer_type)] = "No_cancer"
ukb_data_cancer$gender = ifelse(ukb_data_cancer$sex == 0, "female", "male")
tumors = unique(ukb_data_cancer$cancer_type)
tumors = tumors[tumors != "No_cancer"]
tumors = tumors[tumors != "Hydatidiform_mole"]

spec_can_plotlist_2_f = lapply(X = tumors, FUN = function(x){
  tempdf_x = subset(ukb_data_cancer, cancer_type == x)
  tempdf_x$PTV_cancer_type_2 = as.character(tempdf_x$PTV_cancer_type_2)
  tempdf_x = dplyr::arrange(tempdf_x, diag_date)
  l = sort(unique(tempdf_x$PTV_cancer_type_2))
  cp = unique(sort(unlist(sapply(X = l, FUN = function(y)  sapply(X = strsplit(y, ",")[[1]], FUN = function(x) as.numeric(str_extract(x, "\\d+")))))))
  tempdf_no_x = subset(ukb_data_cancer, cancer_type == "No_cancer")
  tempdf_no_x$PTV_cancer_type_2 = as.character(tempdf_no_x$PTV_cancer_type_2)
  tempdf_no_x = tempdf_no_x[!duplicated(tempdf_no_x$eid), ]
  tempdf_no_x$PTV_cancer_type_2 = cut(tempdf_no_x$PTV_burden, breaks = cp, include.lowest = T, right = T)
  tempdf_x = tempdf_x[!duplicated(tempdf_x$eid), ]
  unique_tempdf = rbind(tempdf_x, tempdf_no_x)
  unique_tempdf$PTV_cancer_type_2 = cut(unique_tempdf$PTV_burden, breaks = cp, include.lowest = T, right = T)
  unique_tempdf = subset(ukb_data_cancer, gender == "female")
  unique_tempdf %<>% 
    mutate(time_in_days = case_when(
      cancer_type == x ~ diag_date - birthdate,
      death == T & is.na(diag_date) ~ date_of_death - birthdate,
      death == F & is.na(diag_date) ~ max(date_of_death, na.rm = T) - birthdate,
    ))
  unique_tempdf$event_indicator = ifelse(unique_tempdf$cancer_type == x, 1, 0)
  #unique_tempdf$PTV_cancer_type_2 = factor(unique_tempdf$PTV_cancer_type_2, ordered = T)
  fit = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_cancer_type_2, data = unique_tempdf))
  args = list(fit = fit, title = paste0("Incidence Analysis for ", x, "\n(N=", nrow(tempdf_x), ")"), ylim = c(1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05, 1), pval = T, pval.coord = c(1, 1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05),legend = "none")
  pfit = do.call(ggsurvplot, args)
  tblA = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_cancer_type_2, data = unique_tempdf), risk.table = T, tables.theme = clean_theme())$table
  grid.arrange(pfit$plot, tblA, layout_matrix = rbind(c(1, 1), c(1,1), c(2, 2)))
})

ggarrange(plotlist =  spec_can_plotlist_2_f, ncol = 6, nrow = 5)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Incidence/Incidence_from_birth/cancer_type_PTV_cancer_type_2_female.png", width = 170, height = 70, units = "cm", dpi = 300, limitsize = F)


```


```{r}

ukb_data_cancer$cancer_type[is.na(ukb_data_cancer$cancer_type)] = "No_cancer"
ukb_data_cancer$gender = ifelse(ukb_data_cancer$sex == 0, "female", "male")
tumors = unique(ukb_data_cancer$cancer_type)
tumors = tumors[tumors != "No_cancer"]
tumors = tumors[tumors != "Hydatidiform_mole"]

spec_can_plotlist_2_m = lapply(X = tumors, FUN = function(x){
  tempdf_x = subset(ukb_data_cancer, cancer_type == x)
  tempdf_x$PTV_cancer_type_2 = as.character(tempdf_x$PTV_cancer_type_2)
  tempdf_x = dplyr::arrange(tempdf_x, diag_date)
  l = sort(unique(tempdf_x$PTV_cancer_type_2))
  cp = unique(sort(unlist(sapply(X = l, FUN = function(y)  sapply(X = strsplit(y, ",")[[1]], FUN = function(x) as.numeric(str_extract(x, "\\d+")))))))
  tempdf_no_x = subset(ukb_data_cancer, cancer_type == "No_cancer")
  tempdf_no_x$PTV_cancer_type_2 = as.character(tempdf_no_x$PTV_cancer_type_2)
  tempdf_no_x = tempdf_no_x[!duplicated(tempdf_no_x$eid), ]
  tempdf_no_x$PTV_cancer_type_2 = cut(tempdf_no_x$PTV_burden, breaks = cp, include.lowest = T, right = T)
  tempdf_x = tempdf_x[!duplicated(tempdf_x$eid), ]
  unique_tempdf = rbind(tempdf_x, tempdf_no_x)
  unique_tempdf$PTV_cancer_type_2 = cut(unique_tempdf$PTV_burden, breaks = cp, include.lowest = T, right = T)
  unique_tempdf = subset(ukb_data_cancer, gender == "male")
  unique_tempdf %<>% 
    mutate(time_in_days = case_when(
      cancer_type == x ~ diag_date - birthdate,
      death == T & is.na(diag_date) ~ date_of_death - birthdate,
      death == F & is.na(diag_date) ~ max(date_of_death, na.rm = T) - birthdate,
    ))
  unique_tempdf$event_indicator = ifelse(unique_tempdf$cancer_type == x, 1, 0)
  #unique_tempdf$PTV_cancer_type_2 = factor(unique_tempdf$PTV_cancer_type_2, ordered = T)
  fit = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_cancer_type_2, data = unique_tempdf))
  args = list(fit = fit, title = paste0("Incidence Analysis for ", x, "\n(N=", nrow(tempdf_x), ")"), ylim = c(1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05, 1), pval = T, pval.coord = c(1, 1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05),legend = "none")
  pfit = do.call(ggsurvplot, args)
  tblA = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_cancer_type_2, data = unique_tempdf), risk.table = T, tables.theme = clean_theme())$table
  grid.arrange(pfit$plot, tblA, layout_matrix = rbind(c(1, 1), c(1,1), c(2, 2)))
})

ggarrange(plotlist =  spec_can_plotlist_2_m, ncol = 6, nrow = 5)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Incidence/Incidence_from_birth/cancer_type_PTV_cancer_type_2_male.png", width = 170, height = 70, units = "cm", dpi = 300, limitsize = F)

```


##Cancer type 3
```{r}
ukb_data_cancer$cancer_type[is.na(ukb_data_cancer$cancer_type)] = "No_cancer"
tumors = unique(ukb_data_cancer$cancer_type)
tumors = tumors[tumors != "No_cancer"]
tumors = tumors[tumors != "Hydatidiform_mole"]

plotlist_PTV3 = lapply(X = tumors, FUN = function(x){
  tempdf_x = subset(ukb_data_cancer, cancer_type == x)
  tempdf_x$PTV_cancer_type_3 = as.character(tempdf_x$PTV_cancer_type_3)
  tempdf_x = dplyr::arrange(tempdf_x, diag_date)
  l = sort(unique(tempdf_x$PTV_cancer_type_3))
  cp = unique(sort(unlist(sapply(X = l, FUN = function(y)  sapply(X = strsplit(y, ",")[[1]], FUN = function(x) as.numeric(str_extract(x, "\\d+")))))))
  tempdf_no_x = subset(ukb_data_cancer, cancer_type == "No_cancer")
  tempdf_no_x$PTV_cancer_type_3 = as.character(tempdf_no_x$PTV_cancer_type_3)
  tempdf_no_x = tempdf_no_x[!duplicated(tempdf_no_x$eid), ]
  tempdf_no_x$PTV_cancer_type_3 = cut(tempdf_no_x$PTV_burden, breaks = cp, include.lowest = T, right = T)
  tempdf_x = tempdf_x[!duplicated(tempdf_x$eid), ]
  unique_tempdf = rbind(tempdf_x, tempdf_no_x)
  unique_tempdf$PTV_cancer_type_3 = cut(unique_tempdf$PTV_burden, breaks = cp, include.lowest = T, right = T)
  unique_tempdf %<>% 
    mutate(time_in_days = case_when(
      cancer_type == x ~ diag_date - birthdate,
      death == T & is.na(diag_date) ~ date_of_death - birthdate,
      death == F & is.na(diag_date) ~ max(date_of_death, na.rm = T) - birthdate,
    ))
  unique_tempdf$event_indicator = ifelse(unique_tempdf$cancer_type == x, 1, 0)
  #unique_tempdf$PTV_cancer_type_3 = factor(unique_tempdf$PTV_cancer_type_3, ordered = T)
  fit = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_cancer_type_3, data = unique_tempdf))
  args = list(fit = fit, title = paste0("Incidence Analysis for ", x, "\n(N=", nrow(tempdf_x), ")"), ylim = c(1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05, 1), pval = T, pval.coord = c(1, 1 - (nrow(tempdf_x) / nrow(unique_tempdf)) - (nrow(tempdf_x) / nrow(unique_tempdf)) * 0.05),legend = "none")
  pfit = do.call(ggsurvplot, args)
  tblA = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_cancer_type_3, data = unique_tempdf), risk.table = T, tables.theme = clean_theme())$table
  grid.arrange(pfit$plot, tblA, layout_matrix = rbind(c(1, 1), c(1,1), c(2, 2)))
})

ggarrange(plotlist =  plotlist_PTV3, ncol = 6, nrow = 5)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Incidence/Incidence_from_birth/cancer_type_PTV_cancer_type_3.png", width = 170, height = 70, units = "cm", dpi = 300, limitsize = F)

```


#Tumor categoris
```{r}

ukb_data_cancer$tumor_cat = as.factor(ukb_data_cancer$tumor_cat)
ukb_data_cancer$tumor_cat = fct_reorder(ukb_data_cancer$tumor_cat, ukb_data_cancer$PTV_burden, .fun = function(x){quantile(x, 0.25)})

PTV_tumor_box = ggplot(ukb_data_cancer, aes(x = tumor_cat, y = PTV_burden, color = tumor_cat)) +
  geom_violin() +
  geom_boxplot(notch = T, width = 0.3) + 
  labs(title = "Number of PTV burden in tumors", x = "Tumor categorie", y = "PTV") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
print(PTV_tumor_box)

ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/tumor_cat_PTV_box.jpg", plot = PTV_tumor_box, width = 60, height = 30, units = "cm", dpi = 300)


```


#PTV Box plot
```{r}

#ukb_data_cancer$PTV_burden = as.integer(ukb_data_cancer$PTV_burden)
ukb_data_cancer$cancer_type = as.factor(ukb_data_cancer$cancer_type)
ukb_data_cancer$cancer_type = fct_reorder(ukb_data_cancer$cancer_type, ukb_data_cancer$PTV_burden, .fun = function(x){quantile(x, 0.25)})

PTV_tumor_box = ggplot(ukb_data_cancer, aes(x = cancer_type, y = PTV_burden, color = cancer_type)) +
  geom_violin() +
  geom_boxplot(notch = T, width = 0.3) + 
  labs(title = "Number of PTV burden in tumors", x = "Tumor", y = "PTV") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
print(PTV_tumor_box)

ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/new_PTV_tumor_box.jpg", plot = PTV_tumor_box, width = 60, height = 30, units = "cm", dpi = 300)

```

#PTV point
```{r}

PTV_tumor_point = ggplot(ukb_data_cancer, aes(x = cancer_type, y = PTV_burden, color = cancer_type)) +
  geom_point() + 
  labs(title = "Number of PTV burden in tumors", x = "Tumor", y = "PTV") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
print(PTV_tumor_box)

ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/new_PTV_tumor_point.jpg", plot = PTV_tumor_point, width = 60, height = 30, units = "cm", dpi = 300)

```

#PTV hist
```{r}
ukb_data_cancer$cancer_type[is.na(ukb_data_cancer$cancer_type)] = "No_cancer"

m = ukb_data_cancer %>% 
  filter(cancer_type == "No_cancer") %>% 
  pull(PTV_burden) %>% 
  median()

PTV_tumor_his_median = lapply(X = unique(ukb_data_cancer$cancer_type), FUN = function(x){
  temp_df = ukb_data_cancer %>% filter(cancer_type == x)
  ggplot(temp_df, aes(x = PTV_burden)) +
    geom_histogram(binwidth = 1, color = "black", fill = "skyblue", alpha = 0.6) + 
    labs(title = paste0("Number of PTV burden in ", x), x = "PTV", y = "Count") +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
    geom_vline(xintercept = m, linetype = "dashed") +
    geom_vline(xintercept = median(temp_df$PTV_burden), color = "red")
})

PTV_tumor_his_median = ggarrange(plotlist = PTV_tumor_his_median, ncol = 5, nrow = 6)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/PTV_tumor_hist_median.png", plot = PTV_tumor_his_median, width = 60, height = 30, units = "cm", dpi = 300)

```

#New PTV hist
```{r}
ukb_data_cancer$cancer_type[is.na(ukb_data_cancer$cancer_type)] = "No_cancer"

m = ukb_data_cancer %>% 
  filter(cancer_type == "No_cancer") %>% 
  pull(PTV_burden) %>% 
  median()

PTV_tumor_his_median = lapply(X = unique(ukb_data_cancer$cancer_type), FUN = function(x){
  temp_df = ukb_data_cancer %>% filter(cancer_type == x)
  ggplot(temp_df, aes(x = PTV_burden)) +
    geom_histogram(binwidth = 1, color = "black", fill = "skyblue", alpha = 0.6) + 
    labs(title = paste0("Number of PTV burden in ", x), x = "PTV", y = "Count") +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
    geom_vline(xintercept = m, linetype = "dashed") +
    geom_vline(xintercept = median(temp_df$PTV_burden), color = "red")
})

PTV_tumor_his_median = ggarrange(plotlist = PTV_tumor_his_median, ncol = 5, nrow = 6)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/update_PTV_tumor_hist_median.png", plot = PTV_tumor_his_median, width = 60, height = 30, units = "cm", dpi = 300)

```

#Tumor categiries hist
```{r}

  
m = ukb_data_cancer %>% 
  filter(hist_tumor_cat == "No_cancer") %>% 
  filter(!is.na(PTV_burden)) %>% 
  pull(PTV_burden) %>% 
  median()

PTV_tumor_his_median = lapply(X = unique(ukb_data_cancer$hist_tumor_cat), FUN = function(x){
  temp_df = ukb_data_cancer %>% filter(hist_tumor_cat == x)
  ggplot(temp_df, aes(x = PTV_burden)) +
    geom_histogram(binwidth = 1, color = "black", fill = "skyblue", alpha = 0.6) + 
    facet_wrap(facets = "gender") +
    labs(title = paste0("Number of PTV burden in ", x), x = "PTV", y = "Count") +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
    geom_vline(xintercept = m, linetype = "dashed") +
    geom_vline(xintercept = median(temp_df$PTV_burden), color = "red")
})

PTV_tumor_his_median = ggarrange(plotlist = PTV_tumor_his_median, ncol = 4, nrow = 2)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/tumor_cat_hist_median_gender.png", plot = PTV_tumor_his_median, width = 120, height = 60, units = "cm", dpi = 300)

```

#Tumor categories by histology
```{r}
#Files
load("C:/Users/bagil/Desktop/MyGit/ukb_tumor/objects/ukb_data_cancer_final")

m = ukb_data_cancer %>% 
  filter(hist_tumor_cat == "No_cancer") %>% 
  pull(PTV_burden) %>% 
  median()

PTV_tumor_his_median = lapply(X = unique(ukb_data_cancer$hist_tumor_cat), FUN = function(x){
  temp_df = ukb_data_cancer %>% filter(hist_tumor_cat == x)
  ggplot(temp_df, aes(x = PTV_burden)) +
    geom_histogram(binwidth = 1, color = "black", fill = "skyblue", alpha = 0.6) + 
    labs(title = paste0("Number of PTV burden in ", x), x = "PTV", y = "Count") +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
    geom_vline(xintercept = m, linetype = "dashed") +
    geom_vline(xintercept = median(temp_df$PTV_burden), color = "red")
})

PTV_tumor_his_median = ggarrange(plotlist = PTV_tumor_his_median, ncol = 4, nrow = 2)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/histology_tumor_cat_hist_median.png", plot = PTV_tumor_his_median, width = 80, height = 40, units = "cm", dpi = 300)

```

#Tumor cat by hist boxplot
```{r}

PTV_tumor_box = ggplot(ukb_data_cancer, aes(x = hist_tumor_cat, y = PTV_burden, color = hist_tumor_cat)) +
  geom_violin() +
  geom_boxplot(notch = T, width = 0.3) + 
  labs(title = "Number of PTV burden in tumors", x = "Tumor categories", y = "PTV") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
print(PTV_tumor_box)

ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/new_PTV_tumor_box_cat_by_histology.jpg", plot = PTV_tumor_box, width = 60, height = 30, units = "cm", dpi = 300)


```

