---
title: "Survival_analysis_cancer"
author: "Bagi Laura"
date: "2024-03-18"
output: html_document
---

#Libraries
```{r}
library(ggpubr)
library(fastmatch)
library(readxl)
library(forcats)
library(survival)
library(survminer)
library(grid)
library(gridExtra)
library(data.table)
library(caret)
library(tidyverse)
library(future.apply)
library(magrittr)
library(cowplot)
options(dplyr.summarise.inform = F)

```

#Files
```{r}
load("C:/Users/bagil/Desktop/MyGit/ukb_tumor/objects/cancer_data_final")
load("C:/Users/bagil/Desktop/ukb/objects/icd_mapping")
load("C:/Users/bagil/Desktop/MyGit/ukb_tumor/objects/ukb_data_cancer_final")

```


#Survival analysis for PTV burden group 5%
```{r}
cancer_surv_PTV1 = lapply(X = unique(icd_mapping$cancer_type), FUN = function(x){
  temp_can = subset(cancer_data, cancer_type == x)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can %<>% 
  mutate(time_in_days = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$cancer_type[is.na(temp_can$cancer_type)] = "No cancer"
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  temp_can$PTV_burden_group_5per = factor(temp_can$PTV_burden_group_5per, ordered = T)
  fit = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_burden_group_5per,data = temp_can))
  args = list(fit = fit, title = paste0("Survival Analysis for ", x, "\n(N=", nrow(temp_can), ")"), pval = T, legend = "none")
  pfit = do.call(ggsurvplot, args)
  tblA = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_burden_group_5per, data = temp_can), risk.table = T, tables.theme = clean_theme())$table
  grid.arrange(pfit$plot, tblA, layout_matrix = rbind(c(1, 1), c(1,1), c(2, 2)))
  })


ggarrange(plotlist =  cancer_surv_PTV1, ncol = 5, nrow = 5)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/new_PTV_burden_5per_surv_cancer.png", width = 100, height = 50, units = "cm", dpi = 300)


```

#Survival analysis for PTV burden group 10%
```{r}

cancer_surv_PTV2 = lapply(X = unique(icd_mapping$cancer_type), FUN = function(x){
  temp_can = subset(cancer_data, cancer_type == x)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can %<>% 
  mutate(time_in_days = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$cancer_type[is.na(temp_can$cancer_type)] = "No cancer"
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  temp_can$PTV_burden_group_10per = factor(temp_can$PTV_burden_group_10per, ordered = T)
  fit = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_burden_group_10per, data = temp_can))
  args = list(fit = fit, title = paste0("Survival Analysis for ", x, "\n(N=", nrow(temp_can), ")"), pval = T, legend = "none")
  pfit = do.call(ggsurvplot, args)
  tblA = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_burden_group_10per, data = temp_can), risk.table = T, tables.theme = clean_theme())$table
  grid.arrange(pfit$plot, tblA, layout_matrix = rbind(c(1, 1), c(1,1), c(2, 2)))
})

ggarrange(plotlist =  cancer_surv_PTV2, ncol = 5, nrow = 5)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/new_PTV_burden_10per_surv_cancer.png", width = 100, height = 50, units = "cm", dpi = 300)

```

#Survival analysis for PTV burden group 15%
```{r}

cancer_surv_PTV3 = lapply(X = unique(icd_mapping$cancer_type), FUN = function(x){
  temp_can = subset(cancer_data, cancer_type == x)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can %<>% 
  mutate(time_in_days = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$cancer_type[is.na(temp_can$cancer_type)] = "No cancer"
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  temp_can$PTV_burden_group_15per = factor(temp_can$PTV_burden_group_15per, ordered = T)
  fit = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_burden_group_15per, data = temp_can))
  args = list(fit = fit, title = paste0("Survival Analysis for ", x, "\n(N=", nrow(temp_can), ")"), pval = T, legend = "none")
  pfit = do.call(ggsurvplot, args)
  tblA = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_burden_group_15per, data = temp_can), risk.table = T, tables.theme = clean_theme())$table
  grid.arrange(pfit$plot, tblA, layout_matrix = rbind(c(1, 1), c(1,1), c(2, 2)))
})

ggarrange(plotlist =  cancer_surv_PTV3, ncol = 5, nrow = 5)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/new_PTV_burden_15per_surv_cancer.png", width = 100, height = 50, units = "cm", dpi = 300)


```

#Survival analysis for PTV burden group 20%
```{r}

cancer_surv_PTV4 = lapply(X = unique(icd_mapping$cancer_type), FUN = function(x){
  temp_can = subset(cancer_data, cancer_type == x)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can %<>% 
  mutate(time_in_days = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$cancer_type[is.na(temp_can$cancer_type)] = "No cancer"
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  temp_can$PTV_burden_group_20per = factor(temp_can$PTV_burden_group_20per, ordered = T)
  fit = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_burden_group_20per, data = temp_can))
  args = list(fit = fit, title = paste0("Survival Analysis for ", x, "\n(N=", nrow(temp_can), ")"), pval = T, legend = "none")
  pfit = do.call(ggsurvplot, args)
  tblA = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_burden_group_20per, data = temp_can), risk.table = T, tables.theme = clean_theme())$table
  grid.arrange(pfit$plot, tblA, layout_matrix = rbind(c(1, 1), c(1,1), c(2, 2)))
})

ggarrange(plotlist =  cancer_surv_PTV4, ncol = 5, nrow = 5)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/new_PTV_burden_20per_surv_cancer.png", width = 100, height = 50, units = "cm", dpi = 300)


```

#Survival analysis for PTV burden group 4
```{r}

cancer_surv_PTV4 = lapply(X = unique(icd_mapping$cancer_type), FUN = function(x){
  temp_can = subset(cancer_data, cancer_type == x)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can %<>% 
  mutate(time_in_days = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$cancer_type[is.na(temp_can$cancer_type)] = "No cancer"
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  temp_can$PTV_burden_group_20per = cut(temp_can$PTV_burden, breaks = quantile(temp_can$PTV_burden, c(0, 0.05, 0.95, 1)), labels = c("Low", "Medium","High"), include.lowest = T, right = T)
  fit = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_burden_group_4, data = temp_can))
  args = list(fit = fit, title = paste0("Survival Analysis for ", x, "\n(N=", nrow(temp_can), ")"), pval = T, legend = "none")
  pfit = do.call(ggsurvplot, args)
  tblA = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_burden_group_4, data = temp_can), risk.table = T, tables.theme = clean_theme())$table
  grid.arrange(pfit$plot, tblA, layout_matrix = rbind(c(1, 1), c(1,1), c(2, 2)))
})
ggarrange(plotlist =  cancer_surv_PTV4, ncol = 5, nrow = 5)

ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/PTV_burden_g4_surv_cancer.jpg", width = 100, height = 50, units = "cm", dpi = 300)

#temp_can$PTV_burden_group_4 = cut(temp_can$PTV_burden, breaks = quantile(temp_can$PTV_burden, c(0, 0.01, 0.99, 1)), labels = c("Low", "Medium","High"), include.lowest = T, right = T)

```

#All tumor survival analysis
```{r}
temp_df_1 = data.frame(eid = cancer_data$eid,
                       birthdate = cancer_data$birthdate,
                       date_of_death = cancer_data$date_of_death,
                       diag_date = cancer_data$diag_date,
                       death = cancer_data$death,
                       cancer_type = cancer_data$cancer_type,
                       PTV_burden_group = cancer_data$PTV_burden_group,
                       PTV_burden_group_2 = cancer_data$PTV_burden_group_2,
                       PTV_burden_group_3 = cancer_data$PTV_burden_group_3)

temp_df_1 %<>%
  group_by(eid) %>%
  summarize(
    birthdate = first(birthdate),
    date_of_death = first(date_of_death),
    diag_date = first(diag_date),
    death = first(death),
    PTV_burden_group = first(PTV_burden_group),
    PTV_burden_group_2 = first(PTV_burden_group_2),
    PTV_burden_group_3 = first(PTV_burden_group_3))

temp_df_1 %<>% 
  mutate(time_in_days = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
temp_df_1$event_indicator = ifelse(temp_df_1$death == T, 1, 0)

fit_4 = survfit(Surv(time_in_days, event = event_indicator) ~ PTV_burden_group, data = temp_df_1)
PTV_g1_cancer_surv_death = ggsurvplot(fit_4, risk.table = T, pval = T, tables.theme = clean_theme(), title = paste0("Survival Analysis for Tumors (PTV burden group 1)"))
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/PTV_g1_tumor_surv.png", plot = PTV_g1_cancer_surv_death$plot, width = 60, height = 30, units = "cm", dpi = 300)


fit_5 = survfit(Surv(time_in_days, event = event_indicator) ~ PTV_burden_group_2, data = temp_df_1)
PTV_g2_cancer_surv_death = ggsurvplot(fit_5, risk.table = T, pval = T, tables.theme = clean_theme(), title = paste0("Survival Analysis for Tumors (PTV burden group 2)"))
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/PTV_g2_tumor_surv.png", plot = PTV_g2_cancer_surv_death$plot, width = 60, height = 30, units = "cm", dpi = 300)

fit_6 = survfit(Surv(time_in_days, event = event_indicator) ~ PTV_burden_group_3, data = temp_df_1)
PTV_g3_cancer_surv_death = ggsurvplot(fit_6, risk.table = T, pval = T, tables.theme = clean_theme(), title = paste0("Survival Analysis for Tumors (PTV burden group 3)"))
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/PTV_g3_tumor_surv.png", plot = PTV_g3_cancer_surv_death$plot, width = 60, height = 30, units = "cm", dpi = 300)



PTV_plot_list_surv = list(PTV_g1_cancer_surv_death$plot, PTV_g2_cancer_surv_death$plot, PTV_g3_cancer_surv_death$plot)
PTV_risk_list_surv = list(PTV_g1_cancer_surv_death$table, PTV_g2_cancer_surv_death$table, PTV_g3_cancer_surv_death$table)
PTV_plot_list_combined = c(PTV_plot_list_surv, PTV_risk_list_surv)

grid.arrange(grobs = PTV_plot_list_combined, ncol = 3)
plot_grid(plotlist = PTV_plot_list_combined, ncol = 3)

ggsave(filename ="C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/PTV_cancer_all_surv.png", width = 100, height = 50, units = "cm", dpi = 300 )


```

#PTV cox model
```{r}

coxregfun_surv = function(x) {
  temp_can = subset(cancer_data, cancer_type == x)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can %<>% 
  mutate(time_in_days = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$cancer_type[is.na(temp_can$cancer_type)] = "No cancer"
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  temp_can$PTV_burden = factor(temp_can$PTV_burden, ordered = T)
  res.cox = coxph(Surv(time_in_days, event_indicator) ~ PTV_burden, data = temp_can)
  c(exp(res.cox$coefficients), summary(res.cox)$coefficients[5])
  p_value = summary(res.cox)$coefficients[5]
  coef_value = summary(res.cox)$coefficients[1]
  data.frame(
    cancer_type = x,
    p_value = p_value,
    coef_value = coef_value)
}

result_list_surv = lapply(unique(icd_mapping$cancer_type), coxregfun_surv)


cancer_new_PTV_surv_df = do.call(rbind, result_list_surv)
save(cancer_new_PTV_surv_df, file = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/objects/cancer_new_PTV_coef_surv")

```

#PTV cox model group 1
```{r}

coxregfun_surv_g1 = function(x) {
  temp_can = subset(cancer_data, cancer_type == x)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can %<>% 
  mutate(time_in_days = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$cancer_type[is.na(temp_can$cancer_type)] = "No cancer"
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  temp_can$PTV_burden_group = factor(temp_can$PTV_burden_group, ordered = T)
  res.cox = coxph(Surv(time_in_days, event_indicator) ~ PTV_burden_group, data = temp_can)
  c(exp(res.cox$coefficients), summary(res.cox)$coefficients[5])
  p_value = summary(res.cox)$coefficients[5]
  coef_value = summary(res.cox)$coefficients[1]
  data.frame(
    cancer_type = x,
    p_value = p_value,
    coef_value = coef_value)
}

result_list_surv_g1 = lapply(unique(icd_mapping$cancer_type), coxregfun_surv_g1)


cancer_new_PTV_surv_g1_df = do.call(rbind, result_list_surv_g1)
save(cancer_new_PTV_surv_g1_df, file = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/objects/cancer_new_PTV_coef_surv_g1")

```

#PTV cox model group 2
```{r}

coxregfun_surv_g2 = function(x) {
  temp_can = subset(cancer_data, cancer_type == x)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can %<>% 
  mutate(time_in_days = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$cancer_type[is.na(temp_can$cancer_type)] = "No cancer"
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  temp_can$PTV_burden_group_2 = factor(temp_can$PTV_burden_group_2, ordered = T)
  res.cox = coxph(Surv(time_in_days, event_indicator) ~ PTV_burden_group_2, data = temp_can)
  c(exp(res.cox$coefficients), summary(res.cox)$coefficients[5])
  p_value = summary(res.cox)$coefficients[5]
  coef_value = summary(res.cox)$coefficients[1]
  data.frame(
    cancer_type = x,
    p_value = p_value,
    coef_value = coef_value)
}

result_list_surv_g2 = lapply(unique(icd_mapping$cancer_type), coxregfun_surv_g2)


cancer_new_PTV_surv_g2_df = do.call(rbind, result_list_surv_g2)
save(cancer_new_PTV_surv_g2_df, file = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/objects/cancer_new_PTV_coef_surv_g2")

```

#PTV cox model group 3
```{r}

coxregfun_surv_g3 = function(x) {
  temp_can = subset(cancer_data, cancer_type == x)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can %<>% 
  mutate(time_in_days = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$cancer_type[is.na(temp_can$cancer_type)] = "No cancer"
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  temp_can$PTV_burden_group_3 = factor(temp_can$PTV_burden_group_3, ordered = T)
  res.cox = coxph(Surv(time_in_days, event_indicator) ~ PTV_burden_group_3, data = temp_can)
  c(exp(res.cox$coefficients), summary(res.cox)$coefficients[5])
  p_value = summary(res.cox)$coefficients[5]
  coef_value = summary(res.cox)$coefficients[1]
  data.frame(
    cancer_type = x,
    p_value = p_value,
    coef_value = coef_value)
}

result_list_surv_g3 = lapply(unique(icd_mapping$cancer_type), coxregfun_surv_g3)


cancer_new_PTV_surv_g3_df = do.call(rbind, result_list_surv_g3)
save(cancer_new_PTV_surv_g3_df, file = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/objects/cancer_new_PTV_coef_surv_g3")

```

#Forset plot
```{r}

cancer_data$cancer_type[is.na(cancer_data$cancer_type)] = "No_cancer"
tumors = unique(cancer_data$cancer_type)
tumors = tumors[tumors != "No_cancer"]
tumors = tumors[tumors != "Hydatidiform_mole"]

i = 0
PTV_tumor_surv_forest_plot = lapply(X = tumors, FUN = function(x){
  i = i + 1
  .GlobalEnv$i = i
  temp_can = subset(cancer_data, cancer_type == x)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can %<>% 
  mutate(time_in_days = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$cancer_type[is.na(temp_can$cancer_type)] = "No cancer"
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  temp_can %<>% add_count(sex, name = "n_sex") %>% filter(n_sex >= 5)
  temp_can$sex = factor(temp_can$sex)
  l = temp_can %>% 
    add_count(ethnic_group, name = "freq") %>% 
    filter(freq > nrow(temp_can)/25) %>% 
    arrange(desc(freq)) %>% 
    pull(ethnic_group) %>% 
    unique()
  temp_can$ethnic_group = factor(temp_can$ethnic_group, levels = c("British", sort(setdiff(l, "British"))))
  temp_can %<>% 
    select(sex, ethnic_group, PTV_burden, gpca1, gpca2, gpca3, gpca4, gpca5, gpca6, gpca7, gpca8, gpca9, gpca10, time_in_days,event_indicator) %>% 
    na.omit()
  if (length(l) == 1 & length(unique(temp_can$sex)) == 1){
    hr_model = coxph(Surv(time_in_days, event_indicator) ~ PTV_burden + gpca1 + gpca2 + gpca3 + gpca4 + gpca5 + gpca6 + gpca7 + gpca8 + gpca9 + gpca10, data = temp_can)
  } else if(length(l) == 1 & length(unique(temp_can$sex)) == 2){
    hr_model = coxph(Surv(time_in_days, event_indicator) ~ PTV_burden + sex + gpca1 + gpca2 + gpca3 + gpca4 + gpca5 + gpca6 + gpca7 + gpca8 + gpca9 + gpca10, data = temp_can)
  } else if(length(l) > 1 & length(unique(temp_can$sex)) == 1){
    hr_model = coxph(Surv(time_in_days, event_indicator) ~ PTV_burden + ethnic_group + gpca1 + gpca2 + gpca3 + gpca4 + gpca5 + gpca6 + gpca7 + gpca8 + gpca9 + gpca10, data = temp_can)
  } else {
    hr_model = coxph(Surv(time_in_days, event_indicator) ~ PTV_burden + sex + ethnic_group + gpca1 + gpca2 + gpca3 + gpca4 + gpca5 + gpca6 + gpca7 + gpca8 + gpca9 + gpca10, data = temp_can)
  }
  ggforest(hr_model, data = as.data.frame(temp_can), main = paste0("Hazard ratio of ", x), refLabel = "reference", noDigits = 2)
})

PTV_surv_cox_forest = ggarrange(plotlist = PTV_tumor_surv_forest_plot, ncol = 6, nrow = 5)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/ptv_forest_surv.png", plot = PTV_surv_cox_forest, width = 150, height = 80, units = "cm", limitsize = F, dpi = 300)


```

#Forest plot hist
```{r}


cancer_data$hist_tumor_cat[is.na(cancer_data$hist_tumor_cat)] = "No_cancer"
hist_cat = unique(cancer_data$hist_tumor_cat)
hist_cat = hist_cat[hist_cat != "No_cancer"]

i = 0
PTV_tumor_surv_forest_plot = lapply(X = hist_cat, FUN = function(x){
  i = i + 1
  .GlobalEnv$i = i
  temp_can = subset(cancer_data, hist_tumor_cat == x)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can %<>% 
  mutate(time_in_days = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$hist_tumor_cat[is.na(temp_can$hist_tumor_cat)] = "No cancer"
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  temp_can %<>% add_count(sex, name = "n_sex") %>% filter(n_sex >= 5)
  temp_can$sex = factor(temp_can$sex)
  l = temp_can %>% 
    add_count(ethnic_group, name = "freq") %>% 
    filter(freq > nrow(temp_can)/25) %>% 
    arrange(desc(freq)) %>% 
    pull(ethnic_group) %>% 
    unique()
  temp_can$ethnic_group = factor(temp_can$ethnic_group, levels = c("British", sort(setdiff(l, "British"))))
  temp_can %<>% 
    select(sex, ethnic_group, PTV_burden, gpca1, gpca2, gpca3, gpca4, gpca5, gpca6, gpca7, gpca8, gpca9, gpca10, time_in_days,event_indicator) %>% 
    na.omit()
  if (length(l) == 1 & length(unique(temp_can$sex)) == 1){
    hr_model = coxph(Surv(time_in_days, event_indicator) ~ PTV_burden + gpca1 + gpca2 + gpca3 + gpca4 + gpca5 + gpca6 + gpca7 + gpca8 + gpca9 + gpca10, data = temp_can)
  } else if(length(l) == 1 & length(unique(temp_can$sex)) == 2){
    hr_model = coxph(Surv(time_in_days, event_indicator) ~ PTV_burden + sex + gpca1 + gpca2 + gpca3 + gpca4 + gpca5 + gpca6 + gpca7 + gpca8 + gpca9 + gpca10, data = temp_can)
  } else if(length(l) > 1 & length(unique(temp_can$sex)) == 1){
    hr_model = coxph(Surv(time_in_days, event_indicator) ~ PTV_burden + ethnic_group + gpca1 + gpca2 + gpca3 + gpca4 + gpca5 + gpca6 + gpca7 + gpca8 + gpca9 + gpca10, data = temp_can)
  } else {
    hr_model = coxph(Surv(time_in_days, event_indicator) ~ PTV_burden + sex + ethnic_group + gpca1 + gpca2 + gpca3 + gpca4 + gpca5 + gpca6 + gpca7 + gpca8 + gpca9 + gpca10, data = temp_can)
  }
  ggforest(hr_model, data = as.data.frame(temp_can), main = paste0("Hazard ratio of ", x), refLabel = "reference", noDigits = 2)
})

PTV_surv_cox_forest = ggarrange(plotlist = PTV_tumor_surv_forest_plot, ncol = 3, nrow = 2)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/hist_ptv_forest_surv.png", plot = PTV_surv_cox_forest, width = 70, height = 60, units = "cm", limitsize = F, dpi = 300)

```

#Forest plot PTVim
```{r}

cancer_data$cancer_type[is.na(cancer_data$cancer_type)] = "No_cancer"
tumors = unique(cancer_data$cancer_type)
tumors = tumors[tumors != "No_cancer"]
tumors = tumors[tumors != "Hydatidiform_mole"]

i = 0
PTVim_tumor_surv_forest_plot = lapply(X = tumors, FUN = function(x){
  i = i + 1
  .GlobalEnv$i = i
  temp_can = subset(cancer_data, cancer_type == x)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can %<>% 
  mutate(time_in_days = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$cancer_type[is.na(temp_can$cancer_type)] = "No cancer"
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  temp_can %<>% add_count(sex, name = "n_sex") %>% filter(n_sex >= 5)
  temp_can$sex = factor(temp_can$sex)
  l = temp_can %>% 
    add_count(ethnic_group, name = "freq") %>% 
    filter(freq > nrow(temp_can)/25) %>% 
    arrange(desc(freq)) %>% 
    pull(ethnic_group) %>% 
    unique()
  temp_can$ethnic_group = factor(temp_can$ethnic_group, levels = c("British", sort(setdiff(l, "British"))))
  temp_can %<>% 
    select(sex, ethnic_group, PTVim, gpca1, gpca2, gpca3, gpca4, gpca5, gpca6, gpca7, gpca8, gpca9, gpca10, time_in_days,event_indicator) %>% 
    na.omit()
  if (length(l) == 1 & length(unique(temp_can$sex)) == 1){
    hr_model = coxph(Surv(time_in_days, event_indicator) ~ PTVim + gpca1 + gpca2 + gpca3 + gpca4 + gpca5 + gpca6 + gpca7 + gpca8 + gpca9 + gpca10, data = temp_can)
  } else if(length(l) == 1 & length(unique(temp_can$sex)) == 2){
    hr_model = coxph(Surv(time_in_days, event_indicator) ~ PTVim + sex + gpca1 + gpca2 + gpca3 + gpca4 + gpca5 + gpca6 + gpca7 + gpca8 + gpca9 + gpca10, data = temp_can)
  } else if(length(l) > 1 & length(unique(temp_can$sex)) == 1){
    hr_model = coxph(Surv(time_in_days, event_indicator) ~ PTVim + ethnic_group + gpca1 + gpca2 + gpca3 + gpca4 + gpca5 + gpca6 + gpca7 + gpca8 + gpca9 + gpca10, data = temp_can)
  } else {
    hr_model = coxph(Surv(time_in_days, event_indicator) ~ PTVim + sex + ethnic_group + gpca1 + gpca2 + gpca3 + gpca4 + gpca5 + gpca6 + gpca7 + gpca8 + gpca9 + gpca10, data = temp_can)
  }
  ggforest(hr_model, data = as.data.frame(temp_can), main = paste0("Hazard ratio of ", x), refLabel = "reference")
})

PTV_surv_cox_forest = ggarrange(plotlist = PTVim_tumor_surv_forest_plot, ncol = 6, nrow = 5)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/ptvim_forest_surv.png", plot = PTV_surv_cox_forest, width = 150, height = 80, units = "cm", limitsize = F, dpi = 300)

```



#PTV survival
##Universal 1
```{r}

cancer_data$gender = ifelse(cancer_data$sex == 0, "female", "male")
cancer_data$hist_tumor_cat[is.na(cancer_data$hist_tumor_cat)] = "No_cancer"
hist_cat = unique(cancer_data$hist_tumor_cat)
hist_cat = hist_cat[hist_cat != "No_cancer"]

cancer_surv_PTV1 = lapply(X = hist_cat, FUN = function(x){
  temp_can = subset(cancer_data, hist_tumor_cat == x)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can$PTV_universal_1 = as.character(temp_can$PTV_universal_1)
  l = sort(unique(temp_can$PTV_universal_1))
  cp = unique(sort(unlist(sapply(X = l, FUN = function(y)  sapply(X = strsplit(y, ",")[[1]], FUN = function(x) as.numeric(str_extract(x, "\\d+")))))))
  temp_can$PTV_universal_1 = cut(temp_can$PTV_burden, breaks = cp, include.lowest = T, right = T)
  temp_can %<>% 
  mutate(time_in_days = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$hist_tumor_cat[is.na(temp_can$hist_tumor_cat)] = "No cancer"
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  #temp_can$PTV_universal_1 = factor(temp_can$PTV_universal_1, ordered = T)
  fit_f = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_universal_1, data = subset(temp_can, gender == "female")))
  args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", x, "(Female)\n(N=", nrow(subset(temp_can, gender == "female")), ")"), pval = T, legend = "none")
  pfit_f = do.call(ggsurvplot, args_f)
  tbl_f = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_universal_1, data =  subset(temp_can, gender == "female")), risk.table = T)$table
  fit_m = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_universal_1, data = subset(temp_can, gender == "male")))
  args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", x, "(Male)\n(N=", subset(temp_can, gender == "male"), ")"), pval = T, legend = "none")
  pfit_m = do.call(ggsurvplot, args_m)
  tbl_m = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_universal_1, data =  subset(temp_can, gender == "male")), risk.table = T)$table
  grid.arrange(pfit_f$plot, pfit_m$plot, tbl_f, tbl_m, layout_matrix = rbind(c(1, 1, 2, 2), c(1,1, 2, 2), c(3, 3, 4, 4)))
  })


ggarrange(plotlist =  cancer_surv_PTV1, ncol = 3, nrow = 2)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/PTV_cancer_surv/hist_type_PTV_universal_1.png", width = 120, height = 60, units = "cm", dpi = 300)

```

##Universal 2
```{r}

cancer_data$gender = ifelse(cancer_data$sex == 0, "female", "male")
cancer_data$hist_tumor_cat[is.na(cancer_data$hist_tumor_cat)] = "No_cancer"
hist_cat = unique(cancer_data$hist_tumor_cat)
hist_cat = hist_cat[hist_cat != "No_cancer"]

cancer_surv_PTV2 = lapply(X = hist_cat, FUN = function(x){
  temp_can = subset(cancer_data, hist_tumor_cat == x)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can$PTV_universal_2 = as.character(temp_can$PTV_universal_2)
  l = sort(unique(temp_can$PTV_universal_2))
  cp = unique(sort(unlist(sapply(X = l, FUN = function(y)  sapply(X = strsplit(y, ",")[[1]], FUN = function(x) as.numeric(str_extract(x, "\\d+")))))))
  temp_can$PTV_universal_2 = cut(temp_can$PTV_burden, breaks = cp, include.lowest = T, right = T)
  temp_can %<>% 
  mutate(time_in_days = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$hist_tumor_cat[is.na(temp_can$hist_tumor_cat)] = "No cancer"
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  #temp_can$PTV_universal_2 = factor(temp_can$PTV_universal_2, ordered = T)
  fit_f = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_universal_2, data = subset(temp_can, gender == "female")))
  args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", x, "(Female)\n(N=", nrow(subset(temp_can, gender == "female")), ")"), pval = T, legend = "none")
  pfit_f = do.call(ggsurvplot, args_f)
  tbl_f = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_universal_2, data =  subset(temp_can, gender == "female")), risk.table = T)$table
  fit_m = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_universal_2, data = subset(temp_can, gender == "male")))
  args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", x, "(Male)\n(N=", nrow(subset(temp_can, gender == "male")), ")"), pval = T, legend = "none")
  pfit_m = do.call(ggsurvplot, args_m)
  tbl_m = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_universal_2, data =  subset(temp_can, gender == "male")), risk.table = T)$table
  grid.arrange(pfit_f$plot, pfit_m$plot, tbl_f, tbl_m, layout_matrix = rbind(c(1, 1, 2, 2), c(1,1, 2, 2), c(3, 3, 4, 4)))
  })


ggarrange(plotlist =  cancer_surv_PTV2, ncol = 3, nrow = 2)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/PTV_cancer_surv/hist_type_PTV_universal_2.png", width = 120, height = 60, units = "cm", dpi = 300)


```

##Universal 3
```{r}

cancer_data$gender = ifelse(cancer_data$sex == 0, "female", "male")
cancer_data$hist_tumor_cat[is.na(cancer_data$hist_tumor_cat)] = "No_cancer"
hist_cat = unique(cancer_data$hist_tumor_cat)
hist_cat = hist_cat[hist_cat != "No_cancer"]

cancer_surv_PTV3 = lapply(X = hist_cat, FUN = function(x){
  temp_can = subset(cancer_data, hist_tumor_cat == x)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can$PTV_universal_3 = as.character(temp_can$PTV_universal_3)
  l = sort(unique(temp_can$PTV_universal_3))
  cp = unique(sort(unlist(sapply(X = l, FUN = function(y)  sapply(X = strsplit(y, ",")[[1]], FUN = function(x) as.numeric(str_extract(x, "\\d+")))))))
  temp_can$PTV_universal_3 = cut(temp_can$PTV_burden, breaks = cp, include.lowest = T, right = T)
  temp_can %<>% 
  mutate(time_in_days = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$hist_tumor_cat[is.na(temp_can$hist_tumor_cat)] = "No cancer"
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  #temp_can$PTV_universal_3 = factor(temp_can$PTV_universal_3, ordered = T)
  fit_f = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_universal_3, data = subset(temp_can, gender == "female")))
  args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", x, "(Female)\n(N=", nrow(subset(temp_can, gender == "female")), ")"), pval = T, legend = "none")
  pfit_f = do.call(ggsurvplot, args_f)
  tbl_f = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_universal_3, data =  subset(temp_can, gender == "female")), risk.table = T)$table
  fit_m = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_universal_3, data = subset(temp_can, gender == "male")))
  args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", x, "(Male)\n(N=", nrow(subset(temp_can, gender == "male")), ")"), pval = T, legend = "none")
  pfit_m = do.call(ggsurvplot, args_m)
  tbl_m = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_universal_3, data =  subset(temp_can, gender == "male")), risk.table = T)$table
  grid.arrange(pfit_f$plot, pfit_m$plot, tbl_f, tbl_m, layout_matrix = rbind(c(1, 1, 2, 2), c(1,1, 2, 2), c(3, 3, 4, 4)))
  })


ggarrange(plotlist =  cancer_surv_PTV3, ncol = 3, nrow = 2)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/PTV_cancer_surv/hist_type_PTV_universal_3.png", width = 120, height = 60, units = "cm", dpi = 300)

```

##Hist type 1 PTV
```{r}

cancer_data$gender = ifelse(cancer_data$sex == 0, "female", "male")
cancer_data$hist_tumor_cat[is.na(cancer_data$hist_tumor_cat)] = "No_cancer"
hist_cat = unique(cancer_data$hist_tumor_cat)
hist_cat = hist_cat[hist_cat != "No_cancer"]

cancer_hist_surv_PTV1 = lapply(X = hist_cat, FUN = function(x){
  temp_can = subset(cancer_data, hist_tumor_cat == x)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can$PTV_hist_type_1 = as.character(temp_can$PTV_hist_type_1)
  l = sort(unique(temp_can$PTV_hist_type_1))
  cp = unique(sort(unlist(sapply(X = l, FUN = function(y)  sapply(X = strsplit(y, ",")[[1]], FUN = function(x) as.numeric(str_extract(x, "\\d+")))))))
  temp_can$PTV_hist_type_1 = cut(temp_can$PTV_burden, breaks = cp, include.lowest = T, right = T)
  temp_can %<>% 
  mutate(time_in_days = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$hist_tumor_cat[is.na(temp_can$hist_tumor_cat)] = "No cancer"
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  #temp_can$PTV_hist_type_1 = factor(temp_can$PTV_hist_type_1, ordered = T)
 fit_f = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_hist_type_1, data = subset(temp_can, gender == "female")))
  args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", x, "(Female)\n(N=", nrow(subset(temp_can, gender == "female")), ")"), pval = T, legend = "none")
  pfit_f = do.call(ggsurvplot, args_f)
  tbl_f = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_hist_type_1, data =  subset(temp_can, gender == "female")), risk.table = T)$table
  fit_m = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_hist_type_1, data = subset(temp_can, gender == "male")))
  args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", x, "(Male)\n(N=", nrow(subset(temp_can, gender == "male")), ")"), pval = T, legend = "none")
  pfit_m = do.call(ggsurvplot, args_m)
  tbl_m = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_hist_type_1, data =  subset(temp_can, gender == "male")), risk.table = T)$table
  grid.arrange(pfit_f$plot, pfit_m$plot, tbl_f, tbl_m, layout_matrix = rbind(c(1, 1, 2, 2), c(1,1, 2, 2), c(3, 3, 4, 4)))
  })


ggarrange(plotlist =  cancer_hist_surv_PTV1, ncol = 3, nrow = 2)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/PTV_cancer_surv/hist_type_PTV_tumor_cat_1.png", width = 120, height = 60, units = "cm", dpi = 300)


```

##Hist type 2 PTV
```{r}
cancer_data$hist_tumor_cat[is.na(cancer_data$hist_tumor_cat)] = "No_cancer"
hist_cat = unique(cancer_data$hist_tumor_cat)
hist_cat = hist_cat[hist_cat != "No_cancer"]

cancer_hist_surv_PTV2 = lapply(X = hist_cat, FUN = function(x){
  temp_can = subset(cancer_data, hist_tumor_cat == x)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can$PTV_hist_type_2 = as.character(temp_can$PTV_hist_type_2)
  l = sort(unique(temp_can$PTV_hist_type_2))
  cp = unique(sort(unlist(sapply(X = l, FUN = function(y)  sapply(X = strsplit(y, ",")[[1]], FUN = function(x) as.numeric(str_extract(x, "\\d+")))))))
  temp_can$PTV_hist_type_2 = cut(temp_can$PTV_burden, breaks = cp, include.lowest = T, right = T)
  temp_can %<>% 
  mutate(time_in_days = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$hist_tumor_cat[is.na(temp_can$hist_tumor_cat)] = "No cancer"
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  #temp_can$PTV_hist_type_2 = factor(temp_can$PTV_hist_type_2, ordered = T)
 fit_f = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_hist_type_2, data = subset(temp_can, gender == "female")))
  args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", x, "(Female)\n(N=", nrow(subset(temp_can, gender == "female")), ")"), pval = T, legend = "none")
  pfit_f = do.call(ggsurvplot, args_f)
  tbl_f = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_hist_type_2, data =  subset(temp_can, gender == "female")), risk.table = T)$table
  fit_m = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_hist_type_2, data = subset(temp_can, gender == "male")))
  args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", x, "(Male)\n(N=", nrow(subset(temp_can, gender == "male")), ")"), pval = T, legend = "none")
  pfit_m = do.call(ggsurvplot, args_m)
  tbl_m = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_hist_type_2, data =  subset(temp_can, gender == "male")), risk.table = T)$table
  grid.arrange(pfit_f$plot, pfit_m$plot, tbl_f, tbl_m, layout_matrix = rbind(c(1, 1, 2, 2), c(1,1, 2, 2), c(3, 3, 4, 4)))
  })


ggarrange(plotlist =  cancer_hist_surv_PTV2, ncol = 3, nrow = 2)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/PTV_cancer_surv/hist_type_PTV_tumor_cat_2.png", width = 120, height = 60, units = "cm", dpi = 300)


```

##Hist type 3 PTV
```{r}
cancer_data$hist_tumor_cat[is.na(cancer_data$hist_tumor_cat)] = "No_cancer"
hist_cat = unique(cancer_data$hist_tumor_cat)
hist_cat = hist_cat[hist_cat != "No_cancer"]

cancer_hist_surv_PTV3 = lapply(X = hist_cat, FUN = function(x){
  temp_can = subset(cancer_data, hist_tumor_cat == x)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can$PTV_hist_type_3 = as.character(temp_can$PTV_hist_type_3)
  l = sort(unique(temp_can$PTV_hist_type_3))
  cp = unique(sort(unlist(sapply(X = l, FUN = function(y)  sapply(X = strsplit(y, ",")[[1]], FUN = function(x) as.numeric(str_extract(x, "\\d+")))))))
  temp_can$PTV_hist_type_3 = cut(temp_can$PTV_burden, breaks = cp, include.lowest = T, right = T)
  temp_can %<>% 
  mutate(time_in_days = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$hist_tumor_cat[is.na(temp_can$hist_tumor_cat)] = "No cancer"
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  #temp_can$PTV_hist_type_3 = factor(temp_can$PTV_hist_type_3, ordered = T)
 fit_f = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_hist_type_3, data = subset(temp_can, gender == "female")))
  args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", x, "(Female)\n(N=", nrow(subset(temp_can, gender == "female")), ")"), pval = T, legend = "none")
  pfit_f = do.call(ggsurvplot, args_f)
  tbl_f = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_hist_type_3, data =  subset(temp_can, gender == "female")), risk.table = T)$table
  fit_m = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_hist_type_3, data = subset(temp_can, gender == "male")))
  args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", x, "(Male)\n(N=", nrow(subset(temp_can, gender == "male")), ")"), pval = T, legend = "none")
  pfit_m = do.call(ggsurvplot, args_m)
  tbl_m = ggsurvplot(survfit(Surv(time_in_days, event = event_indicator) ~ PTV_hist_type_3, data =  subset(temp_can, gender == "male")), risk.table = T)$table
  grid.arrange(pfit_f$plot, pfit_m$plot, tbl_f, tbl_m, layout_matrix = rbind(c(1, 1, 2, 2), c(1,1, 2, 2), c(3, 3, 4, 4)))
  })


ggarrange(plotlist =  cancer_hist_surv_PTV3, ncol = 3, nrow = 2)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/PTV_cancer_surv/hist_type_PTV_tumor_cat_3.png", width = 120, height = 60, units = "cm", dpi = 300)

```

##Cancer universal 1
```{r}

cancer_data$gender = ifelse(cancer_data$sex == 0, "female", "male")
cancer_data$cancer_type[is.na(cancer_data$cancer_type)] = "No_cancer"
tumors = unique(cancer_data$cancer_type)
tumors = tumors[tumors != "No_cancer"]
tumors = tumors[tumors != "Hydatidiform_mole"]

cancer_surv_PTV1 = lapply(X = tumors, FUN = function(x){
  temp_can = subset(cancer_data, cancer_type == x)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can$PTV_universal_1 = as.character(temp_can$PTV_universal_1)
  l = sort(unique(temp_can$PTV_universal_1))
  cp = unique(sort(unlist(sapply(X = l, FUN = function(y)  sapply(X = strsplit(y, ",")[[1]], FUN = function(x) as.numeric(str_extract(x, "\\d+")))))))
  temp_can$PTV_universal_1 = cut(temp_can$PTV_burden, breaks = cp, include.lowest = T, right = T)
  temp_can %<>% 
  mutate(time_in_days = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$cancer_type[is.na(temp_can$cancer_type)] = "No cancer"
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  #temp_can$PTV_universal_1 = factor(temp_can$PTV_universal_1, ordered = T)
  gender_counts = table(temp_can$gender)
  if (length(gender_counts) == 2 & all(gender_counts >= 10)) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_universal_1, data = subset(temp_can, gender == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", x, " (Male)\n(N=", sum(temp_can$gender == "male"), ")"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fit_f = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_universal_1, data = subset(temp_can, gender == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", x, " (Female)\n(N=", sum(temp_can$gender == "female"), ")"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, pfit_m$plot, tbl_f, tbl_m, layout_matrix = rbind(c(1, 1, 2, 2), c(1,1, 2, 2), c(3, 3, 4, 4)))
  } else if ("male" %in% names(gender_counts) && gender_counts["male"] >= 10) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_universal_1, data = subset(temp_can, gender == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", x, " (Male)\n(N=", sum(temp_can$gender == "male"), ")"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fig = grid.arrange(pfit_m$plot, tbl_m, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else if ("female" %in% names(gender_counts) && gender_counts["female"] >= 10){
    fit_f = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_universal_1, data = subset(temp_can, gender == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", x, " (Female)\n(N=", sum(temp_can$gender == "female"), ")"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, tbl_f, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else {
    message("Not enough data for either gender.")}
})


ggarrange(plotlist =  cancer_surv_PTV1, ncol = 6, nrow = 5)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/PTV_cancer_surv/cancer_type_universal_PTV_1.png", width = 140, height = 60, units = "cm", dpi = 300, limitsize = F)

```

##Cancer universal 2
```{r}

cancer_data$cancer_type[is.na(cancer_data$cancer_type)] = "No_cancer"
tumors = unique(cancer_data$cancer_type)
tumors = tumors[tumors != "No_cancer"]
tumors = tumors[tumors != "Hydatidiform_mole"]

cancer_surv_PTV2 = lapply(X = tumors, FUN = function(x){
  temp_can = subset(cancer_data, cancer_type == x)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can$PTV_universal_2 = as.character(temp_can$PTV_universal_2)
  l = sort(unique(temp_can$PTV_universal_2))
  cp = unique(sort(unlist(sapply(X = l, FUN = function(y)  sapply(X = strsplit(y, ",")[[1]], FUN = function(x) as.numeric(str_extract(x, "\\d+")))))))
  temp_can$PTV_universal_2 = cut(temp_can$PTV_burden, breaks = cp, include.lowest = T, right = T)
  temp_can %<>% 
  mutate(time_in_days = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$cancer_type[is.na(temp_can$cancer_type)] = "No cancer"
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  #temp_can$PTV_universal_2 = factor(temp_can$PTV_universal_2, ordered = T)
  gender_counts = table(temp_can$gender)
  if (length(gender_counts) == 2 & all(gender_counts >= 10)) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_universal_2, data = subset(temp_can, gender == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", x, " (Male)\n(N=", sum(temp_can$gender == "male"), ")"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fit_f = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_universal_2, data = subset(temp_can, gender == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", x, " (Female)\n(N=", sum(temp_can$gender == "female"), ")"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, pfit_m$plot, tbl_f, tbl_m, layout_matrix = rbind(c(1, 1, 2, 2), c(1,1, 2, 2), c(3, 3, 4, 4)))
  } else if ("male" %in% names(gender_counts) && gender_counts["male"] >= 10) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_universal_2, data = subset(temp_can, gender == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", x, " (Male)\n(N=", sum(temp_can$gender == "male"), ")"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fig = grid.arrange(pfit_m$plot, tbl_m, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else if ("female" %in% names(gender_counts) && gender_counts["female"] >= 10){
    fit_f = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_universal_2, data = subset(temp_can, gender == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", x, " (Female)\n(N=", sum(temp_can$gender == "female"), ")"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, tbl_f, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else {
    message("Not enough data for either gender.")}
})


ggarrange(plotlist =  cancer_surv_PTV2, ncol = 6, nrow = 5)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/PTV_cancer_surv/cancer_type_universal_PTV_2.png", width = 140, height = 60, units = "cm", dpi = 300, limitsize = F)


```

##Universal 3
```{r}

cancer_data$cancer_type[is.na(cancer_data$cancer_type)] = "No_cancer"
tumors = unique(cancer_data$cancer_type)
tumors = tumors[tumors != "No_cancer"]
tumors = tumors[tumors != "Hydatidiform_mole"]

cancer_surv_PTV3 = lapply(X = tumors, FUN = function(x){
  temp_can = subset(cancer_data, cancer_type == x)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can$PTV_universal_3 = as.character(temp_can$PTV_universal_3)
  l = sort(unique(temp_can$PTV_universal_3))
  cp = unique(sort(unlist(sapply(X = l, FUN = function(y)  sapply(X = strsplit(y, ",")[[1]], FUN = function(x) as.numeric(str_extract(x, "\\d+")))))))
  temp_can$PTV_universal_3 = cut(temp_can$PTV_burden, breaks = cp, include.lowest = T, right = T)
  temp_can %<>% 
  mutate(time_in_days = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$cancer_type[is.na(temp_can$cancer_type)] = "No cancer"
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  #temp_can$PTV_universal_3 = factor(temp_can$PTV_universal_3, ordered = T)
  gender_counts = table(temp_can$gender)
  if (length(gender_counts) == 2 & all(gender_counts >= 10)) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_universal_3, data = subset(temp_can, gender == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", x, " (Male)\n(N=", sum(temp_can$gender == "male"), ")"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fit_f = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_universal_3, data = subset(temp_can, gender == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", x, " (Female)\n(N=", sum(temp_can$gender == "female"), ")"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, pfit_m$plot, tbl_f, tbl_m, layout_matrix = rbind(c(1, 1, 2, 2), c(1,1, 2, 2), c(3, 3, 4, 4)))
  } else if ("male" %in% names(gender_counts) && gender_counts["male"] >= 10) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_universal_3, data = subset(temp_can, gender == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", x, " (Male)\n(N=", sum(temp_can$gender == "male"), ")"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fig = grid.arrange(pfit_m$plot, tbl_m, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else if ("female" %in% names(gender_counts) && gender_counts["female"] >= 10){
    fit_f = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_universal_3, data = subset(temp_can, gender == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", x, " (Female)\n(N=", sum(temp_can$gender == "female"), ")"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, tbl_f, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else {
    message("Not enough data for either gender.")}
})


ggarrange(plotlist =  cancer_surv_PTV3, ncol = 6, nrow = 5)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/PTV_cancer_surv/cancer_type_universal_PTV_3.png", width = 140, height = 60, units = "cm", dpi = 300, limitsize = F)

```


##Cancer type 1 PTV
```{r}

cancer_data$gender = ifelse(cancer_data$sex == 0, "female", "male")
tumors = unique(cancer_data$cancer_type)
tumors = tumors[tumors != "No_cancer"]
tumors = tumors[tumors != "Hydatidiform_mole"]

cancer_type_surv_PTV1 = lapply(X = tumors, FUN = function(x){
  temp_can = subset(cancer_data, cancer_type == x)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can$PTV_cancer_type_1 = as.character(temp_can$PTV_cancer_type_1)
  l = sort(unique(temp_can$PTV_cancer_type_1))
  cp = unique(sort(unlist(sapply(X = l, FUN = function(y)  sapply(X = strsplit(y, ",")[[1]], FUN = function(x) as.numeric(str_extract(x, "\\d+")))))))
  temp_can$PTV_cancer_type_1 = cut(temp_can$PTV_burden, breaks = cp, include.lowest = T, right = T)
  temp_can %<>% 
  mutate(time_in_days = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$cancer_type[is.na(temp_can$cancer_type)] = "No cancer"
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  #temp_can$PTVim_cancer_type_1 = factor(temp_can$PTVim_cancer_type_1, ordered = T)
  gender_counts = table(temp_can$gender)
  gender_counts = table(temp_can$gender)
  if (length(gender_counts) == 2 & all(gender_counts >= 10)) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_cancer_type_1, data = subset(temp_can, gender == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", x, " (Male)\n(N=", sum(temp_can$gender == "male"), ")"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fit_f = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_cancer_type_1, data = subset(temp_can, gender == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", x, " (Female)\n(N=", sum(temp_can$gender == "female"), ")"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, pfit_m$plot, tbl_f, tbl_m, layout_matrix = rbind(c(1, 1, 2, 2), c(1,1, 2, 2), c(3, 3, 4, 4)))
  } else if ("male" %in% names(gender_counts) && gender_counts["male"] >= 10) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_cancer_type_1, data = subset(temp_can, gender == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", x, " (Male)\n(N=", sum(temp_can$gender == "male"), ")"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fig = grid.arrange(pfit_m$plot, tbl_m, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else if ("female" %in% names(gender_counts) && gender_counts["female"] >= 10){
    fit_f = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_cancer_type_1, data = subset(temp_can, gender == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", x, " (Female)\n(N=", sum(temp_can$gender == "female"), ")"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, tbl_f, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else {
    message("Not enough data for either gender.")}
  })


ggarrange(plotlist =  cancer_type_surv_PTV1, ncol = 6, nrow = 5)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/PTV_cancer_surv/cancer_type_1_PTV.png", width = 140, height = 60, units = "cm", dpi = 300, limitsize = F)

```

##Cancer type 2 PTV
```{r}

cancer_data$gender = ifelse(cancer_data$sex == 0, "female", "male")
cancer_data$cancer_type[is.na(cancer_data$cancer_type)] = "No_cancer"
tumors = unique(cancer_data$cancer_type)
tumors = tumors[tumors != "No_cancer"]
tumors = tumors[tumors != "Hydatidiform_mole"]

cancer_type_surv_PTV2 = lapply(X = tumors, FUN = function(x){
  temp_can = subset(cancer_data, cancer_type == x)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can$PTV_cancer_type_2 = as.character(temp_can$PTV_cancer_type_2)
  l = sort(unique(temp_can$PTV_cancer_type_2))
  cp = unique(sort(unlist(sapply(X = l, FUN = function(y)  sapply(X = strsplit(y, ",")[[1]], FUN = function(x) as.numeric(str_extract(x, "\\d+")))))))
  temp_can$PTV_cancer_type_2 = cut(temp_can$PTV_burden, breaks = cp, include.lowest = T, right = T)
  temp_can %<>% 
  mutate(time_in_days = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$cancer_type[is.na(temp_can$cancer_type)] = "No cancer"
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  #temp_can$PTVim_cancer_type_1 = factor(temp_can$PTVim_cancer_type_1, ordered = T)
  gender_counts = table(temp_can$gender)
  gender_counts = table(temp_can$gender)
  if (length(gender_counts) == 2 & all(gender_counts >= 10)) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_cancer_type_2, data = subset(temp_can, gender == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", x, " (Male)\n(N=", sum(temp_can$gender == "male"), ")"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fit_f = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_cancer_type_2, data = subset(temp_can, gender == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", x, " (Female)\n(N=", sum(temp_can$gender == "female"), ")"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, pfit_m$plot, tbl_f, tbl_m, layout_matrix = rbind(c(1, 1, 2, 2), c(1,1, 2, 2), c(3, 3, 4, 4)))
  } else if ("male" %in% names(gender_counts) && gender_counts["male"] >= 10) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_cancer_type_2, data = subset(temp_can, gender == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", x, " (Male)\n(N=", sum(temp_can$gender == "male"), ")"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fig = grid.arrange(pfit_m$plot, tbl_m, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else if ("female" %in% names(gender_counts) && gender_counts["female"] >= 10){
    fit_f = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_cancer_type_2, data = subset(temp_can, gender == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", x, " (Female)\n(N=", sum(temp_can$gender == "female"), ")"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, tbl_f, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else {
    message("Not enough data for either gender.")}
  })


ggarrange(plotlist =  cancer_type_surv_PTV2, ncol = 6, nrow = 5)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/PTV_cancer_surv/cancer_type_2_PTV.png", width = 140, height = 60, units = "cm", dpi = 300, limitsize = F)

```

##Cancer type 3 PTV
```{r}

cancer_data$cancer_type[is.na(cancer_data$cancer_type)] = "No_cancer"
tumors = unique(cancer_data$cancer_type)
tumors = tumors[tumors != "No_cancer"]
tumors = tumors[tumors != "Hydatidiform_mole"]

cancer_type_surv_PTV3 = lapply(X = tumors, FUN = function(x){
  temp_can = subset(cancer_data, cancer_type == x)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can$PTV_cancer_type_3 = as.character(temp_can$PTV_cancer_type_3)
  l = sort(unique(temp_can$PTV_cancer_type_3))
  cp = unique(sort(unlist(sapply(X = l, FUN = function(y)  sapply(X = strsplit(y, ",")[[1]], FUN = function(x) as.numeric(str_extract(x, "\\d+")))))))
  temp_can$PTV_cancer_type_3 = cut(temp_can$PTV_burden, breaks = cp, include.lowest = T, right = T)
  temp_can %<>% 
  mutate(time_in_days = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$cancer_type[is.na(temp_can$cancer_type)] = "No cancer"
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  #temp_can$PTVim_cancer_type_1 = factor(temp_can$PTVim_cancer_type_1, ordered = T)
  gender_counts = table(temp_can$gender)
  gender_counts = table(temp_can$gender)
  if (length(gender_counts) == 2 & all(gender_counts >= 10)) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_cancer_type_3, data = subset(temp_can, gender == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", x, " (Male)\n(N=", sum(temp_can$gender == "male"), ")"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fit_f = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_cancer_type_3, data = subset(temp_can, gender == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", x, " (Female)\n(N=", sum(temp_can$gender == "female"), ")"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, pfit_m$plot, tbl_f, tbl_m, layout_matrix = rbind(c(1, 1, 2, 2), c(1,1, 2, 2), c(3, 3, 4, 4)))
  } else if ("male" %in% names(gender_counts) && gender_counts["male"] >= 10) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_cancer_type_3, data = subset(temp_can, gender == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", x, " (Male)\n(N=", sum(temp_can$gender == "male"), ")"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fig = grid.arrange(pfit_m$plot, tbl_m, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else if ("female" %in% names(gender_counts) && gender_counts["female"] >= 10){
    fit_f = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTV_cancer_type_3, data = subset(temp_can, gender == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", x, " (Female)\n(N=", sum(temp_can$gender == "female"), ")"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, tbl_f, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else {
    message("Not enough data for either gender.")}
  })


ggarrange(plotlist =  cancer_type_surv_PTV3, ncol = 6, nrow = 5)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/PTV_cancer_surv/cancer_type_3_PTV.png", width = 140, height = 60, units = "cm", dpi = 300, limitsize = F)

```

#PTVim surv analysis
##Hist type
```{r}

cancer_data$gender = ifelse(cancer_data$sex == 0, "female", "male")
cancer_data$hist_tumor_cat[is.na(cancer_data$hist_tumor_cat)] = "No_cancer"
hist_cat = unique(cancer_data$hist_tumor_cat)
hist_cat = hist_cat[hist_cat != "No_cancer"]

hist_type_ptvim = lapply(X = hist_cat, FUN = function(x){
  temp_can = subset(cancer_data, hist_tumor_cat == x)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can$PTVim_group = as.character(temp_can$PTVim_group)
  l = sort(unique(temp_can$PTVim_group))
  cp = unique(sort(unlist(sapply(X = l, FUN = function(y)  sapply(X = strsplit(y, ",")[[1]], FUN = function(x) as.numeric(str_extract(x, "\\d+")))))))
  temp_can$PTVim_group = cut(temp_can$PTVim, breaks = cp, include.lowest = T, right = T)
  temp_can %<>% 
  mutate(time_in_days = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$hist_tumor_cat[is.na(temp_can$hist_tumor_cat)] = "No cancer"
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  #temp_can$PTVim_group = factor(temp_can$PTVim_group, ordered = T)
  gender_counts = table(temp_can$gender)
  if (length(gender_counts) == 2 & all(gender_counts >= 10)) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTVim_group + gender, data = subset(temp_can, gender == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", x, " (Male)\n(N=", sum(temp_can$gender == "male"), ")"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fit_f = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTVim_group + gender, data = subset(temp_can, gender == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", x, " (Female)\n(N=", sum(temp_can$gender == "female"), ")"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, pfit_m$plot, tbl_f, tbl_m, layout_matrix = rbind(c(1, 1, 2, 2), c(1,1, 2, 2), c(3, 3, 4, 4)))
  } else if ("male" %in% names(gender_counts) && gender_counts["male"] >= 10) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTVim_group, data = subset(temp_can, gender == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", x, " (Male)\n(N=", sum(temp_can$gender == "male"), ")"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fig = grid.arrange(pfit_m$plot, tbl_m, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else if ("female" %in% names(gender_counts) && gender_counts["female"] >= 10){ 
    fit_f = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTVim_group, data = subset(temp_can, gender == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", x, " (Female)\n(N=", sum(temp_can$gender == "female"), ")"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, tbl_f, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else {
  message("Not enough data for either gender.")}
  })


ggarrange(plotlist =  hist_type_ptvim, ncol = 3, nrow = 2)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/PTV_cancer_surv/ptvim_hist_cat_survplot.png", width = 100, height = 50, units = "cm", dpi = 300, limitsize = F)

```

##Cancer type
```{r}

cancer_data$gender = ifelse(cancer_data$sex == 0, "female", "male")
cancer_data$cancer_type[is.na(cancer_data$cancer_type)] = "No_cancer"
tumors = unique(cancer_data$cancer_type)
tumors = tumors[tumors != "No_cancer"]
tumors = tumors[tumors != "Hydatidiform_mole"]
i = 0 

cancer_type_ptvim = lapply(X = tumors, FUN = function(x){
  i = i + 1
  .GlobalEnv$i = i
  temp_can = subset(cancer_data, cancer_type == x)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can$PTVim_group = as.character(temp_can$PTVim_group)
  l = sort(unique(temp_can$PTVim_group))
  cp = unique(sort(unlist(sapply(X = l, FUN = function(y)  sapply(X = strsplit(y, ",")[[1]], FUN = function(x) as.numeric(str_extract(x, "\\d+")))))))
  temp_can$PTVim_group = cut(temp_can$PTVim, breaks = cp, include.lowest = T, right = T)
  temp_can %<>% 
  mutate(time_in_days = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$cancer_type[is.na(temp_can$cancer_type)] = "No cancer"
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  #temp_can$PTVim_group = factor(temp_can$PTVim_group, ordered = T)
  gender_counts = table(temp_can$gender)
  if (length(gender_counts) == 2 & all(gender_counts >= 10)) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTVim_group + gender, data = subset(temp_can, gender == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", x, " (Male)\n(N=", sum(temp_can$gender == "male"), ")"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fit_f = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTVim_group + gender, data = subset(temp_can, gender == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", x, " (Female)\n(N=", sum(temp_can$gender == "female"), ")"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, pfit_m$plot, tbl_f, tbl_m, layout_matrix = rbind(c(1, 1, 2, 2), c(1,1, 2, 2), c(3, 3, 4, 4)))
  } else if ("male" %in% names(gender_counts) && gender_counts["male"] >= 10) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTVim_group, data = subset(temp_can, gender == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", x, " (Male)\n(N=", sum(temp_can$gender == "male"), ")"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fig = grid.arrange(pfit_m$plot, tbl_m, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else if ("female" %in% names(gender_counts) && gender_counts["female"] >= 10){
    fit_f = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTVim_group, data = subset(temp_can, gender == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", x, " (Female)\n(N=", sum(temp_can$gender == "female"), ")"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, tbl_f, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else {
  message("Not enough data for either gender.")}
})


ggarrange(plotlist =  cancer_type_ptvim, ncol = 6, nrow = 5)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/PTV_cancer_surv/ptvim_cancer_cat_survplot.png", width = 100, height = 50, units = "cm", dpi = 300)

```

##PTVim forest plot hist 
```{r}

cancer_data$hist_tumor_cat[is.na(cancer_data$hist_tumor_cat)] = "No_cancer"
hist_cat = unique(cancer_data$hist_tumor_cat)
hist_cat = hist_cat[hist_cat != "No_cancer"]

i = 0
PTVim_forest_surv = lapply(X = hist_cat, FUN = function(x){
  i = i + 1
  .GlobalEnv$i = i
  temp_can = subset(cancer_data, hist_tumor_cat == x)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can %<>% 
  mutate(time_in_days = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$hist_tumor_cat[is.na(temp_can$hist_tumor_cat)] = "No cancer"
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  temp_can %<>% add_count(gender, name = "n_gender") %>% filter(n_gender >= 5)
  temp_can$gender = factor(temp_can$gender)
  l = temp_can %>% 
    add_count(ethnic_group, name = "freq") %>% 
    filter(freq > nrow(temp_can)/25) %>% 
    arrange(desc(freq)) %>% 
    pull(ethnic_group) %>% 
    unique()
  temp_can$ethnic_group = factor(temp_can$ethnic_group, levels = c("British", sort(setdiff(l, "British"))))
  temp_can %<>% 
    select(gender, ethnic_group, PTVim, gpca1, gpca2, gpca3, gpca4, gpca5, gpca6, gpca7, gpca8, gpca9, gpca10, time_in_days,event_indicator) %>% 
    na.omit()
  if (length(l) == 1 & length(unique(temp_can$gender)) == 1){
    hr_model = coxph(Surv(time_in_days, event_indicator) ~ PTVim + gpca1 + gpca2 + gpca3 + gpca4 + gpca5 + gpca6 + gpca7 + gpca8 + gpca9 + gpca10, data = temp_can)
  } else if(length(l) == 1 & length(unique(temp_can$gender)) == 2){
    hr_model = coxph(Surv(time_in_days, event_indicator) ~ PTVim + gender + gpca1 + gpca2 + gpca3 + gpca4 + gpca5 + gpca6 + gpca7 + gpca8 + gpca9 + gpca10, data = temp_can)
  } else if(length(l) > 1 & length(unique(temp_can$gender)) == 1){
    hr_model = coxph(Surv(time_in_days, event_indicator) ~ PTVim + ethnic_group + gpca1 + gpca2 + gpca3 + gpca4 + gpca5 + gpca6 + gpca7 + gpca8 + gpca9 + gpca10, data = temp_can)
  } else {
    hr_model = coxph(Surv(time_in_days, event_indicator) ~ PTVim + gender + ethnic_group + gpca1 + gpca2 + gpca3 + gpca4 + gpca5 + gpca6 + gpca7 + gpca8 + gpca9 + gpca10, data = temp_can)
  }
  ggforest(hr_model, data = as.data.frame(temp_can), main = paste0("Hazard ratio of ", x, "(PTVim)"), refLabel = "reference", noDigits = 2)
})

PTVim_surv_cox_forest = ggarrange(plotlist = PTVim_forest_surv, ncol = 3, nrow = 2)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/PTVim_forest_surv_hist.png", plot = PTVim_surv_cox_forest, width = 70, height = 60, units = "cm", limitsize = F, dpi = 300)

```


##PTVim forest plot cancer cat
```{r}

cancer_data$cancer_type[is.na(cancer_data$cancer_type)] = "No_cancer"
tumors = unique(cancer_data$cancer_type)
tumors = tumors[tumors != "No_cancer"]
tumors = tumors[tumors != "Hydatidiform_mole"]

i = 0
PTVim_tumor_surv_forest_plot = lapply(X = tumors, FUN = function(x){
  i = i + 1
  .GlobalEnv$i = i
  temp_can = subset(cancer_data, cancer_type == x)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can %<>% 
  mutate(time_in_days = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$cancer_type[is.na(temp_can$cancer_type)] = "No cancer"
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  temp_can %<>% add_count(gender, name = "n_gender") %>% filter(n_gender >= 5)
  temp_can$gender = factor(temp_can$gender)
  l = temp_can %>% 
    add_count(ethnic_group, name = "freq") %>% 
    filter(freq > nrow(temp_can)/25) %>% 
    arrange(desc(freq)) %>% 
    pull(ethnic_group) %>% 
    unique()
  temp_can$ethnic_group = factor(temp_can$ethnic_group, levels = c("British", sort(setdiff(l, "British"))))
  temp_can %<>% 
    select(gender, ethnic_group, PTVim, gpca1, gpca2, gpca3, gpca4, gpca5, gpca6, gpca7, gpca8, gpca9, gpca10, time_in_days,event_indicator) %>% 
    na.omit()
  if (length(l) == 1 & length(unique(temp_can$gender)) == 1){
    hr_model = coxph(Surv(time_in_days, event_indicator) ~ PTVim + gpca1 + gpca2 + gpca3 + gpca4 + gpca5 + gpca6 + gpca7 + gpca8 + gpca9 + gpca10, data = temp_can)
  } else if(length(l) == 1 & length(unique(temp_can$gender)) == 2){
    hr_model = coxph(Surv(time_in_days, event_indicator) ~ PTVim + gender + gpca1 + gpca2 + gpca3 + gpca4 + gpca5 + gpca6 + gpca7 + gpca8 + gpca9 + gpca10, data = temp_can)
  } else if(length(l) > 1 & length(unique(temp_can$gender)) == 1){
    hr_model = coxph(Surv(time_in_days, event_indicator) ~ PTVim + ethnic_group + gpca1 + gpca2 + gpca3 + gpca4 + gpca5 + gpca6 + gpca7 + gpca8 + gpca9 + gpca10, data = temp_can)
  } else {
    hr_model = coxph(Surv(time_in_days, event_indicator) ~ PTVim + gender + ethnic_group + gpca1 + gpca2 + gpca3 + gpca4 + gpca5 + gpca6 + gpca7 + gpca8 + gpca9 + gpca10, data = temp_can)
  }
  ggforest(hr_model, data = as.data.frame(temp_can), main = paste0("Hazard ratio of ", x, "(PTVim)"), refLabel = "reference")
})

PTVim_surv_cox_forest = ggarrange(plotlist = PTVim_tumor_surv_forest_plot, ncol = 6, nrow = 5)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/ptvim_forest_surv.png", plot = PTVim_surv_cox_forest, width = 150, height = 80, units = "cm", limitsize = F, dpi = 300)


```

#PTVtsg surv analysis
##Hist type
```{r}

cancer_data$gender = ifelse(cancer_data$sex == 0, "female", "male")
cancer_data$hist_tumor_cat[is.na(cancer_data$hist_tumor_cat)] = "No_cancer"
hist_cat = unique(cancer_data$hist_tumor_cat)
hist_cat = hist_cat[hist_cat != "No_cancer"]

hist_type_PTVtsg = lapply(X = hist_cat, FUN = function(x){
  temp_can = subset(cancer_data, hist_tumor_cat == x)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can$PTVtsg_group = as.character(temp_can$PTVtsg_group)
  l = sort(unique(temp_can$PTVtsg_group))
  cp = unique(sort(unlist(sapply(X = l, FUN = function(y)  sapply(X = strsplit(y, ",")[[1]], FUN = function(x) as.numeric(str_extract(x, "\\d+")))))))
  temp_can$PTVtsg_group = cut(temp_can$PTVtsg, breaks = cp, include.lowest = T, right = T)
  temp_can %<>% 
  mutate(time_in_days = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$hist_tumor_cat[is.na(temp_can$hist_tumor_cat)] = "No cancer"
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  #temp_can$PTVtsg_group = factor(temp_can$PTVtsg_group, ordered = T)
  gender_counts = table(temp_can$gender)
  if (length(gender_counts) == 2 & all(gender_counts >= 10)) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTVtsg_group + gender, data = subset(temp_can, gender == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", x, " (Male)\n(N=", sum(temp_can$gender == "male"), ")"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fit_f = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTVtsg_group + gender, data = subset(temp_can, gender == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", x, " (Female)\n(N=", sum(temp_can$gender == "female"), ")"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, pfit_m$plot, tbl_f, tbl_m, layout_matrix = rbind(c(1, 1, 2, 2), c(1,1, 2, 2), c(3, 3, 4, 4)))
  } else if ("male" %in% names(gender_counts) && gender_counts["male"] >= 10) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTVtsg_group, data = subset(temp_can, gender == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", x, " (Male)\n(N=", sum(temp_can$gender == "male"), ")"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fig = grid.arrange(pfit_m$plot, tbl_m, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else if ("female" %in% names(gender_counts) && gender_counts["female"] >= 10){ 
    fit_f = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTVtsg_group, data = subset(temp_can, gender == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", x, " (Female)\n(N=", sum(temp_can$gender == "female"), ")"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, tbl_f, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else {
  message("Not enough data for either gender.")}
  })


ggarrange(plotlist =  hist_type_PTVtsg, ncol = 3, nrow = 2)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/PTV_cancer_surv/PTVtsg_hist_cat_survplot.png", width = 100, height = 50, units = "cm", dpi = 300, limitsize = F)

```

##Cancer type
```{r}

cancer_data$gender = ifelse(cancer_data$sex == 0, "female", "male")
cancer_data$cancer_type[is.na(cancer_data$cancer_type)] = "No_cancer"
tumors = unique(cancer_data$cancer_type)
tumors = tumors[tumors != "No_cancer"]
tumors = tumors[tumors != "Hydatidiform_mole"]
i = 0 

cancer_type_PTVtsg = lapply(X = tumors, FUN = function(x){
  i = i + 1
  .GlobalEnv$i = i
  temp_can = subset(cancer_data, cancer_type == x)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can$PTVtsg_group = as.character(temp_can$PTVtsg_group)
  l = sort(unique(temp_can$PTVtsg_group))
  cp = unique(sort(unlist(sapply(X = l, FUN = function(y)  sapply(X = strsplit(y, ",")[[1]], FUN = function(x) as.numeric(str_extract(x, "\\d+")))))))
  temp_can$PTVtsg_group = cut(temp_can$PTVtsg, breaks = cp, include.lowest = T, right = T)
  temp_can %<>% 
  mutate(time_in_days = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$cancer_type[is.na(temp_can$cancer_type)] = "No cancer"
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  #temp_can$PTVtsg_group = factor(temp_can$PTVtsg_group, ordered = T)
  gender_counts = table(temp_can$gender)
  if (length(gender_counts) == 2 & all(gender_counts >= 10)) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTVtsg_group + gender, data = subset(temp_can, gender == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", x, " (Male)\n(N=", sum(temp_can$gender == "male"), ")"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fit_f = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTVtsg_group + gender, data = subset(temp_can, gender == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", x, " (Female)\n(N=", sum(temp_can$gender == "female"), ")"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, pfit_m$plot, tbl_f, tbl_m, layout_matrix = rbind(c(1, 1, 2, 2), c(1,1, 2, 2), c(3, 3, 4, 4)))
  } else if ("male" %in% names(gender_counts) && gender_counts["male"] >= 10) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTVtsg_group, data = subset(temp_can, gender == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", x, " (Male)\n(N=", sum(temp_can$gender == "male"), ")"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fig = grid.arrange(pfit_m$plot, tbl_m, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else if ("female" %in% names(gender_counts) && gender_counts["female"] >= 10){
    fit_f = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTVtsg_group, data = subset(temp_can, gender == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", x, " (Female)\n(N=", sum(temp_can$gender == "female"), ")"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, tbl_f, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else {
  message("Not enough data for either gender.")}
})


ggarrange(plotlist =  cancer_type_PTVtsg, ncol = 6, nrow = 5)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/PTV_cancer_surv/PTVtsg_cancer_cat_survplot.png", width = 100, height = 50, units = "cm", dpi = 300)

```

##Forest plot hist
```{r}
cancer_data$hist_tumor_cat[is.na(cancer_data$hist_tumor_cat)] = "No_cancer"
hist_cat = unique(cancer_data$hist_tumor_cat)
hist_cat = hist_cat[hist_cat != "No_cancer"]

i = 0
PTVtsg_forest_surv = lapply(X = hist_cat, FUN = function(x){
  i = i + 1
  .GlobalEnv$i = i
  temp_can = subset(cancer_data, hist_tumor_cat == x)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can %<>% 
  mutate(time_in_days = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$hist_tumor_cat[is.na(temp_can$hist_tumor_cat)] = "No cancer"
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  temp_can %<>% add_count(gender, name = "n_gender") %>% filter(n_gender >= 5)
  temp_can$gender = factor(temp_can$gender)
  l = temp_can %>% 
    add_count(ethnic_group, name = "freq") %>% 
    filter(freq > nrow(temp_can)/25) %>% 
    arrange(desc(freq)) %>% 
    pull(ethnic_group) %>% 
    unique()
  temp_can$ethnic_group = factor(temp_can$ethnic_group, levels = c("British", sort(setdiff(l, "British"))))
  temp_can %<>% 
    select(gender, ethnic_group, PTVtsg, gpca1, gpca2, gpca3, gpca4, gpca5, gpca6, gpca7, gpca8, gpca9, gpca10, time_in_days,event_indicator) %>% 
    na.omit()
  if (length(l) == 1 & length(unique(temp_can$gender)) == 1){
    hr_model = coxph(Surv(time_in_days, event_indicator) ~ PTVtsg + gpca1 + gpca2 + gpca3 + gpca4 + gpca5 + gpca6 + gpca7 + gpca8 + gpca9 + gpca10, data = temp_can)
  } else if(length(l) == 1 & length(unique(temp_can$gender)) == 2){
    hr_model = coxph(Surv(time_in_days, event_indicator) ~ PTVtsg + gender + gpca1 + gpca2 + gpca3 + gpca4 + gpca5 + gpca6 + gpca7 + gpca8 + gpca9 + gpca10, data = temp_can)
  } else if(length(l) > 1 & length(unique(temp_can$gender)) == 1){
    hr_model = coxph(Surv(time_in_days, event_indicator) ~ PTVtsg + ethnic_group + gpca1 + gpca2 + gpca3 + gpca4 + gpca5 + gpca6 + gpca7 + gpca8 + gpca9 + gpca10, data = temp_can)
  } else {
    hr_model = coxph(Surv(time_in_days, event_indicator) ~ PTVtsg + gender + ethnic_group + gpca1 + gpca2 + gpca3 + gpca4 + gpca5 + gpca6 + gpca7 + gpca8 + gpca9 + gpca10, data = temp_can)
  }
  ggforest(hr_model, data = as.data.frame(temp_can), main = paste0("Hazard ratio of ", x, "(PTVtsg)"), refLabel = "reference", noDigits = 2)
})

PTVtsg_surv_cox_forest = ggarrange(plotlist = PTVtsg_forest_surv, ncol = 3, nrow = 2)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/PTVtsg_forest_surv_hist.png", plot = PTVtsg_surv_cox_forest, width = 70, height = 60, units = "cm", limitsize = F, dpi = 300)

```

##Forest plot cancer
```{r}

cancer_data$cancer_type[is.na(cancer_data$cancer_type)] = "No_cancer"
tumors = unique(cancer_data$cancer_type)
tumors = tumors[tumors != "No_cancer"]
tumors = tumors[tumors != "Hydatidiform_mole"]

i = 0
PTVtsg_tumor_surv_forest_plot = lapply(X = tumors, FUN = function(x){
  i = i + 1
  .GlobalEnv$i = i
  temp_can = subset(cancer_data, cancer_type == x)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can %<>% 
  mutate(time_in_days = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$cancer_type[is.na(temp_can$cancer_type)] = "No cancer"
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  temp_can %<>% add_count(gender, name = "n_gender") %>% filter(n_gender >= 5)
  temp_can$gender = factor(temp_can$gender)
  l = temp_can %>% 
    add_count(ethnic_group, name = "freq") %>% 
    filter(freq > nrow(temp_can)/25) %>% 
    arrange(desc(freq)) %>% 
    pull(ethnic_group) %>% 
    unique()
  temp_can$ethnic_group = factor(temp_can$ethnic_group, levels = c("British", sort(setdiff(l, "British"))))
  temp_can %<>% 
    select(gender, ethnic_group, PTVtsg, gpca1, gpca2, gpca3, gpca4, gpca5, gpca6, gpca7, gpca8, gpca9, gpca10, time_in_days,event_indicator) %>% 
    na.omit()
  if (length(l) == 1 & length(unique(temp_can$gender)) == 1){
    hr_model = coxph(Surv(time_in_days, event_indicator) ~ PTVtsg + gpca1 + gpca2 + gpca3 + gpca4 + gpca5 + gpca6 + gpca7 + gpca8 + gpca9 + gpca10, data = temp_can)
  } else if(length(l) == 1 & length(unique(temp_can$gender)) == 2){
    hr_model = coxph(Surv(time_in_days, event_indicator) ~ PTVtsg + gender + gpca1 + gpca2 + gpca3 + gpca4 + gpca5 + gpca6 + gpca7 + gpca8 + gpca9 + gpca10, data = temp_can)
  } else if(length(l) > 1 & length(unique(temp_can$gender)) == 1){
    hr_model = coxph(Surv(time_in_days, event_indicator) ~ PTVtsg + ethnic_group + gpca1 + gpca2 + gpca3 + gpca4 + gpca5 + gpca6 + gpca7 + gpca8 + gpca9 + gpca10, data = temp_can)
  } else {
    hr_model = coxph(Surv(time_in_days, event_indicator) ~ PTVtsg + gender + ethnic_group + gpca1 + gpca2 + gpca3 + gpca4 + gpca5 + gpca6 + gpca7 + gpca8 + gpca9 + gpca10, data = temp_can)
  }
  ggforest(hr_model, data = as.data.frame(temp_can), main = paste0("Hazard ratio of ", x, "(PTVtsg)"), refLabel = "reference")
})

PTVtsg_surv_cox_forest = ggarrange(plotlist = PTVtsg_tumor_surv_forest_plot, ncol = 6, nrow = 5)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/PTVtsg_forest_surv.png", plot = PTVtsg_surv_cox_forest, width = 150, height = 80, units = "cm", limitsize = F, dpi = 300)

```

#PTVpli surv analysis
##Hist type
```{r}

cancer_data$gender = ifelse(cancer_data$sex == 0, "female", "male")
cancer_data$hist_tumor_cat[is.na(cancer_data$hist_tumor_cat)] = "No_cancer"
hist_cat = unique(cancer_data$hist_tumor_cat)
hist_cat = hist_cat[hist_cat != "No_cancer"]

hist_type_PTVpli = lapply(X = hist_cat, FUN = function(x){
  temp_can = subset(cancer_data, hist_tumor_cat == x)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can$PTVpli_group = as.character(temp_can$PTVpli_group)
  l = sort(unique(temp_can$PTVpli_group))
  cp = unique(sort(unlist(sapply(X = l, FUN = function(y)  sapply(X = strsplit(y, ",")[[1]], FUN = function(x) as.numeric(str_extract(x, "\\d+")))))))
  temp_can$PTVpli_group = cut(temp_can$PTVpli, breaks = cp, include.lowest = T, right = T)
  temp_can %<>% 
  mutate(time_in_days = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$hist_tumor_cat[is.na(temp_can$hist_tumor_cat)] = "No cancer"
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  #temp_can$PTVpli_group = factor(temp_can$PTVpli_group, ordered = T)
  gender_counts = table(temp_can$gender)
  if (length(gender_counts) == 2 & all(gender_counts >= 10)) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTVpli_group + gender, data = subset(temp_can, gender == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", x, " (Male)\n(N=", sum(temp_can$gender == "male"), ")"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fit_f = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTVpli_group + gender, data = subset(temp_can, gender == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", x, " (Female)\n(N=", sum(temp_can$gender == "female"), ")"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, pfit_m$plot, tbl_f, tbl_m, layout_matrix = rbind(c(1, 1, 2, 2), c(1,1, 2, 2), c(3, 3, 4, 4)))
  } else if ("male" %in% names(gender_counts) && gender_counts["male"] >= 10) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTVpli_group, data = subset(temp_can, gender == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", x, " (Male)\n(N=", sum(temp_can$gender == "male"), ")"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fig = grid.arrange(pfit_m$plot, tbl_m, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else if ("female" %in% names(gender_counts) && gender_counts["female"] >= 10){ 
    fit_f = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTVpli_group, data = subset(temp_can, gender == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", x, " (Female)\n(N=", sum(temp_can$gender == "female"), ")"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, tbl_f, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else {
  message("Not enough data for either gender.")}
  })


ggarrange(plotlist =  hist_type_PTVpli, ncol = 3, nrow = 2)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/PTV_cancer_surv/PTVpli_hist_cat_survplot.png", width = 100, height = 50, units = "cm", dpi = 300, limitsize = F)

```

##Cancer type
```{r}

cancer_data$gender = ifelse(cancer_data$sex == 0, "female", "male")
cancer_data$cancer_type[is.na(cancer_data$cancer_type)] = "No_cancer"
tumors = unique(cancer_data$cancer_type)
tumors = tumors[tumors != "No_cancer"]
tumors = tumors[tumors != "Hydatidiform_mole"]
i = 0 

cancer_type_PTVpli = lapply(X = tumors, FUN = function(x){
  i = i + 1
  .GlobalEnv$i = i
  temp_can = subset(cancer_data, cancer_type == x)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can$PTVpli_group = as.character(temp_can$PTVpli_group)
  l = sort(unique(temp_can$PTVpli_group))
  cp = unique(sort(unlist(sapply(X = l, FUN = function(y)  sapply(X = strsplit(y, ",")[[1]], FUN = function(x) as.numeric(str_extract(x, "\\d+")))))))
  temp_can$PTVpli_group = cut(temp_can$PTVpli, breaks = cp, include.lowest = T, right = T)
  temp_can %<>% 
  mutate(time_in_days = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$cancer_type[is.na(temp_can$cancer_type)] = "No cancer"
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  #temp_can$PTVpli_group = factor(temp_can$PTVpli_group, ordered = T)
  gender_counts = table(temp_can$gender)
  if (length(gender_counts) == 2 & all(gender_counts >= 10)) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTVpli_group + gender, data = subset(temp_can, gender == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", x, " (Male)\n(N=", sum(temp_can$gender == "male"), ")"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fit_f = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTVpli_group + gender, data = subset(temp_can, gender == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", x, " (Female)\n(N=", sum(temp_can$gender == "female"), ")"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, pfit_m$plot, tbl_f, tbl_m, layout_matrix = rbind(c(1, 1, 2, 2), c(1,1, 2, 2), c(3, 3, 4, 4)))
  } else if ("male" %in% names(gender_counts) && gender_counts["male"] >= 10) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTVpli_group, data = subset(temp_can, gender == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", x, " (Male)\n(N=", sum(temp_can$gender == "male"), ")"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fig = grid.arrange(pfit_m$plot, tbl_m, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else if ("female" %in% names(gender_counts) && gender_counts["female"] >= 10){
    fit_f = do.call(survfit, list(formula = Surv(time_in_days, event = event_indicator) ~ PTVpli_group, data = subset(temp_can, gender == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", x, " (Female)\n(N=", sum(temp_can$gender == "female"), ")"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, tbl_f, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else {
  message("Not enough data for either gender.")}
})


ggarrange(plotlist =  cancer_type_PTVpli, ncol = 6, nrow = 5)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/PTV_cancer_surv/PTVpli_cancer_cat_survplot.png", width = 100, height = 50, units = "cm", dpi = 300)

```

##Forest plot hist
```{r}

cancer_data$hist_tumor_cat[is.na(cancer_data$hist_tumor_cat)] = "No_cancer"
hist_cat = unique(cancer_data$hist_tumor_cat)
hist_cat = hist_cat[hist_cat != "No_cancer"]

i = 0
PTVpli_forest_surv = lapply(X = hist_cat, FUN = function(x){
  i = i + 1
  .GlobalEnv$i = i
  temp_can = subset(cancer_data, hist_tumor_cat == x)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can %<>% 
  mutate(time_in_days = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$hist_tumor_cat[is.na(temp_can$hist_tumor_cat)] = "No cancer"
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  temp_can %<>% add_count(gender, name = "n_gender") %>% filter(n_gender >= 5)
  temp_can$gender = factor(temp_can$gender)
  l = temp_can %>% 
    add_count(ethnic_group, name = "freq") %>% 
    filter(freq > nrow(temp_can)/25) %>% 
    arrange(desc(freq)) %>% 
    pull(ethnic_group) %>% 
    unique()
  temp_can$ethnic_group = factor(temp_can$ethnic_group, levels = c("British", sort(setdiff(l, "British"))))
  temp_can %<>% 
    select(gender, ethnic_group, PTVpli, gpca1, gpca2, gpca3, gpca4, gpca5, gpca6, gpca7, gpca8, gpca9, gpca10, time_in_days,event_indicator) %>% 
    na.omit()
  if (length(l) == 1 & length(unique(temp_can$gender)) == 1){
    hr_model = coxph(Surv(time_in_days, event_indicator) ~ PTVpli + gpca1 + gpca2 + gpca3 + gpca4 + gpca5 + gpca6 + gpca7 + gpca8 + gpca9 + gpca10, data = temp_can)
  } else if(length(l) == 1 & length(unique(temp_can$gender)) == 2){
    hr_model = coxph(Surv(time_in_days, event_indicator) ~ PTVpli + gender + gpca1 + gpca2 + gpca3 + gpca4 + gpca5 + gpca6 + gpca7 + gpca8 + gpca9 + gpca10, data = temp_can)
  } else if(length(l) > 1 & length(unique(temp_can$gender)) == 1){
    hr_model = coxph(Surv(time_in_days, event_indicator) ~ PTVpli + ethnic_group + gpca1 + gpca2 + gpca3 + gpca4 + gpca5 + gpca6 + gpca7 + gpca8 + gpca9 + gpca10, data = temp_can)
  } else {
    hr_model = coxph(Surv(time_in_days, event_indicator) ~ PTVpli + gender + ethnic_group + gpca1 + gpca2 + gpca3 + gpca4 + gpca5 + gpca6 + gpca7 + gpca8 + gpca9 + gpca10, data = temp_can)
  }
  ggforest(hr_model, data = as.data.frame(temp_can), main = paste0("Hazard ratio of ", x, "(PTVpli)"), refLabel = "reference", noDigits = 2)
})

PTVpli_surv_cox_forest = ggarrange(plotlist = PTVpli_forest_surv, ncol = 3, nrow = 2)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/PTVpli_forest_surv_hist.png", plot = PTVpli_surv_cox_forest, width = 70, height = 60, units = "cm", limitsize = F, dpi = 300)

```

##Forest plot cancer
```{r}

cancer_data$cancer_type[is.na(cancer_data$cancer_type)] = "No_cancer"
tumors = unique(cancer_data$cancer_type)
tumors = tumors[tumors != "No_cancer"]
tumors = tumors[tumors != "Hydatidiform_mole"]

i = 0
PTVpli_tumor_surv_forest_plot = lapply(X = tumors, FUN = function(x){
  i = i + 1
  .GlobalEnv$i = i
  temp_can = subset(cancer_data, cancer_type == x)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can %<>% 
  mutate(time_in_days = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$cancer_type[is.na(temp_can$cancer_type)] = "No cancer"
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  temp_can %<>% add_count(gender, name = "n_gender") %>% filter(n_gender >= 5)
  temp_can$gender = factor(temp_can$gender)
  l = temp_can %>% 
    add_count(ethnic_group, name = "freq") %>% 
    filter(freq > nrow(temp_can)/25) %>% 
    arrange(desc(freq)) %>% 
    pull(ethnic_group) %>% 
    unique()
  temp_can$ethnic_group = factor(temp_can$ethnic_group, levels = c("British", sort(setdiff(l, "British"))))
  temp_can %<>% 
    select(gender, ethnic_group, PTVpli, gpca1, gpca2, gpca3, gpca4, gpca5, gpca6, gpca7, gpca8, gpca9, gpca10, time_in_days,event_indicator) %>% 
    na.omit()
  if (length(l) == 1 & length(unique(temp_can$gender)) == 1){
    hr_model = coxph(Surv(time_in_days, event_indicator) ~ PTVpli + gpca1 + gpca2 + gpca3 + gpca4 + gpca5 + gpca6 + gpca7 + gpca8 + gpca9 + gpca10, data = temp_can)
  } else if(length(l) == 1 & length(unique(temp_can$gender)) == 2){
    hr_model = coxph(Surv(time_in_days, event_indicator) ~ PTVpli + gender + gpca1 + gpca2 + gpca3 + gpca4 + gpca5 + gpca6 + gpca7 + gpca8 + gpca9 + gpca10, data = temp_can)
  } else if(length(l) > 1 & length(unique(temp_can$gender)) == 1){
    hr_model = coxph(Surv(time_in_days, event_indicator) ~ PTVpli + ethnic_group + gpca1 + gpca2 + gpca3 + gpca4 + gpca5 + gpca6 + gpca7 + gpca8 + gpca9 + gpca10, data = temp_can)
  } else {
    hr_model = coxph(Surv(time_in_days, event_indicator) ~ PTVpli + gender + ethnic_group + gpca1 + gpca2 + gpca3 + gpca4 + gpca5 + gpca6 + gpca7 + gpca8 + gpca9 + gpca10, data = temp_can)
  }
  ggforest(hr_model, data = as.data.frame(temp_can), main = paste0("Hazard ratio of ", x, "(PTVpli)"), refLabel = "reference")
})

PTVpli_surv_cox_forest = ggarrange(plotlist = PTVpli_tumor_surv_forest_plot, ncol = 6, nrow = 5)
ggsave(filename = "C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/PTVpli_forest_surv.png", plot = PTVpli_surv_cox_forest, width = 150, height = 80, units = "cm", limitsize = F, dpi = 300)

```

#PTV surv
##MAF90
```{r}
#Load file
ukb_data = readRDS("objects/ukb_data.rds")
ukb_data$cancer_type[ukb_data$cancer_type == "Brain/CNS"] = "Brain"
ukb_data$cancer_type[ukb_data$cancer_type == "Hodgkin lymphoma"] = "HodgkinLymphoma"
ukb_data$cancer_type[ukb_data$cancer_type == "Multiple myeloma"] = "MultipleMyeloma"
ukb_data$cancer_type[ukb_data$cancer_type == "Non-Hodgkin lymphoma"] = "NonHodgkinLymphoma"
ukb_data$sex = factor(ukb_data$sex, levels = c(0,1), labels = c("female", "male"))

#Make table
surv_table = ukb_data %>% select(eid, birthdate, sex, ethnic_group, attending_1,diag_date, date_of_death, death, cancer_type, PTV_MAF, PTV_MAF_g90)
rm(ukb_data)
surv_table$cancer_type[is.na(surv_table$cancer_type)] = "No_cancer"
surv_table$gender = ifelse(surv_table$sex == 0, "female", "male")
tumors_all = unique(surv_table$cancer_type)
tumors_uni = tumors_all[!(tumors_all %in% c("No_cancer", "Hydatidiform_mole", "Testis", "Prostate", "Cervix", "Endometrium", "Ovary", "undef", "other", "Benign"))]
tumors_uni = sort(tumors_uni)
tumor_gen = sort(c("Cervix", "Endometrium", "Ovary", "Testis", "Prostate"))
tumor_undef = c("Benign", "other", "undef")
tumors = c(tumors_uni, tumor_gen, tumor_undef)
rm(tumors_uni, tumors_all, tumor_gen, tumor_undef)

x = 0

maf_90 = lapply(X = tumors, FUN = function(i){
  x = x + 1
  .GlobalEnv$x = x
  temp_can = subset(surv_table, cancer_type == i)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can %<>% 
  mutate(time_in_years = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$time_in_years = round(as.numeric(temp_can$time_in_years/365.25))
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  sex_counts = table(temp_can$sex)
  if (length(sex_counts) == 2 & all(sex_counts >= 10)) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTV_MAF_g90, data = subset(temp_can, sex == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", i, " (Male)\n(N=", sum(temp_can$sex == "male"), ")", "\n(90% cutoff MAF)"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fit_f = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTV_MAF_g90, data = subset(temp_can, sex == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", i, " (Female)\n(N=", sum(temp_can$sex == "female"), ")", "\n(90% cutoff MAF)"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, pfit_m$plot, tbl_f, tbl_m, layout_matrix = rbind(c(1, 1, 2, 2), c(1,1, 2, 2), c(3, 3, 4, 4)))
  } else if ("male" %in% names(sex_counts) && sex_counts["male"] >= 10) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTV_MAF_g90, data = subset(temp_can, sex == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", i, " (Male)\n(N=", sum(temp_can$sex == "male"), ")", "\n(90% cutoff MAF)"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fig = grid.arrange(pfit_m$plot, tbl_m, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else if ("female" %in% names(sex_counts) && sex_counts["female"] >= 10){
    fit_f = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTV_MAF_g90, data = subset(temp_can, sex == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", i, " (Female)\n(N=", sum(temp_can$sex == "female"), ")", "\n(90% cutoff MAF)"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, tbl_f, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else {
    message("Not enough data for either sex.")}
})

#Save as PDF
pdf("C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/MAF_PTV/PTV_MAF90_surv.pdf", height = 10, width = 16)
for (plot in maf_90) {
  if (!is.null(plot)) {
    grid.newpage() 
    grid.draw(plot)
  }
}
dev.off()


```

##MAF95
```{r}

#Load file
ukb_data = readRDS("objects/ukb_data.rds")
ukb_data$cancer_type[ukb_data$cancer_type == "Brain/CNS"] = "Brain"
ukb_data$cancer_type[ukb_data$cancer_type == "Hodgkin lymphoma"] = "HodgkinLymphoma"
ukb_data$cancer_type[ukb_data$cancer_type == "Multiple myeloma"] = "MultipleMyeloma"
ukb_data$cancer_type[ukb_data$cancer_type == "Non-Hodgkin lymphoma"] = "NonHodgkinLymphoma"
ukb_data$sex = factor(ukb_data$sex, levels = c(0,1), labels = c("female", "male"))

#Make table
surv_table = ukb_data %>% select(eid, birthdate, sex, ethnic_group, attending_1,diag_date, date_of_death, death, cancer_type, PTV_MAF, PTV_MAF_g95)
rm(ukb_data)
surv_table$cancer_type[is.na(surv_table$cancer_type)] = "No_cancer"
tumors_all = unique(surv_table$cancer_type)
tumors_uni = tumors_all[!(tumors_all %in% c("No_cancer", "Hydatidiform_mole", "Testis", "Prostate", "Cervix", "Endometrium", "Ovary", "undef", "other", "Benign"))]
tumors_uni = sort(tumors_uni)
tumor_gen = sort(c("Cervix", "Endometrium", "Ovary", "Testis", "Prostate"))
tumor_undef = c("Benign", "other", "undef")
tumors = c(tumors_uni, tumor_gen, tumor_undef)
rm(tumors_uni, tumors_all, tumor_gen, tumor_undef)

x = 0

maf_95 = lapply(X = tumors, FUN = function(i){
  x = x + 1
  .GlobalEnv$x = x
  temp_can = subset(surv_table, cancer_type == i)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can$PTV_MAF_g95 = as.character(temp_can$PTV_MAF_g95)
  #l = sort(unique(temp_can$PTV_MAF_g95))
  #cp = unique(sort(unlist(sapply(X = l, FUN = function(y)  sapply(X = strsplit(y, ",")[[1]], FUN = function(x) as.numeric(str_extract(x, "\\d+")))))))
  #temp_can$PTV_MAF_g95 = cut(temp_can$PTV_burden, breaks = cp, include.lowest = T, right = T)
  temp_can %<>% 
  mutate(time_in_years = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$time_in_years = round(as.numeric(temp_can$time_in_years/365.25))
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  sex_counts = table(temp_can$sex)
  if (length(sex_counts) == 2 & all(sex_counts >= 10)) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTV_MAF_g95, data = subset(temp_can, sex == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", i, " (Male)\n(N=", sum(temp_can$sex == "male"), ")", "\n(95% cutoff MAF)"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fit_f = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTV_MAF_g95, data = subset(temp_can, sex == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", i, " (Female)\n(N=", sum(temp_can$sex == "female"), ")", "\n(95% cutoff MAF)"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, pfit_m$plot, tbl_f, tbl_m, layout_matrix = rbind(c(1, 1, 2, 2), c(1,1, 2, 2), c(3, 3, 4, 4)))
  } else if ("male" %in% names(sex_counts) && sex_counts["male"] >= 10) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTV_MAF_g95, data = subset(temp_can, sex == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", i, " (Male)\n(N=", sum(temp_can$sex == "male"), ")", "\n(95% cutoff MAF)"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fig = grid.arrange(pfit_m$plot, tbl_m, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else if ("female" %in% names(sex_counts) && sex_counts["female"] >= 10){
    fit_f = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTV_MAF_g95, data = subset(temp_can, sex == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", i, " (Female)\n(N=", sum(temp_can$sex == "female"), ")", "\n(95% cutoff MAF)"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, tbl_f, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else {
    message("Not enough data for either sex.")}
})

#Save as PDF
pdf("C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/MAF_PTV/PTV_MAF_95.pdf", height = 10, width = 16)
for (plot in maf_95) {
  if (!is.null(plot)) {
    grid.newpage() 
    grid.draw(plot)
  }
}
dev.off()

```

##Raw 90
```{r}

#Load file
ukb_data = readRDS("objects/ukb_data.rds")
ukb_data$cancer_type[ukb_data$cancer_type == "Brain/CNS"] = "Brain"
ukb_data$cancer_type[ukb_data$cancer_type == "Hodgkin lymphoma"] = "HodgkinLymphoma"
ukb_data$cancer_type[ukb_data$cancer_type == "Multiple myeloma"] = "MultipleMyeloma"
ukb_data$cancer_type[ukb_data$cancer_type == "Non-Hodgkin lymphoma"] = "NonHodgkinLymphoma"
ukb_data$sex = factor(ukb_data$sex, levels = c(0,1), labels = c("female", "male"))

#Make table
surv_table = ukb_data %>% select(eid, birthdate, sex, ethnic_group, attending_1,diag_date, date_of_death, death, cancer_type, PTV, PTV_g90)
rm(ukb_data)
surv_table$cancer_type[is.na(surv_table$cancer_type)] = "No_cancer"
tumors_all = unique(surv_table$cancer_type)
tumors_uni = tumors_all[!(tumors_all %in% c("No_cancer", "Hydatidiform_mole", "Testis", "Prostate", "Cervix", "Endometrium", "Ovary", "undef", "other", "Benign"))]
tumors_uni = sort(tumors_uni)
tumor_gen = sort(c("Cervix", "Endometrium", "Ovary", "Testis", "Prostate"))
tumor_undef = c("Benign", "other", "undef")
tumors = c(tumors_uni, tumor_gen, tumor_undef)
rm(tumors_uni, tumors_all, tumor_gen, tumor_undef)

x = 0

raw_90 = lapply(X = tumors, FUN = function(i){
  x = x + 1
  .GlobalEnv$x = x
  temp_can = subset(surv_table, cancer_type == i)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can %<>% 
  mutate(time_in_years = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$time_in_years = round(as.numeric(temp_can$time_in_years/365.25))
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  sex_counts = table(temp_can$sex)
  if (length(sex_counts) == 2 & all(sex_counts >= 10)) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTV_g90, data = subset(temp_can, sex == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", i, " (Male)\n(N=", sum(temp_can$sex == "male"), ")", "\n(90% cutoff raw)"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fit_f = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTV_g90, data = subset(temp_can, sex == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", i, " (Female)\n(N=", sum(temp_can$sex == "female"), ")", "\n(90% cutoff raw)"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, pfit_m$plot, tbl_f, tbl_m, layout_matrix = rbind(c(1, 1, 2, 2), c(1,1, 2, 2), c(3, 3, 4, 4)))
  } else if ("male" %in% names(sex_counts) && sex_counts["male"] >= 10) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTV_g90, data = subset(temp_can, sex == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", i, " (Male)\n(N=", sum(temp_can$sex == "male"), ")", "\n(90% cutoff raw)"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fig = grid.arrange(pfit_m$plot, tbl_m, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else if ("female" %in% names(sex_counts) && sex_counts["female"] >= 10){
    fit_f = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTV_g90, data = subset(temp_can, sex == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", i, " (Female)\n(N=", sum(temp_can$sex == "female"), ")", "\n(90% cutoff raw)"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, tbl_f, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else {
    message("Not enough data for either sex.")}
})

#Save as PDF
pdf("C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/raw_PTV/PTV_raw90_surv.pdf", height = 10, width = 16)
for (plot in raw_90) {
  if (!is.null(plot)) {
    grid.newpage() 
    grid.draw(plot)
  }
}
dev.off()

```

##Raw 95
```{r}

#Load file
ukb_data = readRDS("objects/ukb_data.rds")
ukb_data$cancer_type[ukb_data$cancer_type == "Brain/CNS"] = "Brain"
ukb_data$cancer_type[ukb_data$cancer_type == "Hodgkin lymphoma"] = "HodgkinLymphoma"
ukb_data$cancer_type[ukb_data$cancer_type == "Multiple myeloma"] = "MultipleMyeloma"
ukb_data$cancer_type[ukb_data$cancer_type == "Non-Hodgkin lymphoma"] = "NonHodgkinLymphoma"
ukb_data$sex = factor(ukb_data$sex, levels = c(0,1), labels = c("female", "male"))

#Make table
surv_table = ukb_data %>% select(eid, birthdate, sex, ethnic_group, attending_1,diag_date, date_of_death, death, cancer_type, PTV, PTV_g95)
rm(ukb_data)
surv_table$cancer_type[is.na(surv_table$cancer_type)] = "No_cancer"
tumors_all = unique(surv_table$cancer_type)
tumors_uni = tumors_all[!(tumors_all %in% c("No_cancer", "Hydatidiform_mole", "Testis", "Prostate", "Cervix", "Endometrium", "Ovary", "undef", "other", "Benign"))]
tumors_uni = sort(tumors_uni)
tumor_gen = sort(c("Cervix", "Endometrium", "Ovary", "Testis", "Prostate"))
tumor_undef = c("Benign", "other", "undef")
tumors = c(tumors_uni, tumor_gen, tumor_undef)
rm(tumors_uni, tumors_all, tumor_gen, tumor_undef)

x = 0

raw_95 = lapply(X = tumors, FUN = function(i){
  x = x + 1
  .GlobalEnv$x = x
  temp_can = subset(surv_table, cancer_type == i)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can %<>% 
  mutate(time_in_years = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$time_in_years = round(as.numeric(temp_can$time_in_years/365.25))
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  sex_counts = table(temp_can$sex)
  if (length(sex_counts) == 2 & all(sex_counts >= 10)) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTV_g95, data = subset(temp_can, sex == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", i, " (Male)\n(N=", sum(temp_can$sex == "male"), ")", "\n(95% cutoff raw)"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fit_f = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTV_g95, data = subset(temp_can, sex == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", i, " (Female)\n(N=", sum(temp_can$sex == "female"), ")", "\n(95% cutoff raw)"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, pfit_m$plot, tbl_f, tbl_m, layout_matrix = rbind(c(1, 1, 2, 2), c(1,1, 2, 2), c(3, 3, 4, 4)))
  } else if ("male" %in% names(sex_counts) && sex_counts["male"] >= 10) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTV_g95, data = subset(temp_can, sex == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", i, " (Male)\n(N=", sum(temp_can$sex == "male"), ")", "\n(95% cutoff raw)"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fig = grid.arrange(pfit_m$plot, tbl_m, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else if ("female" %in% names(sex_counts) && sex_counts["female"] >= 10){
    fit_f = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTV_g95, data = subset(temp_can, sex == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", i, " (Female)\n(N=", sum(temp_can$sex == "female"), ")", "\n(95% cutoff raw)"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, tbl_f, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else {
    message("Not enough data for either sex.")}
})

#Save as PDF
pdf("C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/raw_PTV/PTV_raw95_surv.pdf", height = 10, width = 16)
for (plot in raw_95) {
  if (!is.null(plot)) {
    grid.newpage() 
    grid.draw(plot)
  }
}
dev.off()

```

##Tumor specific 1
```{r}

#Load file
load("C:/Users/bagil/Desktop/MyGit/ukb_tumor/objects/ukb_data_cancer_final")

#Make table
surv_table = ukb_data_cancer %>% select(eid, birthdate, sex, ethnic_group, attending_1,diag_date, date_of_death, death, cancer_type, PTV_burden, PTV_canctype_groups_1, gpca1:gpca20)
rm(ukb_data_cancer)
surv_table$cancer_type[is.na(surv_table$cancer_type)] = "No_cancer"
surv_table$gender = ifelse(surv_table$sex == 0, "female", "male")
tumors_all = unique(surv_table$cancer_type)
tumors_uni = tumors_all[!(tumors_all %in% c("No_cancer", "Hydatidiform_mole", "Testis", "Prostate", "Cervix", "Endometrium", "Ovary", "undef", "other", "Benign"))]
tumors_uni = sort(tumors_uni)
tumor_gen = sort(c("Cervix", "Endometrium", "Ovary", "Testis", "Prostate"))
tumor_undef = c("Benign", "other", "undef")
tumors = c(tumors_uni, tumor_gen, tumor_undef)
rm(tumors_uni, tumors_all, tumor_gen, tumor_undef)

x = 0

tumor_surv_PTVspec = lapply(X = tumors, FUN = function(i){
  x = x + 1
  .GlobalEnv$x = x
  temp_can = subset(surv_table, cancer_type == i)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can$PTV_canctype_groups_1 = as.character(temp_can$PTV_canctype_groups_1)
  l = sort(unique(temp_can$PTV_canctype_groups_1))
  cp = unique(sort(unlist(sapply(X = l, FUN = function(y)  sapply(X = strsplit(y, ",")[[1]], FUN = function(x) as.numeric(str_extract(x, "\\d+")))))))
  temp_can$PTV_canctype_groups_1 = cut(temp_can$PTV_burden, breaks = cp, include.lowest = T, right = T)
  temp_can %<>% 
  mutate(time_in_years = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$time_in_years = round(as.numeric(temp_can$time_in_years/365.25))
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  gender_counts = table(temp_can$gender)
  if (length(gender_counts) == 2 & all(gender_counts >= 10)) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTV_canctype_groups_1, data = subset(temp_can, gender == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", i, " (Male)\n(N=", sum(temp_can$gender == "male"), ")", "\n(90% cutoff)"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fit_f = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTV_canctype_groups_1, data = subset(temp_can, gender == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", i, " (Female)\n(N=", sum(temp_can$gender == "female"), ")", "\n(90% cutoff)"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, pfit_m$plot, tbl_f, tbl_m, layout_matrix = rbind(c(1, 1, 2, 2), c(1,1, 2, 2), c(3, 3, 4, 4)))
  } else if ("male" %in% names(gender_counts) && gender_counts["male"] >= 10) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTV_canctype_groups_1, data = subset(temp_can, gender == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", i, " (Male)\n(N=", sum(temp_can$gender == "male"), ")", "\n(90% cutoff)"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fig = grid.arrange(pfit_m$plot, tbl_m, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else if ("female" %in% names(gender_counts) && gender_counts["female"] >= 10){
    fit_f = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTV_canctype_groups_1, data = subset(temp_can, gender == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", i, " (Female)\n(N=", sum(temp_can$gender == "female"), ")", "\n(90% cutoff)"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, tbl_f, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else {
    message("Not enough data for either gender.")}
})

#Save as PDF
pdf("C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/PTV_cspec_surv_1.pdf", height = 10, width = 16)
for (plot in tumor_surv_PTVspec) {
  if (!is.null(plot)) {
    grid.newpage() 
    grid.draw(plot)
  }
}
dev.off()

```

##Tumorspecific 2
```{r}

#Load file
load("C:/Users/bagil/Desktop/MyGit/ukb_tumor/objects/ukb_data_cancer_final")

#Make table
surv_table = ukb_data_cancer %>% select(eid, birthdate, sex, ethnic_group, attending_1,diag_date, date_of_death, death, cancer_type, PTV_burden, PTV_canctype_groups_2, gpca1:gpca20)
rm(ukb_data_cancer)
surv_table$cancer_type[is.na(surv_table$cancer_type)] = "No_cancer"
surv_table$gender = ifelse(surv_table$sex == 0, "female", "male")
tumors_all = unique(surv_table$cancer_type)
tumors_uni = tumors_all[!(tumors_all %in% c("No_cancer", "Hydatidiform_mole", "Testis", "Prostate", "Cervix", "Endometrium", "Ovary", "undef", "other", "Benign"))]
tumors_uni = sort(tumors_uni)
tumor_gen = sort(c("Cervix", "Endometrium", "Ovary", "Testis", "Prostate"))
tumor_undef = c("Benign", "other", "undef")
tumors = c(tumors_uni, tumor_gen, tumor_undef)
rm(tumors_uni, tumors_all, tumor_gen, tumor_undef)

x = 0

tumor_surv_PTVspec = lapply(X = tumors, FUN = function(i){
  x = x + 1
  .GlobalEnv$x = x
  temp_can = subset(surv_table, cancer_type == i)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can$PTV_canctype_groups_2 = as.character(temp_can$PTV_canctype_groups_2)
  l = sort(unique(temp_can$PTV_canctype_groups_2))
  cp = unique(sort(unlist(sapply(X = l, FUN = function(y)  sapply(X = strsplit(y, ",")[[1]], FUN = function(x) as.numeric(str_extract(x, "\\d+")))))))
  temp_can$PTV_canctype_groups_2 = cut(temp_can$PTV_burden, breaks = cp, include.lowest = T, right = T)
  temp_can %<>% 
  mutate(time_in_years = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$time_in_years = round(as.numeric(temp_can$time_in_years/365.25))
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  gender_counts = table(temp_can$gender)
  if (length(gender_counts) == 2 & all(gender_counts >= 10)) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTV_canctype_groups_2, data = subset(temp_can, gender == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", i, " (Male)\n(N=", sum(temp_can$gender == "male"), ")", "\n(95% cutoff)"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fit_f = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTV_canctype_groups_2, data = subset(temp_can, gender == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", i, " (Female)\n(N=", sum(temp_can$gender == "female"), ")", "\n(95% cutoff)"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, pfit_m$plot, tbl_f, tbl_m, layout_matrix = rbind(c(1, 1, 2, 2), c(1,1, 2, 2), c(3, 3, 4, 4)))
  } else if ("male" %in% names(gender_counts) && gender_counts["male"] >= 10) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTV_canctype_groups_2, data = subset(temp_can, gender == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", i, " (Male)\n(N=", sum(temp_can$gender == "male"), ")", "\n(95% cutoff)"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fig = grid.arrange(pfit_m$plot, tbl_m, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else if ("female" %in% names(gender_counts) && gender_counts["female"] >= 10){
    fit_f = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTV_canctype_groups_2, data = subset(temp_can, gender == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", i, " (Female)\n(N=", sum(temp_can$gender == "female"), ")", "\n(95% cutoff)"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, tbl_f, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else {
    message("Not enough data for either gender.")}
})

#Save as PDF
pdf("C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/PTV_cspec_surv_2.pdf", height = 10, width = 16)
for (plot in tumor_surv_PTVspec) {
  if (!is.null(plot)) {
    grid.newpage() 
    grid.draw(plot)
  }
}
dev.off()

```

##PTVim MAF
```{r}

#Loads
ukb_data = readRDS("objects/ukb_data.rds")
ukb_data$cancer_type[ukb_data$cancer_type == "Brain/CNS"] = "Brain"
ukb_data$cancer_type[ukb_data$cancer_type == "Hodgkin lymphoma"] = "HodgkinLymphoma"
ukb_data$cancer_type[ukb_data$cancer_type == "Multiple myeloma"] = "MultipleMyeloma"
ukb_data$cancer_type[ukb_data$cancer_type == "Non-Hodgkin lymphoma"] = "NonHodgkinLymphoma"
ukb_data$sex = factor(ukb_data$sex, levels = c(0,1), labels = c("female", "male"))

#Make table
surv_table = ukb_data %>% select(eid, birthdate, sex, ethnic_group, attending_1,diag_date, date_of_death, death, cancer_type, PTV_MAF, PTVim_MAF_g)
rm(ukb_data)
surv_table$cancer_type[is.na(surv_table$cancer_type)] = "No_cancer"
tumors_all = unique(surv_table$cancer_type)
tumors_uni = tumors_all[!(tumors_all %in% c("No_cancer", "Hydatidiform_mole", "Testis", "Prostate", "Cervix", "Endometrium", "Ovary", "undef", "other", "Benign"))]
tumors_uni = sort(tumors_uni)
tumor_gen = sort(c("Cervix", "Endometrium", "Ovary", "Testis", "Prostate"))
tumor_undef = c("Benign", "other", "undef")
tumors = c(tumors_uni, tumor_gen, tumor_undef)
rm(tumors_uni, tumors_all, tumor_gen, tumor_undef)

x = 0

ptvim_maf = lapply(X = tumors, FUN = function(i){
  x = x + 1
  .GlobalEnv$x = x
  temp_can = subset(surv_table, cancer_type == i)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can %<>% 
  mutate(time_in_years = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$time_in_years = round(as.numeric(temp_can$time_in_years/365.25))
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  sex_counts = table(temp_can$sex)
  if (length(sex_counts) == 2 & all(sex_counts >= 10)) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTVim_MAF_g, data = subset(temp_can, sex == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", i, " (Male)\n(N=", sum(temp_can$sex == "male"), ")", "\n(90% cutoff MAF)"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fit_f = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTVim_MAF_g, data = subset(temp_can, sex == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", i, " (Female)\n(N=", sum(temp_can$sex == "female"), ")", "\n(90% cutoff MAF)"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, pfit_m$plot, tbl_f, tbl_m, layout_matrix = rbind(c(1, 1, 2, 2), c(1,1, 2, 2), c(3, 3, 4, 4)))
  } else if ("male" %in% names(sex_counts) && sex_counts["male"] >= 10) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTVim_MAF_g, data = subset(temp_can, sex == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", i, " (Male)\n(N=", sum(temp_can$sex == "male"), ")", "\n(90% cutoff MAF)"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fig = grid.arrange(pfit_m$plot, tbl_m, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else if ("female" %in% names(sex_counts) && sex_counts["female"] >= 10){
    fit_f = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTVim_MAF_g, data = subset(temp_can, sex == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", i, " (Female)\n(N=", sum(temp_can$sex == "female"), ")", "\n(90% cutoff MAF)"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, tbl_f, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else {
    message("Not enough data for either sex.")}
})

#Save as PDF
pdf("C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/MAF_PTV/PTVim_MAF.pdf", height = 10, width = 16)
for (plot in ptvim_maf) {
  if (!is.null(plot)) {
    grid.newpage() 
    grid.draw(plot)
  }
}
dev.off()

```


##PTVim raw 90
```{r}

#Load file
ukb_data = readRDS("objects/ukb_data.rds")
ukb_data$cancer_type[ukb_data$cancer_type == "Brain/CNS"] = "Brain"
ukb_data$cancer_type[ukb_data$cancer_type == "Hodgkin lymphoma"] = "HodgkinLymphoma"
ukb_data$cancer_type[ukb_data$cancer_type == "Multiple myeloma"] = "MultipleMyeloma"
ukb_data$cancer_type[ukb_data$cancer_type == "Non-Hodgkin lymphoma"] = "NonHodgkinLymphoma"
ukb_data$sex = factor(ukb_data$sex, levels = c(0,1), labels = c("female", "male"))

#Make table
surv_table = ukb_data %>% select(eid, birthdate, sex, ethnic_group, attending_1,diag_date, date_of_death, death, cancer_type, PTVim, PTVim_g90)
rm(ukb_data)
surv_table$cancer_type[is.na(surv_table$cancer_type)] = "No_cancer"
tumors_all = unique(surv_table$cancer_type)
tumors_uni = tumors_all[!(tumors_all %in% c("No_cancer", "Hydatidiform_mole", "Testis", "Prostate", "Cervix", "Endometrium", "Ovary", "undef", "other", "Benign"))]
tumors_uni = sort(tumors_uni)
tumor_gen = sort(c("Cervix", "Endometrium", "Ovary", "Testis", "Prostate"))
tumor_undef = c("Benign", "other", "undef")
tumors = c(tumors_uni, tumor_gen, tumor_undef)
rm(tumors_uni, tumors_all, tumor_gen, tumor_undef)

x = 0

ptvim_raw90 = lapply(X = tumors, FUN = function(i){
  x = x + 1
  .GlobalEnv$x = x
  temp_can = subset(surv_table, cancer_type == i)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can %<>% 
  mutate(time_in_years = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$time_in_years = round(as.numeric(temp_can$time_in_years/365.25))
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  sex_counts = table(temp_can$sex)
  if (length(sex_counts) == 2 & all(sex_counts >= 10)) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTVim_g90, data = subset(temp_can, sex == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", i, " (Male)\n(N=", sum(temp_can$sex == "male"), ")", "\n(90% cutoff raw)"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fit_f = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTVim_g90, data = subset(temp_can, sex == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", i, " (Female)\n(N=", sum(temp_can$sex == "female"), ")", "\n(90% cutoff raw)"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, pfit_m$plot, tbl_f, tbl_m, layout_matrix = rbind(c(1, 1, 2, 2), c(1,1, 2, 2), c(3, 3, 4, 4)))
  } else if ("male" %in% names(sex_counts) && sex_counts["male"] >= 10) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTVim_g90, data = subset(temp_can, sex == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", i, " (Male)\n(N=", sum(temp_can$sex == "male"), ")", "\n(90% cutoff raw)"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fig = grid.arrange(pfit_m$plot, tbl_m, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else if ("female" %in% names(sex_counts) && sex_counts["female"] >= 10){
    fit_f = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTVim_g90, data = subset(temp_can, sex == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", i, " (Female)\n(N=", sum(temp_can$sex == "female"), ")", "\n(90% cutoff raw)"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, tbl_f, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else {
    message("Not enough data for either sex.")}
})

#Save as PDF
pdf("C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/raw_PTV/PTVim_raw90.pdf", height = 10, width = 16)
for (plot in ptvim_raw90) {
  if (!is.null(plot)) {
    grid.newpage() 
    grid.draw(plot)
  }
}
dev.off()

```

##PTVim raw 95
```{r}

#Load file
ukb_data = readRDS("objects/ukb_data.rds")
ukb_data$cancer_type[ukb_data$cancer_type == "Brain/CNS"] = "Brain"
ukb_data$cancer_type[ukb_data$cancer_type == "Hodgkin lymphoma"] = "HodgkinLymphoma"
ukb_data$cancer_type[ukb_data$cancer_type == "Multiple myeloma"] = "MultipleMyeloma"
ukb_data$cancer_type[ukb_data$cancer_type == "Non-Hodgkin lymphoma"] = "NonHodgkinLymphoma"
ukb_data$sex = factor(ukb_data$sex, levels = c(0,1), labels = c("female", "male"))

#Make table
surv_table = ukb_data %>% select(eid, birthdate, sex, ethnic_group, attending_1,diag_date, date_of_death, death, cancer_type, PTVim, PTVim_g95)
rm(ukb_data)
surv_table$cancer_type[is.na(surv_table$cancer_type)] = "No_cancer"
tumors_all = unique(surv_table$cancer_type)
tumors_uni = tumors_all[!(tumors_all %in% c("No_cancer", "Hydatidiform_mole", "Testis", "Prostate", "Cervix", "Endometrium", "Ovary", "undef", "other", "Benign"))]
tumors_uni = sort(tumors_uni)
tumor_gen = sort(c("Cervix", "Endometrium", "Ovary", "Testis", "Prostate"))
tumor_undef = c("Benign", "other", "undef")
tumors = c(tumors_uni, tumor_gen, tumor_undef)
rm(tumors_uni, tumors_all, tumor_gen, tumor_undef)

x = 0

ptvim_raw95 = lapply(X = tumors, FUN = function(i){
  x = x + 1
  .GlobalEnv$x = x
  temp_can = subset(surv_table, cancer_type == i)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can %<>% 
  mutate(time_in_years = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$time_in_years = round(as.numeric(temp_can$time_in_years/365.25))
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  sex_counts = table(temp_can$sex)
  if (length(sex_counts) == 2 & all(sex_counts >= 10)) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTVim_g95, data = subset(temp_can, sex == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", i, " (Male)\n(N=", sum(temp_can$sex == "male"), ")", "\n(95% cutoff raw)"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fit_f = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTVim_g95, data = subset(temp_can, sex == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", i, " (Female)\n(N=", sum(temp_can$sex == "female"), ")", "\n(95% cutoff raw)"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, pfit_m$plot, tbl_f, tbl_m, layout_matrix = rbind(c(1, 1, 2, 2), c(1,1, 2, 2), c(3, 3, 4, 4)))
  } else if ("male" %in% names(sex_counts) && sex_counts["male"] >= 10) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTVim_g95, data = subset(temp_can, sex == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", i, " (Male)\n(N=", sum(temp_can$sex == "male"), ")", "\n(95% cutoff raw)"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fig = grid.arrange(pfit_m$plot, tbl_m, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else if ("female" %in% names(sex_counts) && sex_counts["female"] >= 10){
    fit_f = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTVim_g95, data = subset(temp_can, sex == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", i, " (Female)\n(N=", sum(temp_can$sex == "female"), ")", "\n(95% cutoff raw)"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, tbl_f, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else {
    message("Not enough data for either sex.")}
})

#Save as PDF
pdf("C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/raw_PTV/PTVim_raw95.pdf", height = 10, width = 16)
for (plot in ptvim_raw95) {
  if (!is.null(plot)) {
    grid.newpage() 
    grid.draw(plot)
  }
}
dev.off()

```

##PTVpli MAF
```{r}
#Loads
ukb_data = readRDS("objects/ukb_data.rds")
ukb_data$cancer_type[ukb_data$cancer_type == "Brain/CNS"] = "Brain"
ukb_data$cancer_type[ukb_data$cancer_type == "Hodgkin lymphoma"] = "HodgkinLymphoma"
ukb_data$cancer_type[ukb_data$cancer_type == "Multiple myeloma"] = "MultipleMyeloma"
ukb_data$cancer_type[ukb_data$cancer_type == "Non-Hodgkin lymphoma"] = "NonHodgkinLymphoma"
ukb_data$sex = factor(ukb_data$sex, levels = c(0,1), labels = c("female", "male"))

#Make table
surv_table = ukb_data %>% select(eid, birthdate, sex, ethnic_group, attending_1,diag_date, date_of_death, death, cancer_type, PTVpli_MAF, PTVpli_MAF_g)
rm(ukb_data)
surv_table$cancer_type[is.na(surv_table$cancer_type)] = "No_cancer"
tumors_all = unique(surv_table$cancer_type)
tumors_uni = tumors_all[!(tumors_all %in% c("No_cancer", "Hydatidiform_mole", "Testis", "Prostate", "Cervix", "Endometrium", "Ovary", "undef", "other", "Benign"))]
tumors_uni = sort(tumors_uni)
tumor_gen = sort(c("Cervix", "Endometrium", "Ovary", "Testis", "Prostate"))
tumor_undef = c("Benign", "other", "undef")
tumors = c(tumors_uni, tumor_gen, tumor_undef)
rm(tumors_uni, tumors_all, tumor_gen, tumor_undef)

x = 0

ptvpli_maf = lapply(X = tumors, FUN = function(i){
  x = x + 1
  .GlobalEnv$x = x
  temp_can = subset(surv_table, cancer_type == i)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can %<>% 
  mutate(time_in_years = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$time_in_years = round(as.numeric(temp_can$time_in_years/365.25))
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  sex_counts = table(temp_can$sex)
  if (length(sex_counts) == 2 & all(sex_counts >= 10)) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTVpli_MAF_g, data = subset(temp_can, sex == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", i, " (Male)\n(N=", sum(temp_can$sex == "male"), ")", "\n(MAF)"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fit_f = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTVpli_MAF_g, data = subset(temp_can, sex == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", i, " (Female)\n(N=", sum(temp_can$sex == "female"), ")",  "\n(MAF)"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, pfit_m$plot, tbl_f, tbl_m, layout_matrix = rbind(c(1, 1, 2, 2), c(1,1, 2, 2), c(3, 3, 4, 4)))
  } else if ("male" %in% names(sex_counts) && sex_counts["male"] >= 10) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTVpli_MAF_g, data = subset(temp_can, sex == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", i, " (Male)\n(N=", sum(temp_can$sex == "male"), ")",  "\n(MAF)"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fig = grid.arrange(pfit_m$plot, tbl_m, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else if ("female" %in% names(sex_counts) && sex_counts["female"] >= 10){
    fit_f = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTVpli_MAF_g, data = subset(temp_can, sex == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", i, " (Female)\n(N=", sum(temp_can$sex == "female"), ")",  "\n(MAF)"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, tbl_f, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else {
    message("Not enough data for either sex.")}
})

#Save as PDF
pdf("C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/MAF_PTV/PTVpli_MAF_surv.pdf", height = 10, width = 16)
for (plot in ptvpli_maf) {
  if (!is.null(plot)) {
    grid.newpage() 
    grid.draw(plot)
  }
}
dev.off()

```


##PTVpli raw90
```{r}

#Loads
ukb_data = readRDS("objects/ukb_data.rds")
ukb_data$cancer_type[ukb_data$cancer_type == "Brain/CNS"] = "Brain"
ukb_data$cancer_type[ukb_data$cancer_type == "Hodgkin lymphoma"] = "HodgkinLymphoma"
ukb_data$cancer_type[ukb_data$cancer_type == "Multiple myeloma"] = "MultipleMyeloma"
ukb_data$cancer_type[ukb_data$cancer_type == "Non-Hodgkin lymphoma"] = "NonHodgkinLymphoma"
ukb_data$sex = factor(ukb_data$sex, levels = c(0,1), labels = c("female", "male"))

#Make table
surv_table = ukb_data %>% select(eid, birthdate, sex, ethnic_group, attending_1,diag_date, date_of_death, death, cancer_type, PTVpli, PTVpli_g90)
rm(ukb_data)
surv_table$cancer_type[is.na(surv_table$cancer_type)] = "No_cancer"
tumors_all = unique(surv_table$cancer_type)
tumors_uni = tumors_all[!(tumors_all %in% c("No_cancer", "Hydatidiform_mole", "Testis", "Prostate", "Cervix", "Endometrium", "Ovary", "undef", "other", "Benign"))]
tumors_uni = sort(tumors_uni)
tumor_gen = sort(c("Cervix", "Endometrium", "Ovary", "Testis", "Prostate"))
tumor_undef = c("Benign", "other", "undef")
tumors = c(tumors_uni, tumor_gen, tumor_undef)
rm(tumors_uni, tumors_all, tumor_gen, tumor_undef)

x = 0


ptvpli_raw90 = lapply(X = tumors, FUN = function(i){
  x = x + 1
  .GlobalEnv$x = x
  temp_can = subset(surv_table, cancer_type == i)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can %<>% 
  mutate(time_in_years = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$time_in_years = round(as.numeric(temp_can$time_in_years/365.25))
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  sex_counts = table(temp_can$sex)
  if (length(sex_counts) == 2 & all(sex_counts >= 10)) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTVpli_g90, data = subset(temp_can, sex == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", i, " (Male)\n(N=", sum(temp_can$sex == "male"), ")", "\n(90% cutoff raw)"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fit_f = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTVpli_g90, data = subset(temp_can, sex == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", i, " (Female)\n(N=", sum(temp_can$sex == "female"), ")",  "\n(90% cutoff raw)"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, pfit_m$plot, tbl_f, tbl_m, layout_matrix = rbind(c(1, 1, 2, 2), c(1,1, 2, 2), c(3, 3, 4, 4)))
  } else if ("male" %in% names(sex_counts) && sex_counts["male"] >= 10) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTVpli_g90, data = subset(temp_can, sex == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", i, " (Male)\n(N=", sum(temp_can$sex == "male"), ")",  "\n(90% cutoff raw)"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fig = grid.arrange(pfit_m$plot, tbl_m, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else if ("female" %in% names(sex_counts) && sex_counts["female"] >= 10){
    fit_f = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTVpli_g90, data = subset(temp_can, sex == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", i, " (Female)\n(N=", sum(temp_can$sex == "female"), ")",  "\n(90% cutoff raw)"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, tbl_f, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else {
    message("Not enough data for either sex.")}
})

#Save as PDF
pdf("C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/raw_PTV/PTVpli_raw90.pdf", height = 10, width = 16)
for (plot in ptvpli_raw90) {
  if (!is.null(plot)) {
    grid.newpage() 
    grid.draw(plot)
  }
}
dev.off()

```

##PTVpli 2
```{r}

#Load file
load("C:/Users/bagil/Desktop/MyGit/ukb_tumor/objects/ukb_data_cancer_final")

#Make table
surv_table = ukb_data_cancer %>% select(eid, birthdate, sex, ethnic_group, attending_1, diag_date, date_of_death, death, cancer_type, PTV_burden, PTVpli_group_2, gpca1:gpca20)
rm(ukb_data_cancer)
surv_table$cancer_type[is.na(surv_table$cancer_type)] = "No_cancer"
surv_table$gender = ifelse(surv_table$sex == 0, "female", "male")
tumors_all = unique(surv_table$cancer_type)
tumors_uni = tumors_all[!(tumors_all %in% c("No_cancer", "Hydatidiform_mole", "Testis", "Prostate", "Cervix", "Endometrium", "Ovary", "undef", "other", "Benign"))]
tumors_uni = sort(tumors_uni)
tumor_gen = sort(c("Cervix", "Endometrium", "Ovary", "Testis", "Prostate"))
tumor_undef = c("Benign", "other", "undef")
tumors = c(tumors_uni, tumor_gen, tumor_undef)
rm(tumors_uni, tumors_all, tumor_gen, tumor_undef)

x = 0

tumor_surv_PTVpli = lapply(X = tumors, FUN = function(i){
  x = x + 1
  .GlobalEnv$x = x
  temp_can = subset(surv_table, cancer_type == i)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can$PTVpli_group_2 = as.character(temp_can$PTVpli_group_2)
  #l = sort(unique(temp_can$PTV_uni_groups_2))
  #cp = unique(sort(unlist(sapply(X = l, FUN = function(y)  sapply(X = strsplit(y, ",")[[1]], FUN = function(x) as.numeric(str_extract(x, "\\d+")))))))
  #temp_can$PTV_uni_groups_2 = cut(temp_can$PTV_burden, breaks = cp, include.lowest = T, right = T)
  temp_can %<>% 
  mutate(time_in_years = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$time_in_years = round(as.numeric(temp_can$time_in_years/365.25))
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  gender_counts = table(temp_can$gender)
  if (length(gender_counts) == 2 & all(gender_counts >= 10)) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTVpli_group_2, data = subset(temp_can, gender == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", i, " (Male)\n(N=", sum(temp_can$gender == "male"), ")", "\n(95% cutoff)"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fit_f = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTVpli_group_2, data = subset(temp_can, gender == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", i, " (Female)\n(N=", sum(temp_can$gender == "female"), ")",  "\n(95% cutoff)"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, pfit_m$plot, tbl_f, tbl_m, layout_matrix = rbind(c(1, 1, 2, 2), c(1,1, 2, 2), c(3, 3, 4, 4)))
  } else if ("male" %in% names(gender_counts) && gender_counts["male"] >= 10) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTVpli_group_2, data = subset(temp_can, gender == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", i, " (Male)\n(N=", sum(temp_can$gender == "male"), ")", "\n(95% cutoff)"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fig = grid.arrange(pfit_m$plot, tbl_m, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else if ("female" %in% names(gender_counts) && gender_counts["female"] >= 10){
    fit_f = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTVpli_group_2, data = subset(temp_can, gender == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", i, " (Female)\n(N=", sum(temp_can$gender == "female"), ")",  "\n(95% cutoff)"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, tbl_f, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else {
    message("Not enough data for either gender.")}
})

#Save as PDF
pdf("C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/PTVpli_surv_2.pdf", height = 10, width = 16)
for (plot in tumor_surv_PTVpli) {
  if (!is.null(plot)) {
    grid.newpage() 
    grid.draw(plot)
  }
}
dev.off()

```

##PTVtsg MAF
```{r}

#Loads
ukb_data = readRDS("objects/ukb_data.rds")
ukb_data$cancer_type[ukb_data$cancer_type == "Brain/CNS"] = "Brain"
ukb_data$cancer_type[ukb_data$cancer_type == "Hodgkin lymphoma"] = "HodgkinLymphoma"
ukb_data$cancer_type[ukb_data$cancer_type == "Multiple myeloma"] = "MultipleMyeloma"
ukb_data$cancer_type[ukb_data$cancer_type == "Non-Hodgkin lymphoma"] = "NonHodgkinLymphoma"
ukb_data$sex = factor(ukb_data$sex, levels = c(0,1), labels = c("female", "male"))

#Make table
surv_table = ukb_data %>% select(eid, birthdate, sex, ethnic_group, attending_1,diag_date, date_of_death, death, cancer_type, PTVtsg_MAF, PTVtsg_MAF_g)
rm(ukb_data)
surv_table$cancer_type[is.na(surv_table$cancer_type)] = "No_cancer"
tumors_all = unique(surv_table$cancer_type)
tumors_uni = tumors_all[!(tumors_all %in% c("No_cancer", "Hydatidiform_mole", "Testis", "Prostate", "Cervix", "Endometrium", "Ovary", "undef", "other", "Benign"))]
tumors_uni = sort(tumors_uni)
tumor_gen = sort(c("Cervix", "Endometrium", "Ovary", "Testis", "Prostate"))
tumor_undef = c("Benign", "other", "undef")
tumors = c(tumors_uni, tumor_gen, tumor_undef)
rm(tumors_uni, tumors_all, tumor_gen, tumor_undef)

x = 0

ptvtsg_maf = lapply(X = tumors, FUN = function(i){
  x = x + 1
  .GlobalEnv$x = x
  temp_can = subset(surv_table, cancer_type == i)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can %<>% 
  mutate(time_in_years = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$time_in_years = round(as.numeric(temp_can$time_in_years/365.25))
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  sex_counts = table(temp_can$sex)
  if (length(sex_counts) == 2 & all(sex_counts >= 10)) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTVtsg_MAF_g, data = subset(temp_can, sex == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", i, " (Male)\n(N=", sum(temp_can$sex == "male"), ")", "\n(MAF)"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fit_f = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTVtsg_MAF_g, data = subset(temp_can, sex == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", i, " (Female)\n(N=", sum(temp_can$sex == "female"), ")",  "\n(MAF)"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, pfit_m$plot, tbl_f, tbl_m, layout_matrix = rbind(c(1, 1, 2, 2), c(1,1, 2, 2), c(3, 3, 4, 4)))
  } else if ("male" %in% names(sex_counts) && sex_counts["male"] >= 10) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTVtsg_MAF_g, data = subset(temp_can, sex == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", i, " (Male)\n(N=", sum(temp_can$sex == "male"), ")",  "\n(MAF)"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fig = grid.arrange(pfit_m$plot, tbl_m, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else if ("female" %in% names(sex_counts) && sex_counts["female"] >= 10){
    fit_f = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTVtsg_MAF_g, data = subset(temp_can, sex == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", i, " (Female)\n(N=", sum(temp_can$sex == "female"), ")",  "\n(MAF)"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, tbl_f, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else {
    message("Not enough data for either sex.")}
})

#Save as PDF
pdf("C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/MAF_PTV/PTVtsg_MAF_surv.pdf", height = 10, width = 16)
for (plot in ptvtsg_maf) {
  if (!is.null(plot)) {
    grid.newpage() 
    grid.draw(plot)
  }
}
dev.off()

```


##PTtsg raw 90
```{r}
#Load file
ukb_data = readRDS("objects/ukb_data.rds")
ukb_data$cancer_type[ukb_data$cancer_type == "Brain/CNS"] = "Brain"
ukb_data$cancer_type[ukb_data$cancer_type == "Hodgkin lymphoma"] = "HodgkinLymphoma"
ukb_data$cancer_type[ukb_data$cancer_type == "Multiple myeloma"] = "MultipleMyeloma"
ukb_data$cancer_type[ukb_data$cancer_type == "Non-Hodgkin lymphoma"] = "NonHodgkinLymphoma"
ukb_data$sex = factor(ukb_data$sex, levels = c(0,1), labels = c("female", "male"))

#Make table
surv_table = ukb_data %>% select(eid, birthdate, sex, ethnic_group, attending_1, diag_date, date_of_death, death, cancer_type, PTVtsg, PTVtsg_g90)
rm(ukb_data)
surv_table$cancer_type[is.na(surv_table$cancer_type)] = "No_cancer"
surv_table$gender = ifelse(surv_table$sex == 0, "female", "male")
tumors_all = unique(surv_table$cancer_type)
tumors_uni = tumors_all[!(tumors_all %in% c("No_cancer", "Hydatidiform_mole", "Testis", "Prostate", "Cervix", "Endometrium", "Ovary", "undef", "other", "Benign"))]
tumors_uni = sort(tumors_uni)
tumor_gen = sort(c("Cervix", "Endometrium", "Ovary", "Testis", "Prostate"))
tumor_undef = c("Benign", "other", "undef")
tumors = c(tumors_uni, tumor_gen, tumor_undef)
rm(tumors_uni, tumors_all, tumor_gen, tumor_undef)

x = 0

ptvtsg_raw90 = lapply(X = tumors, FUN = function(i){
  x = x + 1
  .GlobalEnv$x = x
  temp_can = subset(surv_table, cancer_type == i)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can %<>% 
  mutate(time_in_years = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$time_in_years = round(as.numeric(temp_can$time_in_years/365.25))
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  sex_counts = table(temp_can$sex)
  if (length(sex_counts) == 2 & all(sex_counts >= 10)) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTVtsg_g90, data = subset(temp_can, sex == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", i, " (Male)\n(N=", sum(temp_can$sex == "male"), ")", "\n(90% cutoff raw)"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fit_f = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTVtsg_g90, data = subset(temp_can, sex == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", i, " (Female)\n(N=", sum(temp_can$sex == "female"), ")",  "\n(90% cutoff raw)"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, pfit_m$plot, tbl_f, tbl_m, layout_matrix = rbind(c(1, 1, 2, 2), c(1,1, 2, 2), c(3, 3, 4, 4)))
  } else if ("male" %in% names(sex_counts) && sex_counts["male"] >= 10) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTVtsg_g90, data = subset(temp_can, sex == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", i, " (Male)\n(N=", sum(temp_can$sex == "male"), ")", "\n(90% cutoff raw)"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fig = grid.arrange(pfit_m$plot, tbl_m, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else if ("female" %in% names(sex_counts) && sex_counts["female"] >= 10){
    fit_f = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTVtsg_g90, data = subset(temp_can, sex == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", i, " (Female)\n(N=", sum(temp_can$sex == "female"), ")",  "\n(90% cutoff raw)"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, tbl_f, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else {
    message("Not enough data for either sex.")}
})

#Save as PDF
pdf("C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/raw_PTV/PTVtsg_raw90.pdf", height = 10, width = 16)
for (plot in ptvtsg_raw90) {
  if (!is.null(plot)) {
    grid.newpage() 
    grid.draw(plot)
  }
}
dev.off()

```

##PTVtsg raw 95
```{r}

#Load file
ukb_data = readRDS("objects/ukb_data.rds")
ukb_data$cancer_type[ukb_data$cancer_type == "Brain/CNS"] = "Brain"
ukb_data$cancer_type[ukb_data$cancer_type == "Hodgkin lymphoma"] = "HodgkinLymphoma"
ukb_data$cancer_type[ukb_data$cancer_type == "Multiple myeloma"] = "MultipleMyeloma"
ukb_data$cancer_type[ukb_data$cancer_type == "Non-Hodgkin lymphoma"] = "NonHodgkinLymphoma"
ukb_data$sex = factor(ukb_data$sex, levels = c(0,1), labels = c("female", "male"))

#Make table
surv_table = ukb_data %>% select(eid, birthdate, sex, ethnic_group, attending_1, diag_date, date_of_death, death, cancer_type, PTVtsg, PTVtsg_g95)
rm(ukb_data)
surv_table$cancer_type[is.na(surv_table$cancer_type)] = "No_cancer"
surv_table$gender = ifelse(surv_table$sex == 0, "female", "male")
tumors_all = unique(surv_table$cancer_type)
tumors_uni = tumors_all[!(tumors_all %in% c("No_cancer", "Hydatidiform_mole", "Testis", "Prostate", "Cervix", "Endometrium", "Ovary", "undef", "other", "Benign"))]
tumors_uni = sort(tumors_uni)
tumor_gen = sort(c("Cervix", "Endometrium", "Ovary", "Testis", "Prostate"))
tumor_undef = c("Benign", "other", "undef")
tumors = c(tumors_uni, tumor_gen, tumor_undef)
rm(tumors_uni, tumors_all, tumor_gen, tumor_undef)

x = 0

ptvtsg_raw95 = lapply(X = tumors, FUN = function(i){
  x = x + 1
  .GlobalEnv$x = x
  temp_can = subset(surv_table, cancer_type == i)
  temp_can = temp_can[!duplicated(temp_can$eid), ]
  temp_can %<>% 
  mutate(time_in_years = case_when(
      death == T ~ date_of_death - diag_date,
      death == F ~ max(date_of_death, na.rm = T) - diag_date
    ))
  temp_can$time_in_years = round(as.numeric(temp_can$time_in_years/365.25))
  temp_can$event_indicator = ifelse(temp_can$death == T, 1, 0)
  sex_counts = table(temp_can$sex)
  if (length(sex_counts) == 2 & all(sex_counts >= 10)) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTVtsg_g95, data = subset(temp_can, sex == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", i, " (Male)\n(N=", sum(temp_can$sex == "male"), ")", "\n(95% cutoff raw)"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fit_f = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTVtsg_g95, data = subset(temp_can, sex == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", i, " (Female)\n(N=", sum(temp_can$sex == "female"), ")",  "\n(95% cutoff raw)"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, pfit_m$plot, tbl_f, tbl_m, layout_matrix = rbind(c(1, 1, 2, 2), c(1,1, 2, 2), c(3, 3, 4, 4)))
  } else if ("male" %in% names(sex_counts) && sex_counts["male"] >= 10) {
    fit_m = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTVtsg_g95, data = subset(temp_can, sex == "male")))
    args_m = list(fit = fit_m, title = paste0("Survival Analysis for ", i, " (Male)\n(N=", sum(temp_can$sex == "male"), ")", "\n(95% cutoff raw)"), pval = TRUE, legend = "none")
    pfit_m = do.call(ggsurvplot, args_m)
    tbl_m = ggsurvplot(fit_m, risk.table = TRUE)$table
    fig = grid.arrange(pfit_m$plot, tbl_m, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else if ("female" %in% names(sex_counts) && sex_counts["female"] >= 10){
    fit_f = do.call(survfit, list(formula = Surv(time_in_years, event = event_indicator) ~ PTVtsg_g95, data = subset(temp_can, sex == "female")))
    args_f = list(fit = fit_f, title = paste0("Survival Analysis for ", i, " (Female)\n(N=", sum(temp_can$sex == "female"), ")",  "\n(95% cutoff raw)"), pval = TRUE, legend = "none")
    pfit_f = do.call(ggsurvplot, args_f)
    tbl_f = ggsurvplot(fit_f, risk.table = TRUE)$table
    fig = grid.arrange(pfit_f$plot, tbl_f, layout_matrix = rbind(c(1, 1), c(1, 1), c(2, 2)))
  } else {
    message("Not enough data for either sex.")}
})

#Save as PDF
pdf("C:/Users/bagil/Desktop/MyGit/ukb_tumor/plots/Survival/raw_PTV/PTVtsg_raw95.pdf", height = 10, width = 16)
for (plot in ptvtsg_raw95) {
  if (!is.null(plot)) {
    grid.newpage() 
    grid.draw(plot)
  }
}
dev.off()

```

